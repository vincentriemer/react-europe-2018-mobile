Object.defineProperty(exports,"__esModule",{value:true});var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _RCTAnimationDriver=require("./RCTAnimationDriver");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var MAX_DELTA_TIME=0.064;var RCTSpringAnimation=function(){function RCTSpringAnimation(animationId,config,valueNode,callback){(0,_classCallCheck3.default)(this,RCTSpringAnimation);var iterations=config.iterations!=null?config.iterations:1;this.animationId=animationId;this.toValue=config.toValue;this.fromValue=valueNode.value;this.lastPosition=0;this.valueNode=valueNode;this.overshootClamping=config.overshootClamping;this.restDisplacementThreshold=config.restDisplacementThreshold;this.restSpeedThreshold=config.restSpeedThreshold;this.stiffness=config.stiffness;this.damping=config.damping;this.mass=config.mass;this.initialVelocity=config.initialVelocity;this.callback=callback;this.lastPosition=this.fromValue;this.lastVelocity=this.initialVelocity;this.animationHasFinished=iterations===0;this.iterations=iterations;this.currentLoop=1;return this;}(0,_createClass3.default)(RCTSpringAnimation,[{key:"startAnimation",value:function startAnimation(){this.animationStartTime=this.animationCurrentTime=-1;this.animationHasBegun=true;}},{key:"stopAnimation",value:function stopAnimation(){if(this.callback){this.callback({finished:this.animationHasFinished});}}},{key:"stepAnimationWithTime",value:function stepAnimationWithTime(currentTime){if(!this.animationHasBegun||this.animationHasFinished){return;}var deltaTime=void 0;if(this.animationStartTime===-1){this._t=0.0;this.animationStartTime=currentTime;deltaTime=0.0;}else{var curDeltaTime=(currentTime-this.animationCurrentTime)/1000;deltaTime=Math.min(MAX_DELTA_TIME,curDeltaTime);this._t+=deltaTime;}this.animationCurrentTime=currentTime;var c=this.damping;var m=this.mass;var k=this.stiffness;var v0=-this.initialVelocity;var zeta=c/(2*Math.sqrt(k*m));var omega0=Math.sqrt(k/m);var omega1=omega0*Math.sqrt(1.0-zeta*zeta);var x0=this.toValue-this.fromValue;var position=void 0;var velocity=void 0;if(zeta<1){var envelope=Math.exp(-zeta*omega0*this._t);position=this.toValue-envelope*((v0+zeta*omega0*x0)/omega1*Math.sin(omega1*this._t)+x0*Math.cos(omega1*this._t));velocity=zeta*omega0*envelope*(Math.sin(omega1*this._t)*(v0+zeta*omega0*x0)/omega1+x0*Math.cos(omega1*this._t))-envelope*(Math.cos(omega1*this._t)*(v0+zeta*omega0*x0)-omega1*x0*Math.sin(omega1*this._t));}else{var _envelope=Math.exp(-omega0*this._t);position=this.toValue-_envelope*(x0+(v0+omega0*x0)*this._t);velocity=_envelope*(v0*(this._t*omega0-1)+this._t*x0*(omega0*omega0));}this.lastPosition=position;this.lastVelocity=velocity;this.onUpdate(position);var isOvershooting=false;if(this.overshootClamping&&this.stiffness!==0){if(this.fromValue<this.toValue){isOvershooting=position>this.toValue;}else{isOvershooting=position<this.toValue;}}var isVelocity=Math.abs(velocity)<=this.restSpeedThreshold;var isDisplacement=true;if(this.stiffness!==0){isDisplacement=Math.abs(this.toValue-position)<=this.restDisplacementThreshold;}if(isOvershooting||isVelocity&&isDisplacement){if(this.stiffness!==0){if(this.animationHasFinished){return;}this.onUpdate(this.toValue);}if(this.iterations===-1||this.currentLoop<this.iterations){this.lastPosition=this.fromValue;this.lastVelocity=this.initialVelocity;this.animationStartTime=-1;this.currentLoop++;this.onUpdate(this.fromValue);}else{this.animationHasFinished=true;}}}},{key:"onUpdate",value:function onUpdate(outputValue){this.valueNode.value=outputValue;this.valueNode.setNeedsUpdate();}}]);return RCTSpringAnimation;}();exports.default=RCTSpringAnimation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL1JlYWN0RG9tL21vZHVsZXMvTmF0aXZlQW5pbWF0aW9uL0RyaXZlcnMvUkNUU3ByaW5nQW5pbWF0aW9uLmpzIl0sIm5hbWVzIjpbIk1BWF9ERUxUQV9USU1FIiwiUkNUU3ByaW5nQW5pbWF0aW9uIiwiYW5pbWF0aW9uSWQiLCJjb25maWciLCJ2YWx1ZU5vZGUiLCJjYWxsYmFjayIsIml0ZXJhdGlvbnMiLCJ0b1ZhbHVlIiwiZnJvbVZhbHVlIiwidmFsdWUiLCJsYXN0UG9zaXRpb24iLCJvdmVyc2hvb3RDbGFtcGluZyIsInJlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQiLCJyZXN0U3BlZWRUaHJlc2hvbGQiLCJzdGlmZm5lc3MiLCJkYW1waW5nIiwibWFzcyIsImluaXRpYWxWZWxvY2l0eSIsImxhc3RWZWxvY2l0eSIsImFuaW1hdGlvbkhhc0ZpbmlzaGVkIiwiY3VycmVudExvb3AiLCJhbmltYXRpb25TdGFydFRpbWUiLCJhbmltYXRpb25DdXJyZW50VGltZSIsImFuaW1hdGlvbkhhc0JlZ3VuIiwiZmluaXNoZWQiLCJjdXJyZW50VGltZSIsImRlbHRhVGltZSIsIl90IiwiY3VyRGVsdGFUaW1lIiwiTWF0aCIsIm1pbiIsImMiLCJtIiwiayIsInYwIiwiemV0YSIsInNxcnQiLCJvbWVnYTAiLCJvbWVnYTEiLCJ4MCIsInBvc2l0aW9uIiwidmVsb2NpdHkiLCJlbnZlbG9wZSIsImV4cCIsInNpbiIsImNvcyIsIm9uVXBkYXRlIiwiaXNPdmVyc2hvb3RpbmciLCJpc1ZlbG9jaXR5IiwiYWJzIiwiaXNEaXNwbGFjZW1lbnQiLCJvdXRwdXRWYWx1ZSIsInNldE5lZWRzVXBkYXRlIl0sIm1hcHBpbmdzIjoibVRBU0Esd0QsbUZBRUEsR0FBTUEsZ0JBQXlCLEtBQS9CLEMsR0FFTUMsbUIsWUEyQkosNEJBQ0VDLFdBREYsQ0FFRUMsTUFGRixDQUdFQyxTQUhGLENBSUVDLFFBSkYsQ0FLRSx1REFDQSxHQUFNQyxZQUFhSCxPQUFPRyxVQUFQLEVB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Q0QsQyxrREFHWW5ELGtCIiwiZmlsZSI6IlJDVFNwcmluZ0FuaW1hdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQHByb3ZpZGVzTW9kdWxlIFJDVFNwcmluZ0FuaW1hdGlvblxuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgdHlwZSB7IENvbmZpZyB9IGZyb20gXCJSQ1ROYXRpdmVBbmltYXRlZE1vZHVsZVwiO1xuaW1wb3J0IHR5cGUgeyBSQ1RBbmltYXRpb25Ecml2ZXIgfSBmcm9tIFwiUkNUQW5pbWF0aW9uRHJpdmVyXCI7XG5pbXBvcnQgdHlwZSBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSBmcm9tIFwiUkNUVmFsdWVBbmltYXRlZE5vZGVcIjtcblxuaW1wb3J0IHsgUkNUU2luZ2xlRnJhbWVJbnRlcnZhbCB9IGZyb20gXCJSQ1RBbmltYXRpb25Ecml2ZXJcIjtcblxuY29uc3QgTUFYX0RFTFRBX1RJTUU6IG51bWJlciA9IDAuMDY0O1xuXG5jbGFzcyBSQ1RTcHJpbmdBbmltYXRpb24gaW1wbGVtZW50cyBSQ1RBbmltYXRpb25Ecml2ZXIge1xuICBhbmltYXRpb25JZDogbnVtYmVyO1xuICB2YWx1ZU5vZGU6IFJDVFZhbHVlQW5pbWF0ZWROb2RlO1xuICBhbmltYXRpb25IYXNCZWd1bjogYm9vbGVhbjtcbiAgYW5pbWF0aW9uSGFzRmluaXNoZWQ6IGJvb2xlYW47XG5cbiAgdG9WYWx1ZTogbnVtYmVyO1xuICBmcm9tVmFsdWU6IG51bWJlcjtcbiAgb3ZlcnNob290Q2xhbXBpbmc6IGJvb2xlYW47XG4gIHJlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQ6IG51bWJlcjtcbiAgcmVzdFNwZWVkVGhyZXNob2xkOiBudW1iZXI7XG4gIHN0aWZmbmVzczogbnVtYmVyO1xuICBkYW1waW5nOiBudW1iZXI7XG4gIG1hc3M6IG51bWJlcjtcbiAgaW5pdGlhbFZlbG9jaXR5OiBudW1iZXI7XG4gIGFuaW1hdGlvblN0YXJ0VGltZTogbnVtYmVyO1xuICBhbmltYXRpb25DdXJyZW50VGltZTogbnVtYmVyO1xuICBjYWxsYmFjazogRnVuY3Rpb247XG5cbiAgbGFzdFBvc2l0aW9uOiBudW1iZXI7XG4gIGxhc3RWZWxvY2l0eTogbnVtYmVyO1xuXG4gIGl0ZXJhdGlvbnM6IG51bWJlcjtcbiAgY3VycmVudExvb3A6IG51bWJlcjtcblxuICBfdDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGFuaW1hdGlvbklkOiBudW1iZXIsXG4gICAgY29uZmlnOiBDb25maWcsXG4gICAgdmFsdWVOb2RlOiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSxcbiAgICBjYWxsYmFjazogRnVuY3Rpb25cbiAgKSB7XG4gICAgY29uc3QgaXRlcmF0aW9ucyA9IGNvbmZpZy5pdGVyYXRpb25zICE9IG51bGwgPyBjb25maWcuaXRlcmF0aW9ucyA6IDE7XG5cbiAgICB0aGlzLmFuaW1hdGlvbklkID0gYW5pbWF0aW9uSWQ7XG4gICAgdGhpcy50b1ZhbHVlID0gY29uZmlnLnRvVmFsdWU7XG4gICAgdGhpcy5mcm9tVmFsdWUgPSB2YWx1ZU5vZGUudmFsdWU7XG4gICAgdGhpcy5sYXN0UG9zaXRpb24gPSAwO1xuICAgIHRoaXMudmFsdWVOb2RlID0gdmFsdWVOb2RlO1xuICAgIHRoaXMub3ZlcnNob290Q2xhbXBpbmcgPSBjb25maWcub3ZlcnNob290Q2xhbXBpbmc7XG4gICAgdGhpcy5yZXN0RGlzcGxhY2VtZW50VGhyZXNob2xkID0gY29uZmlnLnJlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQ7XG4gICAgdGhpcy5yZXN0U3BlZWRUaHJlc2hvbGQgPSBjb25maWcucmVzdFNwZWVkVGhyZXNob2xkO1xuICAgIHRoaXMuc3RpZmZuZXNzID0gY29uZmlnLnN0aWZmbmVzcztcbiAgICB0aGlzLmRhbXBpbmcgPSBjb25maWcuZGFtcGluZztcbiAgICB0aGlzLm1hc3MgPSBjb25maWcubWFzcztcbiAgICB0aGlzLmluaXRpYWxWZWxvY2l0eSA9IGNvbmZpZy5pbml0aWFsVmVsb2NpdHk7XG4gICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrO1xuXG4gICAgdGhpcy5sYXN0UG9zaXRpb24gPSB0aGlzLmZyb21WYWx1ZTtcbiAgICB0aGlzLmxhc3RWZWxvY2l0eSA9IHRoaXMuaW5pdGlhbFZlbG9jaXR5O1xuXG4gICAgdGhpcy5hbmltYXRpb25IYXNGaW5pc2hlZCA9IGl0ZXJhdGlvbnMgPT09IDA7XG4gICAgdGhpcy5pdGVyYXRpb25zID0gaXRlcmF0aW9ucztcbiAgICB0aGlzLmN1cnJlbnRMb29wID0gMTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHN0YXJ0QW5pbWF0aW9uKCkge1xuICAgIHRoaXMuYW5pbWF0aW9uU3RhcnRUaW1lID0gdGhpcy5hbmltYXRpb25DdXJyZW50VGltZSA9IC0xO1xuICAgIHRoaXMuYW5pbWF0aW9uSGFzQmVndW4gPSB0cnVlO1xuICB9XG5cbiAgc3RvcEFuaW1hdGlvbigpIHtcbiAgICBpZiAodGhpcy5jYWxsYmFjaykge1xuICAgICAgdGhpcy5jYWxsYmFjayh7IGZpbmlzaGVkOiB0aGlzLmFuaW1hdGlvbkhhc0ZpbmlzaGVkIH0pO1xuICAgIH1cbiAgfVxuXG4gIHN0ZXBBbmltYXRpb25XaXRoVGltZShjdXJyZW50VGltZTogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLmFuaW1hdGlvbkhhc0JlZ3VuIHx8IHRoaXMuYW5pbWF0aW9uSGFzRmluaXNoZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZGVsdGFUaW1lO1xuICAgIGlmICh0aGlzLmFuaW1hdGlvblN0YXJ0VGltZSA9PT0gLTEpIHtcbiAgICAgIHRoaXMuX3QgPSAwLjA7XG4gICAgICB0aGlzLmFuaW1hdGlvblN0YXJ0VGltZSA9IGN1cnJlbnRUaW1lO1xuICAgICAgZGVsdGFUaW1lID0gMC4wO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBuZWVkIHRvIGFkanVzdCB0aGUgZGVsdGEgdGltZSB0byBiZSBpbiBzZWNvbmRzXG4gICAgICBjb25zdCBjdXJEZWx0YVRpbWUgPSAoY3VycmVudFRpbWUgLSB0aGlzLmFuaW1hdGlvbkN1cnJlbnRUaW1lKSAvIDEwMDA7XG4gICAgICAvLyBIYW5kbGUgZnJhbWUgZHJvcHMsIGFuZCBvbmx5IGFkdmFuY2UgZHQgYnkgYSBtYXggb2YgTUFYX0RFTFRBX1RJTUVcbiAgICAgIGRlbHRhVGltZSA9IE1hdGgubWluKE1BWF9ERUxUQV9USU1FLCBjdXJEZWx0YVRpbWUpO1xuICAgICAgdGhpcy5fdCArPSBkZWx0YVRpbWU7XG4gICAgfVxuXG4gICAgLy8gc3RvcmUgdGhlIHRpbWVzdGFtcFxuICAgIHRoaXMuYW5pbWF0aW9uQ3VycmVudFRpbWUgPSBjdXJyZW50VGltZTtcblxuICAgIGNvbnN0IGMgPSB0aGlzLmRhbXBpbmc7XG4gICAgY29uc3QgbSA9IHRoaXMubWFzcztcbiAgICBjb25zdCBrID0gdGhpcy5zdGlmZm5lc3M7XG4gICAgY29uc3QgdjAgPSAtdGhpcy5pbml0aWFsVmVsb2NpdHk7XG5cbiAgICBjb25zdCB6ZXRhID0gYyAvICgyICogTWF0aC5zcXJ0KGsgKiBtKSk7IC8vIGRhbXBpbmcgcmF0aW9cbiAgICBjb25zdCBvbWVnYTAgPSBNYXRoLnNxcnQoayAvIG0pOyAvLyB1bmRhbXBlZCBhbmd1bGFyIGZyZXF1ZW5jeSBvZiB0aGUgb3NjaWxsYXRvciAocmFkL21zKVxuICAgIGNvbnN0IG9tZWdhMSA9IG9tZWdhMCAqIE1hdGguc3FydCgxLjAgLSB6ZXRhICogemV0YSk7IC8vIGV4cG9uZW50aWFsIGRlY2F5XG4gICAgY29uc3QgeDAgPSB0aGlzLnRvVmFsdWUgLSB0aGlzLmZyb21WYWx1ZTsgLy8gY2FsY3VsYXRlIHRoZSBvc2NpbGxhdGlvbiBmcm9tIHgwID0gMSB0byB4ID0gMFxuXG4gICAgbGV0IHBvc2l0aW9uO1xuICAgIGxldCB2ZWxvY2l0eTtcblxuICAgIGlmICh6ZXRhIDwgMSkge1xuICAgICAgLy8gVW5kZXIgZGFtcGVkXG4gICAgICBjb25zdCBlbnZlbG9wZSA9IE1hdGguZXhwKC16ZXRhICogb21lZ2EwICogdGhpcy5fdCk7XG4gICAgICBwb3NpdGlvbiA9XG4gICAgICAgIHRoaXMudG9WYWx1ZSAtXG4gICAgICAgIGVudmVsb3BlICpcbiAgICAgICAgICAoKHYwICsgemV0YSAqIG9tZWdhMCAqIHgwKSAvIG9tZWdhMSAqIE1hdGguc2luKG9tZWdhMSAqIHRoaXMuX3QpICtcbiAgICAgICAgICAgIHgwICogTWF0aC5jb3Mob21lZ2ExICogdGhpcy5fdCkpO1xuICAgICAgLy8gVGhpcyBsb29rcyBjcmF6eSAtLSBpdCdzIGFjdHVhbGx5IGp1c3QgdGhlIGRlcml2YXRpdmUgb2YgdGhlXG4gICAgICAvLyBvc2NpbGxhdGlvbiBmdW5jdGlvblxuICAgICAgdmVsb2NpdHkgPVxuICAgICAgICB6ZXRhICpcbiAgICAgICAgICBvbWVnYTAgKlxuICAgICAgICAgIGVudmVsb3BlICpcbiAgICAgICAgICAoTWF0aC5zaW4ob21lZ2ExICogdGhpcy5fdCkgKiAodjAgKyB6ZXRhICogb21lZ2EwICogeDApIC8gb21lZ2ExICtcbiAgICAgICAgICAgIHgwICogTWF0aC5jb3Mob21lZ2ExICogdGhpcy5fdCkpIC1cbiAgICAgICAgZW52ZWxvcGUgKlxuICAgICAgICAgIChNYXRoLmNvcyhvbWVnYTEgKiB0aGlzLl90KSAqICh2MCArIHpldGEgKiBvbWVnYTAgKiB4MCkgLVxuICAgICAgICAgICAgb21lZ2ExICogeDAgKiBNYXRoLnNpbihvbWVnYTEgKiB0aGlzLl90KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIENyaXRpY2FsbHkgZGFtcGVkXG4gICAgICBjb25zdCBlbnZlbG9wZSA9IE1hdGguZXhwKC1vbWVnYTAgKiB0aGlzLl90KTtcbiAgICAgIHBvc2l0aW9uID0gdGhpcy50b1ZhbHVlIC0gZW52ZWxvcGUgKiAoeDAgKyAodjAgKyBvbWVnYTAgKiB4MCkgKiB0aGlzLl90KTtcbiAgICAgIHZlbG9jaXR5ID1cbiAgICAgICAgZW52ZWxvcGUgKlxuICAgICAgICAodjAgKiAodGhpcy5fdCAqIG9tZWdhMCAtIDEpICsgdGhpcy5fdCAqIHgwICogKG9tZWdhMCAqIG9tZWdhMCkpO1xuICAgIH1cblxuICAgIHRoaXMubGFzdFBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgdGhpcy5sYXN0VmVsb2NpdHkgPSB2ZWxvY2l0eTtcblxuICAgIHRoaXMub25VcGRhdGUocG9zaXRpb24pO1xuXG4gICAgLy8gQ29uZGl0aW9ucyBmb3Igc3RvcHBpbmcgdGhlIHNwcmluZyBhbmltYXRpb25cbiAgICBsZXQgaXNPdmVyc2hvb3RpbmcgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5vdmVyc2hvb3RDbGFtcGluZyAmJiB0aGlzLnN0aWZmbmVzcyAhPT0gMCkge1xuICAgICAgaWYgKHRoaXMuZnJvbVZhbHVlIDwgdGhpcy50b1ZhbHVlKSB7XG4gICAgICAgIGlzT3ZlcnNob290aW5nID0gcG9zaXRpb24gPiB0aGlzLnRvVmFsdWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpc092ZXJzaG9vdGluZyA9IHBvc2l0aW9uIDwgdGhpcy50b1ZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBpc1ZlbG9jaXR5ID0gTWF0aC5hYnModmVsb2NpdHkpIDw9IHRoaXMucmVzdFNwZWVkVGhyZXNob2xkO1xuICAgIGxldCBpc0Rpc3BsYWNlbWVudCA9IHRydWU7XG4gICAgaWYgKHRoaXMuc3RpZmZuZXNzICE9PSAwKSB7XG4gICAgICBpc0Rpc3BsYWNlbWVudCA9XG4gICAgICAgIE1hdGguYWJzKHRoaXMudG9WYWx1ZSAtIHBvc2l0aW9uKSA8PSB0aGlzLnJlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQ7XG4gICAgfVxuXG4gICAgaWYgKGlzT3ZlcnNob290aW5nIHx8IChpc1ZlbG9jaXR5ICYmIGlzRGlzcGxhY2VtZW50KSkge1xuICAgICAgaWYgKHRoaXMuc3RpZmZuZXNzICE9PSAwKSB7XG4gICAgICAgIC8vIEVuc3VyZSB0aGF0IHdlIGVuZCB1cCB3aXRoIGEgcm91bmQgdmFsdWVcbiAgICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uSGFzRmluaXNoZWQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vblVwZGF0ZSh0aGlzLnRvVmFsdWUpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5pdGVyYXRpb25zID09PSAtMSB8fCB0aGlzLmN1cnJlbnRMb29wIDwgdGhpcy5pdGVyYXRpb25zKSB7XG4gICAgICAgIHRoaXMubGFzdFBvc2l0aW9uID0gdGhpcy5mcm9tVmFsdWU7XG4gICAgICAgIHRoaXMubGFzdFZlbG9jaXR5ID0gdGhpcy5pbml0aWFsVmVsb2NpdHk7XG4gICAgICAgIHRoaXMuYW5pbWF0aW9uU3RhcnRUaW1lID0gLTE7XG4gICAgICAgIHRoaXMuY3VycmVudExvb3ArKztcbiAgICAgICAgdGhpcy5vblVwZGF0ZSh0aGlzLmZyb21WYWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFuaW1hdGlvbkhhc0ZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBvblVwZGF0ZShvdXRwdXRWYWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy52YWx1ZU5vZGUudmFsdWUgPSBvdXRwdXRWYWx1ZTtcbiAgICB0aGlzLnZhbHVlTm9kZS5zZXROZWVkc1VwZGF0ZSgpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJDVFNwcmluZ0FuaW1hdGlvbjtcbiJdfQ==