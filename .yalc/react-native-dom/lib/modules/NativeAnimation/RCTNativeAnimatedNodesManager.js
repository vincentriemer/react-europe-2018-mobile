Object.defineProperty(exports,"__esModule",{value:true});var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _Invariant=require("./../../utils/Invariant");var _Invariant2=_interopRequireDefault(_Invariant);var _RCTAnimatedNode=require("./Nodes/RCTAnimatedNode");var _RCTAnimatedNode2=_interopRequireDefault(_RCTAnimatedNode);var _RCTValueAnimatedNode=require("./Nodes/RCTValueAnimatedNode");var _RCTValueAnimatedNode2=_interopRequireDefault(_RCTValueAnimatedNode);var _RCTPropsAnimatedNode=require("./Nodes/RCTPropsAnimatedNode");var _RCTPropsAnimatedNode2=_interopRequireDefault(_RCTPropsAnimatedNode);var _RCTStyleAnimatedNode=require("./Nodes/RCTStyleAnimatedNode");var _RCTStyleAnimatedNode2=_interopRequireDefault(_RCTStyleAnimatedNode);var _RCTInterpolationAnimatedNode=require("./Nodes/RCTInterpolationAnimatedNode");var _RCTInterpolationAnimatedNode2=_interopRequireDefault(_RCTInterpolationAnimatedNode);var _RCTTransformAnimatedNode=require("./Nodes/RCTTransformAnimatedNode");var _RCTTransformAnimatedNode2=_interopRequireDefault(_RCTTransformAnimatedNode);var _RCTMultiplicationAnimatedNode=require("./Nodes/RCTMultiplicationAnimatedNode");var _RCTMultiplicationAnimatedNode2=_interopRequireDefault(_RCTMultiplicationAnimatedNode);var _RCTAdditionAnimatedNode=require("./Nodes/RCTAdditionAnimatedNode");var _RCTAdditionAnimatedNode2=_interopRequireDefault(_RCTAdditionAnimatedNode);var _RCTModuloAnimatedNode=require("./Nodes/RCTModuloAnimatedNode");var _RCTModuloAnimatedNode2=_interopRequireDefault(_RCTModuloAnimatedNode);var _RCTEventAnimation=require("./Drivers/RCTEventAnimation");var _RCTEventAnimation2=_interopRequireDefault(_RCTEventAnimation);var _RCTFrameAnimation=require("./Drivers/RCTFrameAnimation");var _RCTFrameAnimation2=_interopRequireDefault(_RCTFrameAnimation);var _RCTDecayAnimation=require("./Drivers/RCTDecayAnimation");var _RCTDecayAnimation2=_interopRequireDefault(_RCTDecayAnimation);var _RCTSpringAnimation=require("./Drivers/RCTSpringAnimation");var _RCTSpringAnimation2=_interopRequireDefault(_RCTSpringAnimation);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var NODE_TYPE_MAP={style:_RCTStyleAnimatedNode2.default,value:_RCTValueAnimatedNode2.default,props:_RCTPropsAnimatedNode2.default,interpolation:_RCTInterpolationAnimatedNode2.default,transform:_RCTTransformAnimatedNode2.default,multiplication:_RCTMultiplicationAnimatedNode2.default,addition:_RCTAdditionAnimatedNode2.default,modulus:_RCTModuloAnimatedNode2.default};var DRIVER_TYPE_MAP={frames:_RCTFrameAnimation2.default,decay:_RCTDecayAnimation2.default,spring:_RCTSpringAnimation2.default};var RCTNativeAnimatedNodesManager=function(){function RCTNativeAnimatedNodesManager(uiManager){(0,_classCallCheck3.default)(this,RCTNativeAnimatedNodesManager);this.uiManager=uiManager;this.animationNodes={};this.eventDrivers={};this.activeAnimations=new Set();this.ticking=false;}(0,_createClass3.default)(RCTNativeAnimatedNodesManager,[{key:"createAnimatedNode",value:function createAnimatedNode(tag,config){var nodeType=config.type;var NodeClass=NODE_TYPE_MAP[nodeType];if(!NodeClass){console.error("Animated node type "+nodeType+" not supported natively");return;}var node=new NodeClass(tag,config);this.animationNodes[tag]=node;node.setNeedsUpdate();}},{key:"connectAnimatedNodes",value:function connectAnimatedNodes(parentTag,childTag){var parentNode=this.animationNodes[parentTag];var childNode=this.animationNodes[childTag];(0,_Invariant2.default)(parentNode,"no such parent node with id "+parentTag);(0,_Invariant2.default)(childNode,"no such child node with id "+childTag);parentNode.addChild(childNode);childNode.setNeedsUpdate();}},{key:"disconnectAnimatedNodes",value:function disconnectAnimatedNodes(parentTag,childTag){var parentNode=this.animationNodes[parentTag];var childNode=this.animationNodes[childTag];(0,_Invariant2.default)(parentNode,"no such parent node with id "+parentTag);(0,_Invariant2.default)(childNode,"no such child node with id "+childTag);parentNode.removeChild(childNode);childNode.setNeedsUpdate();}},{key:"connectAnimatedNodeToView",value:function connectAnimatedNodeToView(nodeTag,viewTag,viewName){var node=this.animationNodes[nodeTag];if(node instanceof _RCTPropsAnimatedNode2.default){node.connectToView(viewTag,viewName,this.uiManager);}node.setNeedsUpdate();}},{key:"disconnectAnimatedNodeFromView",value:function disconnectAnimatedNodeFromView(nodeTag,viewTag){var node=this.animationNodes[nodeTag];if(node instanceof _RCTPropsAnimatedNode2.default){node.disconnectFromView(viewTag);}}},{key:"dropAnimatedNode",value:function dropAnimatedNode(tag){var node=this.animationNodes[tag];if(node){node.detachNode();delete this.animationNodes[tag];}}},{key:"setAnimatedNodeValue",value:function setAnimatedNodeValue(nodeTag,value){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode2.default)){console.error("Not a value node.");return;}this.stopAnimationsForNode(node);node.value=value;node.setNeedsUpdate();}},{key:"setAnimatedNodeOffset",value:function setAnimatedNodeOffset(nodeTag,offset){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode2.default)){console.error("Not a value node.");return;}node.offset=offset;node.setNeedsUpdate();}},{key:"flattenAnimatedNodeOffset",value:function flattenAnimatedNodeOffset(nodeTag){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode2.default)){console.error("Not a value node.");return;}node.flattenOffset();}},{key:"extractAnimatedNodeOffset",value:function extractAnimatedNodeOffset(nodeTag){var node=this.animationNodes[nodeTag];if(!(node instanceof _RCTValueAnimatedNode2.default)){console.error("Not a value node.");return;}node.extractOffset();}},{key:"startAnimatingNode",value:function startAnimatingNode(animationId,nodeTag,config,endCallback){var valueNode=this.animationNodes[nodeTag];(0,_Invariant2.default)(valueNode instanceof _RCTValueAnimatedNode2.default,"Animation Node of id "+nodeTag+" is not a ValueAnimatedNode");var AnimationDriverClass=DRIVER_TYPE_MAP[config.type];if(AnimationDriverClass==null){console.error("Unsupported animation type: "+config.type);return;}var animationDriver=new AnimationDriverClass(animationId,config,valueNode,endCallback);this.activeAnimations.add(animationDriver);animationDriver.startAnimation();this.startAnimationLoopIfNeeded();}},{key:"stopAnimation",value:function stopAnimation(animationId){for(var _iterator=this.activeAnimations,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var driver=_ref;if(driver.animationId===animationId){driver.stopAnimation();this.activeAnimations.delete(driver);break;}}}},{key:"stopAnimationsForNode",value:function stopAnimationsForNode(node){var _this=this;var discarded=[];this.activeAnimations.forEach(function(driver){if(driver.valueNode===node){discarded.push(driver);}});discarded.forEach(function(driver){driver.stopAnimation();_this.activeAnimations.delete(driver);});}},{key:"addAnimatedEventToView",value:function addAnimatedEventToView(viewTag,eventName,eventMapping){var nodeTag=eventMapping.animatedValueTag;var node=this.animationNodes[nodeTag];if(!node){console.error("Animated node with tag "+nodeTag+" does not exist");return;}if(!(node instanceof _RCTValueAnimatedNode2.default)){console.error("Animated node connected to event should be of type RCTValueAnimatedNode");return;}var eventPath=eventMapping.nativeEventPath;var driver=new _RCTEventAnimation2.default(eventPath,node);var key=""+viewTag+eventName;if(this.eventDrivers[key]!=null){this.eventDrivers[key].push(driver);}else{this.eventDrivers[key]=[driver];}}},{key:"removeAnimatedEventFromView",value:function removeAnimatedEventFromView(viewTag,eventName,animatedNodeTag){var key=""+viewTag+eventName;if(this.eventDrivers[key]!=null){if(this.eventDrivers[key].length===1){delete this.eventDrivers[key];}else{var driversForKey=this.eventDrivers[key];for(var i=0;i<driversForKey.length;i++){if(driversForKey[i].valueNode.nodeTag===animatedNodeTag){this.eventDrivers[key].splice(i,1);break;}}}}}},{key:"handleAnimatedEvent",value:function handleAnimatedEvent(event){if(Object.keys(this.eventDrivers).length===0){return;}var key=""+event.viewTag+event.eventName;var driversForKey=this.eventDrivers[key];if(driversForKey){for(var _iterator2=driversForKey,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var driver=_ref2;this.stopAnimationsForNode(driver.valueNode);driver.updateWithEvent(event);}this.updateAnimations();}}},{key:"startListeningToAnimatedNodeValue",value:function startListeningToAnimatedNodeValue(tag,valueObserver){var node=this.animationNodes[tag];if(node instanceof _RCTValueAnimatedNode2.default){node.valueObserver=valueObserver;}}},{key:"stopListeningToAnimatedNodeValue",value:function stopListeningToAnimatedNodeValue(tag){var node=this.animationNodes[tag];if(node instanceof _RCTValueAnimatedNode2.default){node.valueObserver=null;}}},{key:"startAnimationLoopIfNeeded",value:function startAnimationLoopIfNeeded(){if(!this.ticking&&this.activeAnimations.size>0){window.requestAnimationFrame(this.stepAnimations.bind(this));this.ticking=true;}}},{key:"stepAnimations",value:function stepAnimations(timestamp){for(var _iterator3=this.activeAnimations,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref3;if(_isArray3){if(_i3>=_iterator3.length)break;_ref3=_iterator3[_i3++];}else{_i3=_iterator3.next();if(_i3.done)break;_ref3=_i3.value;}var animationDriver=_ref3;animationDriver.stepAnimationWithTime(timestamp);}this.updateAnimations();for(var _iterator4=this.activeAnimations,_isArray4=Array.isArray(_iterator4),_i4=0,_iterator4=_isArray4?_iterator4:_iterator4[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref4;if(_isArray4){if(_i4>=_iterator4.length)break;_ref4=_iterator4[_i4++];}else{_i4=_iterator4.next();if(_i4.done)break;_ref4=_i4.value;}var _animationDriver=_ref4;if(_animationDriver.animationHasFinished){_animationDriver.stopAnimation();this.activeAnimations.delete(_animationDriver);}}this.stopAnimationLoopIfNeeded();}},{key:"stopAnimationLoopIfNeeded",value:function stopAnimationLoopIfNeeded(){this.ticking=false;if(this.activeAnimations.size!==0){this.startAnimationLoopIfNeeded();}}},{key:"updateAnimations",value:function updateAnimations(){Object.values(this.animationNodes).forEach(function(node){if(node.needsUpdate){node.updateNodeIfNecessary();}});}}]);return RCTNativeAnimatedNodesManager;}();exports.default=RCTNativeAnimatedNodesManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL1JlYWN0RG9tL21vZHVsZXMvTmF0aXZlQW5pbWF0aW9uL1JDVE5hdGl2ZUFuaW1hdGVkTm9kZXNNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIk5PREVfVFlQRV9NQVAiLCJzdHlsZSIsInZhbHVlIiwicHJvcHMiLCJpbnRlcnBvbGF0aW9uIiwidHJhbnNmb3JtIiwibXVsdGlwbGljYXRpb24iLCJhZGRpdGlvbiIsIm1vZHVsdXMiLCJEUklWRVJfVFlQRV9NQVAiLCJmcmFtZXMiLCJkZWNheSIsInNwcmluZyIsIlJDVE5hdGl2ZUFuaW1hdGVkTm9kZXNNYW5hZ2VyIiwidWlNYW5hZ2VyIiwiYW5pbWF0aW9uTm9kZXMiLCJldmVudERyaXZlcnMiLCJhY3RpdmVBbmltYXRpb25zIiwiU2V0IiwidGlja2luZyIsInRhZyIsImNvbmZpZyIsIm5vZGVUeXBlIiwidHlwZSIsIk5vZGVDbGFzcyIsImNvbnNvbGUiLCJlcnJvciIsIm5vZGUiLCJzZXROZWVkc1VwZGF0ZSIsInBhcmVudFRhZyIsImNoaWxkVGFnIiwicGFyZW50Tm9kZSIsImNoaWxkTm9kZSIsImFkZENoaWxkIiwicmVtb3ZlQ2hpbGQiLCJub2RlVGFnIiwidmlld1RhZyIsInZpZXdOYW1lIiwiY29ubmVjdFRvVmlldyIsImRpc2Nvbm5lY3RGcm9tVmlldyIsImRldGFjaE5vZGUiLCJzdG9wQW5pbWF0aW9uc0Zvck5vZGUiLCJvZmZzZXQiLCJmbGF0dGVuT2Zmc2V0IiwiZXh0cmFjdE9mZnNldCIsImFuaW1hdGlvbklkIiwiZW5kQ2FsbGJhY2siLCJ2YWx1ZU5vZGUiLCJBbmltYXRpb25Ecml2ZXJDbGFzcyIsImFuaW1hdGlvbkRyaXZlciIsImFkZCIsInN0YXJ0QW5pbWF0aW9uIiwic3RhcnRBbmltYXRpb25Mb29wSWZOZWVkZWQiLCJkcml2ZXIiLCJzdG9wQW5pbWF0aW9uIiwiZGVsZXRlIiwiZGlzY2FyZGVkIiwiZm9yRWFjaCIsInB1c2giLCJldmVudE5hbWUiLCJldmVudE1hcHBpbmciLCJhbmltYXRlZFZhbHVlVGFnIiwiZXZlbnRQYXRoIiwibmF0aXZlRXZlbnRQYXRoIiwia2V5IiwiYW5pbWF0ZWROb2RlVGFnIiwibGVuZ3RoIiwiZHJpdmVyc0ZvcktleSIsImkiLCJzcGxpY2UiLCJldmVudCIsIk9iamVjdCIsImtleXMiLCJ1cGRhdGVXaXRoRXZlbnQiLCJ1cGRhdGVBbmltYXRpb25zIiwidmFsdWVPYnNlcnZlciIsInNpemUiLCJ3aW5kb3ciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJzdGVwQW5pbWF0aW9ucyIsImJpbmQiLCJ0aW1lc3RhbXAiLCJzdGVwQW5pbWF0aW9uV2l0aFRpbWUiLCJhbmltYXRpb25IYXNGaW5pc2hlZCIsInN0b3BBbmltYXRpb25Mb29wSWZOZWVkZWQiLCJ2YWx1ZXMiLCJuZWVkc1VwZGF0ZSIsInVwZGF0ZU5vZGVJZk5lY2Vzc2FyeSJdLCJtYXBwaW5ncyI6Im1UQVFBLGtELG1EQU1BLHdELCtEQUNBLGtFLHlFQUNBLGtFLHlFQUNBLGtFLHlFQUNBLGtGLHlGQUNBLDBFLGlGQUNBLG9GLDJGQUNBLHdFLCtFQUNBLG9FLDJFQUdBLDhELG1FQUNBLDhELG1FQUNBLDhELG1FQUNBLGdFLHdKQUtBLEdBQU1BLGVBQWdFLENBQ3BFQyxvQ0FEb0UsQ0FFcEVDLG9DQUZvRSxDQUdwRUMsb0NBSG9FLENBSXBFQyxvREFKb0UsQ0FLcEVDLDRDQUxvRSxDQU1wRUMsc0RBTm9FLENBT3BFQywwQ0FQb0UsQ0FRcEVDLHVDQVJvRSxDQUF0RSxDQVdBLEdBQU1DLGlCQUFxRSxDQUN6RUMsa0NBRHlFLENBRXpFQyxpQ0FGeUUsQ0FHekVDLG1DQUh5RSxDQUEzRSxDLEdBTU1DLDhCLFlBU0osdUNBQVlDLFNBQVosQ0FBcUMsa0VBQ25DLEtBQUtBLFNBQUwsQ0FBaUJBLFNBQWpCLENBQ0EsS0FBS0MsY0FBTCxDQUFzQixFQUF0QixDQUNBLEtBQUtDLFlBQUwsQ0FBb0IsRUFBcEIsQ0FDQSxLQUFLQyxnQkFBTCxDQUF3QixHQUFJQyxJQUFKLEVBQXhCLENBQ0EsS0FBS0Ms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LHFCQUFMLEdBQ0QsQ0FDRixDQUpELEVBS0QsQyw2REFHWTFFLDZCIiwiZmlsZSI6IlJDVE5hdGl2ZUFuaW1hdGVkTm9kZXNNYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcHJvdmlkZXNNb2R1bGUgUkNUTmF0aXZlQW5pbWF0ZWROb2Rlc01hbmFnZXJcbiAqIEBmbG93XG4gKi9cblxuaW1wb3J0IHR5cGUgeyBDb25maWcgfSBmcm9tIFwiUkNUTmF0aXZlQW5pbWF0ZWRNb2R1bGVcIjtcbmltcG9ydCB0eXBlIHsgUkNURXZlbnQgfSBmcm9tIFwiUkNURXZlbnREaXNwYXRjaGVyXCI7XG5cbmltcG9ydCBpbnZhcmlhbnQgZnJvbSBcIkludmFyaWFudFwiO1xuXG5pbXBvcnQgdHlwZSB7IFJDVEFuaW1hdGlvbkRyaXZlciB9IGZyb20gXCJSQ1RBbmltYXRpb25Ecml2ZXJcIjtcbmltcG9ydCB0eXBlIHsgUkNUVmFsdWVBbmltYXRlZE5vZGVPYnNlcnZlciB9IGZyb20gXCJSQ1RWYWx1ZUFuaW1hdGVkTm9kZVwiO1xuXG4vLyBOb2Rlc1xuaW1wb3J0IFJDVEFuaW1hdGVkTm9kZSBmcm9tIFwiUkNUQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUVmFsdWVBbmltYXRlZE5vZGUgZnJvbSBcIlJDVFZhbHVlQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUUHJvcHNBbmltYXRlZE5vZGUgZnJvbSBcIlJDVFByb3BzQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUU3R5bGVBbmltYXRlZE5vZGUgZnJvbSBcIlJDVFN0eWxlQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUSW50ZXJwb2xhdGlvbkFuaW1hdGVkTm9kZSBmcm9tIFwiUkNUSW50ZXJwb2xhdGlvbkFuaW1hdGVkTm9kZVwiO1xuaW1wb3J0IFJDVFRyYW5zZm9ybUFuaW1hdGVkTm9kZSBmcm9tIFwiUkNUVHJhbnNmb3JtQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUTXVsdGlwbGljYXRpb25BbmltYXRlZE5vZGUgZnJvbSBcIlJDVE11bHRpcGxpY2F0aW9uQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUQWRkaXRpb25BbmltYXRlZE5vZGUgZnJvbSBcIlJDVEFkZGl0aW9uQW5pbWF0ZWROb2RlXCI7XG5pbXBvcnQgUkNUTW9kdWxvQW5pbWF0ZWROb2RlIGZyb20gXCJSQ1RNb2R1bG9BbmltYXRlZE5vZGVcIjtcblxuLy8gRHJpdmVyc1xuaW1wb3J0IFJDVEV2ZW50QW5pbWF0aW9uIGZyb20gXCJSQ1RFdmVudEFuaW1hdGlvblwiO1xuaW1wb3J0IFJDVEZyYW1lQW5pbWF0aW9uIGZyb20gXCJSQ1RGcmFtZUFuaW1hdGlvblwiO1xuaW1wb3J0IFJDVERlY2F5QW5pbWF0aW9uIGZyb20gXCJSQ1REZWNheUFuaW1hdGlvblwiO1xuaW1wb3J0IFJDVFNwcmluZ0FuaW1hdGlvbiBmcm9tIFwiUkNUU3ByaW5nQW5pbWF0aW9uXCI7XG5cbmltcG9ydCB0eXBlb2YgX1JDVFVJTWFuYWdlciBmcm9tIFwiUkNUVUlNYW5hZ2VyXCI7XG50eXBlIFJDVFVJTWFuYWdlciA9ICRDYWxsPCRhd2FpdDxfUkNUVUlNYW5hZ2VyPj47XG5cbmNvbnN0IE5PREVfVFlQRV9NQVA6IHsgW3R5cGVOYW1lOiBzdHJpbmddOiBDbGFzczxSQ1RBbmltYXRlZE5vZGU+IH0gPSB7XG4gIHN0eWxlOiBSQ1RTdHlsZUFuaW1hdGVkTm9kZSxcbiAgdmFsdWU6IFJDVFZhbHVlQW5pbWF0ZWROb2RlLFxuICBwcm9wczogUkNUUHJvcHNBbmltYXRlZE5vZGUsXG4gIGludGVycG9sYXRpb246IFJDVEludGVycG9sYXRpb25BbmltYXRlZE5vZGUsXG4gIHRyYW5zZm9ybTogUkNUVHJhbnNmb3JtQW5pbWF0ZWROb2RlLFxuICBtdWx0aXBsaWNhdGlvbjogUkNUTXVsdGlwbGljYXRpb25BbmltYXRlZE5vZGUsXG4gIGFkZGl0aW9uOiBSQ1RBZGRpdGlvbkFuaW1hdGVkTm9kZSxcbiAgbW9kdWx1czogUkNUTW9kdWxvQW5pbWF0ZWROb2RlXG59O1xuXG5jb25zdCBEUklWRVJfVFlQRV9NQVA6IHsgW3R5cGVOYW1lOiBzdHJpbmddOiBDbGFzczxSQ1RBbmltYXRpb25Ecml2ZXI+IH0gPSB7XG4gIGZyYW1lczogUkNURnJhbWVBbmltYXRpb24sXG4gIGRlY2F5OiBSQ1REZWNheUFuaW1hdGlvbixcbiAgc3ByaW5nOiBSQ1RTcHJpbmdBbmltYXRpb25cbn07XG5cbmNsYXNzIFJDVE5hdGl2ZUFuaW1hdGVkTm9kZXNNYW5hZ2VyIHtcbiAgdWlNYW5hZ2VyOiBSQ1RVSU1hbmFnZXI7XG5cbiAgYW5pbWF0aW9uTm9kZXM6IHsgW25vZGVUYWc6IG51bWJlcl06IFJDVEFuaW1hdGVkTm9kZSB9O1xuICBldmVudERyaXZlcnM6IHsgW2tleTogc3RyaW5nXTogUkNURXZlbnRBbmltYXRpb25bXSB9O1xuICBhY3RpdmVBbmltYXRpb25zOiBTZXQ8UkNUQW5pbWF0aW9uRHJpdmVyPjtcblxuICB0aWNraW5nOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKHVpTWFuYWdlcjogUkNUVUlNYW5hZ2VyKSB7XG4gICAgdGhpcy51aU1hbmFnZXIgPSB1aU1hbmFnZXI7XG4gICAgdGhpcy5hbmltYXRpb25Ob2RlcyA9IHt9O1xuICAgIHRoaXMuZXZlbnREcml2ZXJzID0ge307XG4gICAgdGhpcy5hY3RpdmVBbmltYXRpb25zID0gbmV3IFNldCgpO1xuICAgIHRoaXMudGlja2luZyA9IGZhbHNlO1xuICB9XG5cbiAgLy8gLS0gR3JhcGhcblxuICBjcmVhdGVBbmltYXRlZE5vZGUodGFnOiBudW1iZXIsIGNvbmZpZzogQ29uZmlnKSB7XG4gICAgY29uc3Qgbm9kZVR5cGUgPSBjb25maWcudHlwZTtcblxuICAgIGNvbnN0IE5vZGVDbGFzcyA9IE5PREVfVFlQRV9NQVBbbm9kZVR5cGVdO1xuICAgIGlmICghTm9kZUNsYXNzKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBBbmltYXRlZCBub2RlIHR5cGUgJHtub2RlVHlwZX0gbm90IHN1cHBvcnRlZCBuYXRpdmVseWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IG5vZGUgPSBuZXcgTm9kZUNsYXNzKHRhZywgY29uZmlnKTtcbiAgICB0aGlzLmFuaW1hdGlvbk5vZGVzW3RhZ10gPSBub2RlO1xuICAgIG5vZGUuc2V0TmVlZHNVcGRhdGUoKTtcbiAgfVxuXG4gIGNvbm5lY3RBbmltYXRlZE5vZGVzKHBhcmVudFRhZzogbnVtYmVyLCBjaGlsZFRhZzogbnVtYmVyKSB7XG4gICAgY29uc3QgcGFyZW50Tm9kZSA9IHRoaXMuYW5pbWF0aW9uTm9kZXNbcGFyZW50VGFnXTtcbiAgICBjb25zdCBjaGlsZE5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW2NoaWxkVGFnXTtcblxuICAgIGludmFyaWFudChwYXJlbnROb2RlLCBgbm8gc3VjaCBwYXJlbnQgbm9kZSB3aXRoIGlkICR7cGFyZW50VGFnfWApO1xuICAgIGludmFyaWFudChjaGlsZE5vZGUsIGBubyBzdWNoIGNoaWxkIG5vZGUgd2l0aCBpZCAke2NoaWxkVGFnfWApO1xuXG4gICAgcGFyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpO1xuICAgIGNoaWxkTm9kZS5zZXROZWVkc1VwZGF0ZSgpO1xuICB9XG5cbiAgZGlzY29ubmVjdEFuaW1hdGVkTm9kZXMocGFyZW50VGFnOiBudW1iZXIsIGNoaWxkVGFnOiBudW1iZXIpIHtcbiAgICBjb25zdCBwYXJlbnROb2RlID0gdGhpcy5hbmltYXRpb25Ob2Rlc1twYXJlbnRUYWddO1xuICAgIGNvbnN0IGNoaWxkTm9kZSA9IHRoaXMuYW5pbWF0aW9uTm9kZXNbY2hpbGRUYWddO1xuXG4gICAgaW52YXJpYW50KHBhcmVudE5vZGUsIGBubyBzdWNoIHBhcmVudCBub2RlIHdpdGggaWQgJHtwYXJlbnRUYWd9YCk7XG4gICAgaW52YXJpYW50KGNoaWxkTm9kZSwgYG5vIHN1Y2ggY2hpbGQgbm9kZSB3aXRoIGlkICR7Y2hpbGRUYWd9YCk7XG5cbiAgICBwYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkTm9kZSk7XG4gICAgY2hpbGROb2RlLnNldE5lZWRzVXBkYXRlKCk7XG4gIH1cblxuICBjb25uZWN0QW5pbWF0ZWROb2RlVG9WaWV3KFxuICAgIG5vZGVUYWc6IG51bWJlcixcbiAgICB2aWV3VGFnOiBudW1iZXIsXG4gICAgdmlld05hbWU6IHN0cmluZ1xuICApIHtcbiAgICBjb25zdCBub2RlID0gdGhpcy5hbmltYXRpb25Ob2Rlc1tub2RlVGFnXTtcbiAgICBpZiAobm9kZSBpbnN0YW5jZW9mIFJDVFByb3BzQW5pbWF0ZWROb2RlKSB7XG4gICAgICBub2RlLmNvbm5lY3RUb1ZpZXcodmlld1RhZywgdmlld05hbWUsIHRoaXMudWlNYW5hZ2VyKTtcbiAgICB9XG4gICAgbm9kZS5zZXROZWVkc1VwZGF0ZSgpO1xuICB9XG5cbiAgZGlzY29ubmVjdEFuaW1hdGVkTm9kZUZyb21WaWV3KG5vZGVUYWc6IG51bWJlciwgdmlld1RhZzogbnVtYmVyKSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuYW5pbWF0aW9uTm9kZXNbbm9kZVRhZ107XG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBSQ1RQcm9wc0FuaW1hdGVkTm9kZSkge1xuICAgICAgbm9kZS5kaXNjb25uZWN0RnJvbVZpZXcodmlld1RhZyk7XG4gICAgfVxuICB9XG5cbiAgZHJvcEFuaW1hdGVkTm9kZSh0YWc6IG51bWJlcikge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW3RhZ107XG4gICAgaWYgKG5vZGUpIHtcbiAgICAgIG5vZGUuZGV0YWNoTm9kZSgpO1xuICAgICAgZGVsZXRlIHRoaXMuYW5pbWF0aW9uTm9kZXNbdGFnXTtcbiAgICB9XG4gIH1cblxuICAvLyAtLSBNdXRhdGlvbnNcblxuICBzZXRBbmltYXRlZE5vZGVWYWx1ZShub2RlVGFnOiBudW1iZXIsIHZhbHVlOiBudW1iZXIpIHtcbiAgICBjb25zdCBub2RlID0gdGhpcy5hbmltYXRpb25Ob2Rlc1tub2RlVGFnXTtcbiAgICBpZiAoIShub2RlIGluc3RhbmNlb2YgUkNUVmFsdWVBbmltYXRlZE5vZGUpKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiTm90IGEgdmFsdWUgbm9kZS5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc3RvcEFuaW1hdGlvbnNGb3JOb2RlKG5vZGUpO1xuXG4gICAgbm9kZS52YWx1ZSA9IHZhbHVlO1xuICAgIG5vZGUuc2V0TmVlZHNVcGRhdGUoKTtcbiAgfVxuXG4gIHNldEFuaW1hdGVkTm9kZU9mZnNldChub2RlVGFnOiBudW1iZXIsIG9mZnNldDogbnVtYmVyKSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuYW5pbWF0aW9uTm9kZXNbbm9kZVRhZ107XG4gICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIFJDVFZhbHVlQW5pbWF0ZWROb2RlKSkge1xuICAgICAgY29uc29sZS5lcnJvcihcIk5vdCBhIHZhbHVlIG5vZGUuXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBub2RlLm9mZnNldCA9IG9mZnNldDtcbiAgICBub2RlLnNldE5lZWRzVXBkYXRlKCk7XG4gIH1cblxuICBmbGF0dGVuQW5pbWF0ZWROb2RlT2Zmc2V0KG5vZGVUYWc6IG51bWJlcikge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW25vZGVUYWddO1xuICAgIGlmICghKG5vZGUgaW5zdGFuY2VvZiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJOb3QgYSB2YWx1ZSBub2RlLlwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbm9kZS5mbGF0dGVuT2Zmc2V0KCk7XG4gIH1cblxuICBleHRyYWN0QW5pbWF0ZWROb2RlT2Zmc2V0KG5vZGVUYWc6IG51bWJlcikge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW25vZGVUYWddO1xuICAgIGlmICghKG5vZGUgaW5zdGFuY2VvZiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJOb3QgYSB2YWx1ZSBub2RlLlwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbm9kZS5leHRyYWN0T2Zmc2V0KCk7XG4gIH1cblxuICAvLyAtLSBEcml2ZXJzXG5cbiAgc3RhcnRBbmltYXRpbmdOb2RlKFxuICAgIGFuaW1hdGlvbklkOiBudW1iZXIsXG4gICAgbm9kZVRhZzogbnVtYmVyLFxuICAgIGNvbmZpZzogQ29uZmlnLFxuICAgIGVuZENhbGxiYWNrOiBGdW5jdGlvblxuICApIHtcbiAgICBjb25zdCB2YWx1ZU5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW25vZGVUYWddO1xuICAgIGludmFyaWFudChcbiAgICAgIHZhbHVlTm9kZSBpbnN0YW5jZW9mIFJDVFZhbHVlQW5pbWF0ZWROb2RlLFxuICAgICAgYEFuaW1hdGlvbiBOb2RlIG9mIGlkICR7bm9kZVRhZ30gaXMgbm90IGEgVmFsdWVBbmltYXRlZE5vZGVgXG4gICAgKTtcblxuICAgIGNvbnN0IEFuaW1hdGlvbkRyaXZlckNsYXNzID0gRFJJVkVSX1RZUEVfTUFQW2NvbmZpZy50eXBlXTtcbiAgICBpZiAoQW5pbWF0aW9uRHJpdmVyQ2xhc3MgPT0gbnVsbCkge1xuICAgICAgY29uc29sZS5lcnJvcihgVW5zdXBwb3J0ZWQgYW5pbWF0aW9uIHR5cGU6ICR7Y29uZmlnLnR5cGV9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYW5pbWF0aW9uRHJpdmVyID0gbmV3IEFuaW1hdGlvbkRyaXZlckNsYXNzKFxuICAgICAgYW5pbWF0aW9uSWQsXG4gICAgICBjb25maWcsXG4gICAgICB2YWx1ZU5vZGUsXG4gICAgICBlbmRDYWxsYmFja1xuICAgICk7XG5cbiAgICB0aGlzLmFjdGl2ZUFuaW1hdGlvbnMuYWRkKGFuaW1hdGlvbkRyaXZlcik7XG4gICAgYW5pbWF0aW9uRHJpdmVyLnN0YXJ0QW5pbWF0aW9uKCk7XG4gICAgdGhpcy5zdGFydEFuaW1hdGlvbkxvb3BJZk5lZWRlZCgpO1xuICB9XG5cbiAgc3RvcEFuaW1hdGlvbihhbmltYXRpb25JZDogbnVtYmVyKSB7XG4gICAgZm9yIChsZXQgZHJpdmVyIG9mIHRoaXMuYWN0aXZlQW5pbWF0aW9ucykge1xuICAgICAgaWYgKGRyaXZlci5hbmltYXRpb25JZCA9PT0gYW5pbWF0aW9uSWQpIHtcbiAgICAgICAgZHJpdmVyLnN0b3BBbmltYXRpb24oKTtcbiAgICAgICAgdGhpcy5hY3RpdmVBbmltYXRpb25zLmRlbGV0ZShkcml2ZXIpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdG9wQW5pbWF0aW9uc0Zvck5vZGUobm9kZTogUkNUQW5pbWF0ZWROb2RlKSB7XG4gICAgY29uc3QgZGlzY2FyZGVkOiBSQ1RBbmltYXRpb25Ecml2ZXJbXSA9IFtdO1xuICAgIHRoaXMuYWN0aXZlQW5pbWF0aW9ucy5mb3JFYWNoKChkcml2ZXIpID0+IHtcbiAgICAgIGlmIChkcml2ZXIudmFsdWVOb2RlID09PSBub2RlKSB7XG4gICAgICAgIGRpc2NhcmRlZC5wdXNoKGRyaXZlcik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBkaXNjYXJkZWQuZm9yRWFjaCgoZHJpdmVyKSA9PiB7XG4gICAgICBkcml2ZXIuc3RvcEFuaW1hdGlvbigpO1xuICAgICAgdGhpcy5hY3RpdmVBbmltYXRpb25zLmRlbGV0ZShkcml2ZXIpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gLS0gRXZlbnRzXG5cbiAgYWRkQW5pbWF0ZWRFdmVudFRvVmlldyhcbiAgICB2aWV3VGFnOiBudW1iZXIsXG4gICAgZXZlbnROYW1lOiBzdHJpbmcsXG4gICAgZXZlbnRNYXBwaW5nOiBPYmplY3RcbiAgKSB7XG4gICAgY29uc3Qgbm9kZVRhZzogbnVtYmVyID0gZXZlbnRNYXBwaW5nLmFuaW1hdGVkVmFsdWVUYWc7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuYW5pbWF0aW9uTm9kZXNbbm9kZVRhZ107XG5cbiAgICBpZiAoIW5vZGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEFuaW1hdGVkIG5vZGUgd2l0aCB0YWcgJHtub2RlVGFnfSBkb2VzIG5vdCBleGlzdGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghKG5vZGUgaW5zdGFuY2VvZiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIFwiQW5pbWF0ZWQgbm9kZSBjb25uZWN0ZWQgdG8gZXZlbnQgc2hvdWxkIGJlIG9mIHR5cGUgUkNUVmFsdWVBbmltYXRlZE5vZGVcIlxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBldmVudFBhdGg6IHN0cmluZ1tdID0gZXZlbnRNYXBwaW5nLm5hdGl2ZUV2ZW50UGF0aDtcblxuICAgIGNvbnN0IGRyaXZlciA9IG5ldyBSQ1RFdmVudEFuaW1hdGlvbihldmVudFBhdGgsIG5vZGUpO1xuXG4gICAgY29uc3Qga2V5ID0gYCR7dmlld1RhZ30ke2V2ZW50TmFtZX1gO1xuICAgIGlmICh0aGlzLmV2ZW50RHJpdmVyc1trZXldICE9IG51bGwpIHtcbiAgICAgIHRoaXMuZXZlbnREcml2ZXJzW2tleV0ucHVzaChkcml2ZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmV2ZW50RHJpdmVyc1trZXldID0gW2RyaXZlcl07XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlQW5pbWF0ZWRFdmVudEZyb21WaWV3KFxuICAgIHZpZXdUYWc6IG51bWJlcixcbiAgICBldmVudE5hbWU6IHN0cmluZyxcbiAgICBhbmltYXRlZE5vZGVUYWc6IG51bWJlclxuICApIHtcbiAgICBjb25zdCBrZXkgPSBgJHt2aWV3VGFnfSR7ZXZlbnROYW1lfWA7XG4gICAgaWYgKHRoaXMuZXZlbnREcml2ZXJzW2tleV0gIT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMuZXZlbnREcml2ZXJzW2tleV0ubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmV2ZW50RHJpdmVyc1trZXldO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZHJpdmVyc0ZvcktleSA9IHRoaXMuZXZlbnREcml2ZXJzW2tleV07XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZHJpdmVyc0ZvcktleS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGlmIChkcml2ZXJzRm9yS2V5W2ldLnZhbHVlTm9kZS5ub2RlVGFnID09PSBhbmltYXRlZE5vZGVUYWcpIHtcbiAgICAgICAgICAgIHRoaXMuZXZlbnREcml2ZXJzW2tleV0uc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlQW5pbWF0ZWRFdmVudChldmVudDogUkNURXZlbnQpIHtcbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5ldmVudERyaXZlcnMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IGAke2V2ZW50LnZpZXdUYWd9JHtldmVudC5ldmVudE5hbWV9YDtcbiAgICBjb25zdCBkcml2ZXJzRm9yS2V5ID0gdGhpcy5ldmVudERyaXZlcnNba2V5XTtcblxuICAgIGlmIChkcml2ZXJzRm9yS2V5KSB7XG4gICAgICBmb3IgKGxldCBkcml2ZXIgb2YgZHJpdmVyc0ZvcktleSkge1xuICAgICAgICB0aGlzLnN0b3BBbmltYXRpb25zRm9yTm9kZShkcml2ZXIudmFsdWVOb2RlKTtcbiAgICAgICAgZHJpdmVyLnVwZGF0ZVdpdGhFdmVudChldmVudCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMudXBkYXRlQW5pbWF0aW9ucygpO1xuICAgIH1cbiAgfVxuXG4gIC8vIC0tIExpc3RlbmVyc1xuXG4gIHN0YXJ0TGlzdGVuaW5nVG9BbmltYXRlZE5vZGVWYWx1ZShcbiAgICB0YWc6IG51bWJlcixcbiAgICB2YWx1ZU9ic2VydmVyOiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZU9ic2VydmVyXG4gICkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW3RhZ107XG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSkge1xuICAgICAgbm9kZS52YWx1ZU9ic2VydmVyID0gdmFsdWVPYnNlcnZlcjtcbiAgICB9XG4gIH1cblxuICBzdG9wTGlzdGVuaW5nVG9BbmltYXRlZE5vZGVWYWx1ZSh0YWc6IG51bWJlcikge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmFuaW1hdGlvbk5vZGVzW3RhZ107XG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBSQ1RWYWx1ZUFuaW1hdGVkTm9kZSkge1xuICAgICAgbm9kZS52YWx1ZU9ic2VydmVyID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvLyAtLSBBbmltYXRpb24gTG9vcFxuICAvLyBUT0RPOiBEb24ndCBob29rIGludG8gUkFGIGFuZCBpbnN0ZWFkIGRlY2xhcml0aXZlbHkgdXNlIFdBQVBJXG5cbiAgc3RhcnRBbmltYXRpb25Mb29wSWZOZWVkZWQoKSB7XG4gICAgaWYgKCF0aGlzLnRpY2tpbmcgJiYgdGhpcy5hY3RpdmVBbmltYXRpb25zLnNpemUgPiAwKSB7XG4gICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuc3RlcEFuaW1hdGlvbnMuYmluZCh0aGlzKSk7XG4gICAgICB0aGlzLnRpY2tpbmcgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHN0ZXBBbmltYXRpb25zKHRpbWVzdGFtcDogbnVtYmVyKSB7XG4gICAgZm9yIChsZXQgYW5pbWF0aW9uRHJpdmVyIG9mIHRoaXMuYWN0aXZlQW5pbWF0aW9ucykge1xuICAgICAgYW5pbWF0aW9uRHJpdmVyLnN0ZXBBbmltYXRpb25XaXRoVGltZSh0aW1lc3RhbXApO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlQW5pbWF0aW9ucygpO1xuXG4gICAgZm9yIChsZXQgYW5pbWF0aW9uRHJpdmVyIG9mIHRoaXMuYWN0aXZlQW5pbWF0aW9ucykge1xuICAgICAgaWYgKGFuaW1hdGlvbkRyaXZlci5hbmltYXRpb25IYXNGaW5pc2hlZCkge1xuICAgICAgICBhbmltYXRpb25Ecml2ZXIuc3RvcEFuaW1hdGlvbigpO1xuICAgICAgICB0aGlzLmFjdGl2ZUFuaW1hdGlvbnMuZGVsZXRlKGFuaW1hdGlvbkRyaXZlcik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5zdG9wQW5pbWF0aW9uTG9vcElmTmVlZGVkKCk7XG4gIH1cblxuICBzdG9wQW5pbWF0aW9uTG9vcElmTmVlZGVkKCkge1xuICAgIHRoaXMudGlja2luZyA9IGZhbHNlO1xuXG4gICAgLy8gSWYgdGhlcmUgYXJlIHN0aWxsIGFjdGl2ZSBhbmltYXRpb25zIGNvbnRpbnVlIHRvIG5leHQgZnJhbWVcbiAgICBpZiAodGhpcy5hY3RpdmVBbmltYXRpb25zLnNpemUgIT09IDApIHtcbiAgICAgIHRoaXMuc3RhcnRBbmltYXRpb25Mb29wSWZOZWVkZWQoKTtcbiAgICB9XG4gIH1cblxuICAvLyAtLSBVcGRhdGVzXG5cbiAgdXBkYXRlQW5pbWF0aW9ucygpIHtcbiAgICAvLyAkRmxvd0ZpeE1lXG4gICAgT2JqZWN0LnZhbHVlcyh0aGlzLmFuaW1hdGlvbk5vZGVzKS5mb3JFYWNoKChub2RlOiBSQ1RBbmltYXRlZE5vZGUpID0+IHtcbiAgICAgIGlmIChub2RlLm5lZWRzVXBkYXRlKSB7XG4gICAgICAgIG5vZGUudXBkYXRlTm9kZUlmTmVjZXNzYXJ5KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUkNUTmF0aXZlQW5pbWF0ZWROb2Rlc01hbmFnZXI7XG4iXX0=