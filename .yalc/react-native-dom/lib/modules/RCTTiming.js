Object.defineProperty(exports,"__esModule",{value:true});var _regenerator=require("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _dec,_dec2,_dec3,_dec4,_class,_desc,_value,_class2;var _RCTBridge=require("./../bridge/RCTBridge");var _RCTBridge2=_interopRequireDefault(_RCTBridge);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _applyDecoratedDescriptor(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}var IDLE_CALLBACK_THRESHOLD=1;function now(){return window.performance?performance.now():Date.now();}var RCTTiming=(_dec=(0,_RCTBridge.RCT_EXPORT_MODULE)("RCTTiming"),_dec2=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec3=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec4=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec(_class=(_class2=function(){function RCTTiming(bridge){(0,_classCallCheck3.default)(this,RCTTiming);this.bridge=bridge;this.timers={};this.sendIdleEvents=false;this.targetFrameDuration=1000.0/60.0;}(0,_createClass3.default)(RCTTiming,[{key:"createTimer",value:function createTimer(callbackId,duration,jsSchedulingTime,repeats){var currentTimeMillis=now();var currentDateNowTimeMillis=jsSchedulingTime+1000/60;var adjustedDuration=Math.max(0.0,jsSchedulingTime-currentDateNowTimeMillis+duration);var initialTargetTime=currentTimeMillis+adjustedDuration;var timer={callbackId:callbackId,duration:duration,jsSchedulingTime:initialTargetTime,repeats:repeats};if(adjustedDuration===0){if(timer.repeats){timer.jsSchedulingTime+=timer.duration;this.timers[String(callbackId)]=timer;}this.bridge.enqueueJSCall("JSTimers","callTimers",[[callbackId]]);}else{this.timers[String(callbackId)]=timer;}}},{key:"deleteTimer",value:function deleteTimer(callbackId){delete this.timers[String(callbackId)];}},{key:"setSendIdleEvents",value:function setSendIdleEvents(sendIdle){this.sendIdleEvents=sendIdle;}},{key:"frame",value:function frame(){var toRemove,timers,time,timer,t,_iterator,_isArray,_i,_ref,_timer;return _regenerator2.default.async(function frame$(_context){while(1){switch(_context.prev=_context.next){case 0:toRemove=[];timers=[];time=now();for(timer in this.timers){t=this.timers[timer];if(t.jsSchedulingTime<=time){timers.push(this.timers[timer].callbackId);if(t.repeats){t.jsSchedulingTime+=t.duration;}else{toRemove.push(timer);}}}if(timers.length){this.bridge.enqueueJSCall("JSTimers","callTimers",[timers]);}_iterator=toRemove,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();case 6:if(!_isArray){_context.next=12;break;}if(!(_i>=_iterator.length)){_context.next=9;break;}return _context.abrupt("break",20);case 9:_ref=_iterator[_i++];_context.next=16;break;case 12:_i=_iterator.next();if(!_i.done){_context.next=15;break;}return _context.abrupt("break",20);case 15:_ref=_i.value;case 16:_timer=_ref;delete this.timers[_timer];case 18:_context.next=6;break;case 20:case"end":return _context.stop();}}},null,this);}},{key:"idle",value:function idle(frameStart){var frameNow,frameElapsed;return _regenerator2.default.async(function idle$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(this.sendIdleEvents){_context2.next=2;break;}return _context2.abrupt("return");case 2:frameNow=now();frameElapsed=frameNow-frameStart;if(this.targetFrameDuration-frameElapsed>=IDLE_CALLBACK_THRESHOLD){this.bridge.enqueueJSCall("JSTimers","callIdleCallbacks",[Date.now()-frameElapsed]);}case 5:case"end":return _context2.stop();}}},null,this);}},{key:"shouldContinue",value:function shouldContinue(){return Object.keys(this.timers).length!==0;}}]);return RCTTiming;}(),(_applyDecoratedDescriptor(_class2.prototype,"createTimer",[_dec2],Object.getOwnPropertyDescriptor(_class2.prototype,"createTimer"),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,"deleteTimer",[_dec3],Object.getOwnPropertyDescriptor(_class2.prototype,"deleteTimer"),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,"setSendIdleEvents",[_dec4],Object.getOwnPropertyDescriptor(_class2.prototype,"setSendIdleEvents"),_class2.prototype)),_class2))||_class);exports.default=RCTTiming;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL1JlYWN0RG9tL21vZHVsZXMvUkNUVGltaW5nLmpzIl0sIm5hbWVzIjpbIklETEVfQ0FMTEJBQ0tfVEhSRVNIT0xEIiwibm93Iiwid2luZG93IiwicGVyZm9ybWFuY2UiLCJEYXRlIiwiUkNUVGltaW5nIiwiYnJpZGdlIiwidGltZXJzIiwic2VuZElkbGVFdmVudHMiLCJ0YXJnZXRGcmFtZUR1cmF0aW9uIiwiY2FsbGJhY2tJZCIsImR1cmF0aW9uIiwianNTY2hlZHVsaW5nVGltZSIsInJlcGVhdHMiLCJjdXJyZW50VGltZU1pbGxpcyIsImN1cnJlbnREYXRlTm93VGltZU1pbGxpcyIsImFkanVzdGVkRHVyYXRpb24iLCJNYXRoIiwibWF4IiwiaW5pdGlhbFRhcmdldFRpbWUiLCJ0aW1lciIsIlN0cmluZyIsImVucXVldWVKU0NhbGwiLCJzZW5kSWRsZSIsInRvUmVtb3ZlIiwidGltZSIsInQiLCJwdXNoIiwibGVuZ3RoIiwiZnJhbWVTdGFydCIsImZyYW1lTm93IiwiZnJhbWVFbGFwc2VkIiwiT2JqZWN0Iiwia2V5cyJdLCJtYXBwaW5ncyI6InVkQUtBLGdELDB4QkFhQSxHQUFNQSx5QkFBMEIsQ0FBaEMsQ0FFQSxRQUFTQyxJQUFULEVBQWUsQ0FDYixNQUFPQyxRQUFPQyxXQUFQLENBQXFCQSxZQUFZRixHQUFaLEVBQXJCLENBQXlDRyxLQUFLSCxHQUFMLEVBQWhELENBQ0QsQyxHQUdLSSxVLE9BREwsaUNBQWtCLFdBQWxCLEMsT0FjRSxrRSxPQWlDQSxrRSxPQUtBLGtFLGlDQTdDRCxtQkFBWUMsTUFBWixDQUErQiw4Q0FDN0IsS0FBS0EsTUFBTCxDQUFjQSxNQUFkLENBQ0EsS0FBS0MsTUFBTCxDQUFjLEVBQWQsQ0FDQSxLQUFLQyxjQUFMLENBQXNCLEtBQXRCLENBQ0EsS0FBS0MsbUJBQUwsQ0FBMkIsT0FBUyxJQUFwQyxDQUNELEMsbUZBSUNDLFUsQ0FDQUMsUSxDQUNBQyxnQixDQUNBQyxPLENBQ0EsQ0FDQSxHQUFNQyxtQkFBb0JiLEtBQTFCLENBQ0EsR0FBTWMsMEJBQTJCSCxpQkFBbUIsS0FBTyxFQUEzRCxDQUNBLEdBQU1JLGtCQUFtQkMsS0FBS0MsR0FBTCxDQUN2QixHQUR1QixDQUV2Qk4saUJBQW1CRyx3QkFBbkIsQ0FBOENKLFFBRnZCLENBQXpCLENBSUEsR0FBTVEsbUJBQW9CTCxrQkFBb0JFLGdCQUE5QyxDQUVBLEdBQU1JLE9BQVEsQ0FDWlYscUJBRFksQ0FFWkMsaUJBRlksQ0FHWkMsaUJBQWtCTyxpQkFITixDQUlaTixlQUpZLENBQWQsQ0FPQSxHQUFJRyxtQkFBcUIsQ0FBekIsQ0FBNEIsQ0FDMUIsR0FBSUksTUFBTVAsT0FBVixDQUFtQixDQUNqQk8sTUFBTVIsZ0JBQU4sRUFBMEJRLE1BQU1ULFFBQWhDLENBQ0EsS0FBS0osTUFBTCxDQUFZYyxPQUFPWCxVQUFQLENBQVosRUFBa0NVLEtBQWxDLENBQ0QsQ0FDRCxLQUFLZCxNQUFMLENBQVlnQixhQUFaLENBQTBCLFVBQTFCLENBQXNDLFlBQXRDLENBQW9ELENBQUMsQ0FBQ1osVUFBRCxDQUFELENBQXBELEVBQ0QsQ0FORCxJQU1PLENBQ0wsS0FBS0gsTUFBTCxDQUFZYyxPQUFPWCxVQUFQLENBQVosRUFBa0NVLEtBQWxDLENBQ0QsQ0FDRixDLGdEQUdXVixVLENBQW9CLENBQzlCLE1BQU8sTUFBS0gsTUFBTCxDQUFZYyxPQUFPWCxVQUFQLENBQVosQ0FBUCxDQUNELEMsNERBR2lCYSxRLENBQW1CLENBQ25DLEtBQUtmLGNBQUwsQ0FBc0JlLFFBQXRCLENBQ0QsQywwTkFHT0MsUSxDQUFXLEUsQ0FDWGpCLE0sQ0FBUyxFLENBQ1RrQixJLENBQU94QixLLENBRWIsSUFBV21CLEtBQVgsR0FBb0IsTUFBS2IsTUFBekIsQ0FBaUMsQ0FDekJtQixDQUR5QixDQUNyQixLQUFLbkIsTUFBTCxDQUFZYSxLQUFaLENBRHFCLENBRS9CLEdBQUlNLEVBQUVkLGdCQUFGLEVBQXNCYSxJQUExQixDQUFnQyxDQUM5QmxCLE9BQU9vQixJQUFQLENBQVksS0FBS3BCLE1BQUwsQ0FBWWEsS0FBWixFQUFtQlYsVUFBL0IsRUFDQSxHQUFJZ0IsRUFBRWIsT0FBTixDQUFlLENBQ2JhLEVBQUVkLGdCQUFGLEVBQXNCYyxFQUFFZixRQUF4QixDQUNELENBRkQsSUFFTyxDQUNMYSxTQUFTRyxJQUFULENBQWNQLEtBQWQsRUFDRCxDQUNGLENBQ0YsQ0FJRCxHQUFJYixPQUFPcUIsTUFBWCxDQUFtQixDQUNqQixLQUFLdEIsTUFBTCxDQUFZZ0IsYUFBWixDQUEwQixVQUExQixDQUFzQyxZQUF0QyxDQUFvRCxDQUFDZixNQUFELENBQXBELEVBQ0QsQyxVQUVtQmlCLFEsMGVBQVRKLE0sTUFDVCxNQUFPLE1BQUtiLE1BQUwsQ0FBWWEsTUFBWixDQUFQLEMseUhBSU9TLFUsa0pBQ0osS0FBS3JCLGMsbUVBR0pzQixRLENBQVc3QixLLENBQ1g4QixZLENBQWVELFNBQVdELFUsQ0FDaEMsR0FBSSxLQUFLcEIsbUJBQUwsQ0FBMkJzQixZQUEzQixFQUEyQy9CLHVCQUEvQyxDQUF3RSxDQUN0RSxLQUFLTSxNQUFMLENBQVlnQixhQUFaLENBQTBCLFVBQTFCLENBQXNDLG1CQUF0QyxDQUEyRCxDQUN6RGxCLEtBQUtILEdBQUwsR0FBYThCLFlBRDRDLENBQTNELEVBR0QsQyxnSEFHdUIsQ0FDeEIsTUFBT0MsUUFBT0MsSUFBUCxDQUFZLEtBQUsxQixNQUFqQixFQUF5QnFCLE1BQXpCLEdBQW9DLENBQTNDLENBQ0QsQyw0Z0JBR1l2QixTIiwiZmlsZSI6IlJDVFRpbWluZy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQHByb3ZpZGVzTW9kdWxlIFJDVFRpbWluZ1xuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgUkNUQnJpZGdlLCB7XG4gIFJDVF9FWFBPUlRfTU9EVUxFLFxuICBSQ1RfRVhQT1JUX01FVEhPRCxcbiAgUkNURnVuY3Rpb25UeXBlTm9ybWFsXG59IGZyb20gXCJSQ1RCcmlkZ2VcIjtcblxudHlwZSBUaW1lciA9IHtcbiAgY2FsbGJhY2tJZDogbnVtYmVyLFxuICBkdXJhdGlvbjogbnVtYmVyLFxuICBqc1NjaGVkdWxpbmdUaW1lOiBudW1iZXIsXG4gIHJlcGVhdHM6IGJvb2xlYW5cbn07XG5cbmNvbnN0IElETEVfQ0FMTEJBQ0tfVEhSRVNIT0xEID0gMTsgLy8gTWluaW11bSBpZGxlIGV4ZWN1dGlvbiB0aW1lIG9mIDFtc1xuXG5mdW5jdGlvbiBub3coKSB7XG4gIHJldHVybiB3aW5kb3cucGVyZm9ybWFuY2UgPyBwZXJmb3JtYW5jZS5ub3coKSA6IERhdGUubm93KCk7XG59XG5cbkBSQ1RfRVhQT1JUX01PRFVMRShcIlJDVFRpbWluZ1wiKVxuY2xhc3MgUkNUVGltaW5nIHtcbiAgYnJpZGdlOiBSQ1RCcmlkZ2U7XG4gIHRpbWVyczogeyBbY2FsbGJhY2tJZDogc3RyaW5nXTogVGltZXIgfTtcbiAgc2VuZElkbGVFdmVudHM6IGJvb2xlYW47XG4gIHRhcmdldEZyYW1lRHVyYXRpb246IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihicmlkZ2U6IFJDVEJyaWRnZSkge1xuICAgIHRoaXMuYnJpZGdlID0gYnJpZGdlO1xuICAgIHRoaXMudGltZXJzID0ge307XG4gICAgdGhpcy5zZW5kSWRsZUV2ZW50cyA9IGZhbHNlO1xuICAgIHRoaXMudGFyZ2V0RnJhbWVEdXJhdGlvbiA9IDEwMDAuMCAvIDYwLjA7IC8vIDYwZnBzXG4gIH1cblxuICBAUkNUX0VYUE9SVF9NRVRIT0QoUkNURnVuY3Rpb25UeXBlTm9ybWFsKVxuICBjcmVhdGVUaW1lcihcbiAgICBjYWxsYmFja0lkOiBudW1iZXIsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgICBqc1NjaGVkdWxpbmdUaW1lOiBudW1iZXIsXG4gICAgcmVwZWF0czogYm9vbGVhblxuICApIHtcbiAgICBjb25zdCBjdXJyZW50VGltZU1pbGxpcyA9IG5vdygpO1xuICAgIGNvbnN0IGN1cnJlbnREYXRlTm93VGltZU1pbGxpcyA9IGpzU2NoZWR1bGluZ1RpbWUgKyAxMDAwIC8gNjA7XG4gICAgY29uc3QgYWRqdXN0ZWREdXJhdGlvbiA9IE1hdGgubWF4KFxuICAgICAgMC4wLFxuICAgICAganNTY2hlZHVsaW5nVGltZSAtIGN1cnJlbnREYXRlTm93VGltZU1pbGxpcyArIGR1cmF0aW9uXG4gICAgKTtcbiAgICBjb25zdCBpbml0aWFsVGFyZ2V0VGltZSA9IGN1cnJlbnRUaW1lTWlsbGlzICsgYWRqdXN0ZWREdXJhdGlvbjtcblxuICAgIGNvbnN0IHRpbWVyID0ge1xuICAgICAgY2FsbGJhY2tJZCxcbiAgICAgIGR1cmF0aW9uLFxuICAgICAganNTY2hlZHVsaW5nVGltZTogaW5pdGlhbFRhcmdldFRpbWUsXG4gICAgICByZXBlYXRzXG4gICAgfTtcblxuICAgIGlmIChhZGp1c3RlZER1cmF0aW9uID09PSAwKSB7XG4gICAgICBpZiAodGltZXIucmVwZWF0cykge1xuICAgICAgICB0aW1lci5qc1NjaGVkdWxpbmdUaW1lICs9IHRpbWVyLmR1cmF0aW9uO1xuICAgICAgICB0aGlzLnRpbWVyc1tTdHJpbmcoY2FsbGJhY2tJZCldID0gdGltZXI7XG4gICAgICB9XG4gICAgICB0aGlzLmJyaWRnZS5lbnF1ZXVlSlNDYWxsKFwiSlNUaW1lcnNcIiwgXCJjYWxsVGltZXJzXCIsIFtbY2FsbGJhY2tJZF1dKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aW1lcnNbU3RyaW5nKGNhbGxiYWNrSWQpXSA9IHRpbWVyO1xuICAgIH1cbiAgfVxuXG4gIEBSQ1RfRVhQT1JUX01FVEhPRChSQ1RGdW5jdGlvblR5cGVOb3JtYWwpXG4gIGRlbGV0ZVRpbWVyKGNhbGxiYWNrSWQ6IG51bWJlcikge1xuICAgIGRlbGV0ZSB0aGlzLnRpbWVyc1tTdHJpbmcoY2FsbGJhY2tJZCldO1xuICB9XG5cbiAgQFJDVF9FWFBPUlRfTUVUSE9EKFJDVEZ1bmN0aW9uVHlwZU5vcm1hbClcbiAgc2V0U2VuZElkbGVFdmVudHMoc2VuZElkbGU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnNlbmRJZGxlRXZlbnRzID0gc2VuZElkbGU7XG4gIH1cblxuICBhc3luYyBmcmFtZSgpIHtcbiAgICBjb25zdCB0b1JlbW92ZSA9IFtdO1xuICAgIGNvbnN0IHRpbWVycyA9IFtdO1xuICAgIGNvbnN0IHRpbWUgPSBub3coKTtcblxuICAgIGZvciAoY29uc3QgdGltZXIgaW4gdGhpcy50aW1lcnMpIHtcbiAgICAgIGNvbnN0IHQgPSB0aGlzLnRpbWVyc1t0aW1lcl07XG4gICAgICBpZiAodC5qc1NjaGVkdWxpbmdUaW1lIDw9IHRpbWUpIHtcbiAgICAgICAgdGltZXJzLnB1c2godGhpcy50aW1lcnNbdGltZXJdLmNhbGxiYWNrSWQpO1xuICAgICAgICBpZiAodC5yZXBlYXRzKSB7XG4gICAgICAgICAgdC5qc1NjaGVkdWxpbmdUaW1lICs9IHQuZHVyYXRpb247XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdG9SZW1vdmUucHVzaCh0aW1lcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB0aW1lciBpbmZvcm1hdGlvbiBpcyBkaXN0cmlidXRlZCBpbiBhIHNpbmdsZSBtZXNzYWdlIHdpdGggbXVsaXRpcGxlIHBhcmFtc1xuICAgIC8vIHdoaWNoIG1pbmltaXplcyB0aGUgYnJpZGdlIHRyYWZmaWMgd2hlbiBtYW55IHRpbWVycyBhcmUgdXNlZFxuICAgIGlmICh0aW1lcnMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmJyaWRnZS5lbnF1ZXVlSlNDYWxsKFwiSlNUaW1lcnNcIiwgXCJjYWxsVGltZXJzXCIsIFt0aW1lcnNdKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHRpbWVyIG9mIHRvUmVtb3ZlKSB7XG4gICAgICBkZWxldGUgdGhpcy50aW1lcnNbdGltZXJdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGlkbGUoZnJhbWVTdGFydDogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLnNlbmRJZGxlRXZlbnRzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGZyYW1lTm93ID0gbm93KCk7XG4gICAgY29uc3QgZnJhbWVFbGFwc2VkID0gZnJhbWVOb3cgLSBmcmFtZVN0YXJ0O1xuICAgIGlmICh0aGlzLnRhcmdldEZyYW1lRHVyYXRpb24gLSBmcmFtZUVsYXBzZWQgPj0gSURMRV9DQUxMQkFDS19USFJFU0hPTEQpIHtcbiAgICAgIHRoaXMuYnJpZGdlLmVucXVldWVKU0NhbGwoXCJKU1RpbWVyc1wiLCBcImNhbGxJZGxlQ2FsbGJhY2tzXCIsIFtcbiAgICAgICAgRGF0ZS5ub3coKSAtIGZyYW1lRWxhcHNlZFxuICAgICAgXSk7XG4gICAgfVxuICB9XG5cbiAgc2hvdWxkQ29udGludWUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMudGltZXJzKS5sZW5ndGggIT09IDA7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUkNUVGltaW5nO1xuIl19