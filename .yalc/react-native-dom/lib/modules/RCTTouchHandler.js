Object.defineProperty(exports,"__esModule",{value:true});var _extends2=require("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _detectIt=require("detect-it");var _detectIt2=_interopRequireDefault(_detectIt);var _Invariant=require("./../utils/Invariant");var _Invariant2=_interopRequireDefault(_Invariant);var _UIView=require("./../base/UIView");var _UIView2=_interopRequireDefault(_UIView);var _RCTEventDispatcher=require("./../bridge/RCTEventDispatcher");var _RCTEventDispatcher2=_interopRequireDefault(_RCTEventDispatcher);var _RCTTouchEvent=require("./RCTTouchEvent");var _RCTTouchEvent2=_interopRequireDefault(_RCTTouchEvent);var _Guid=require("./../utils/Guid");var _Guid2=_interopRequireDefault(_Guid);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var mouseTouchCounter=1;var TOUCH_LISTENER_OPTIONS=_detectIt2.default.passiveEvents?{passive:true,capture:false}:false;function getFirstParentUIView(target){while(target.parentElement){if(target instanceof _UIView2.default||target instanceof _UIView.UIChildContainerView){return target;}target=target.parentElement;}return target;}var RCTTouchHandler=function(){function RCTTouchHandler(bridge){var _this=this;(0,_classCallCheck3.default)(this,RCTTouchHandler);this.mouseClickBegan=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesBegan(touches);var view=_this.view;if(view){view.addEventListener("mouseup",_this.mouseClickEnded);view.addEventListener("mousemove",_this.mouseClickMoved);}};this.mouseClickMoved=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesMoved(touches);};this.mouseClickEnded=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesEnded(touches);var view=_this.view;if(view){view.removeEventListener("mouseup",_this.mouseClickEnded);view.removeEventListener("mousemove",_this.mouseClickMoved);}};this.nativeTouchBegan=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesBegan(touches);var view=_this.view;if(view){window.addEventListener("touchend",_this.nativeTouchEnded,TOUCH_LISTENER_OPTIONS);window.addEventListener("touchmove",_this.nativeTouchMoved,TOUCH_LISTENER_OPTIONS);window.addEventListener("touchcancel",_this.nativeTouchCanceled,TOUCH_LISTENER_OPTIONS);}return true;};this.nativeTouchMoved=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesMoved(touches);return true;};this.nativeTouchEnded=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesEnded(touches);var view=_this.view;if(view){_this.removeTouchEvents(view);}return true;};this.nativeTouchCanceled=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesCanceled(touches);var view=_this.view;if(view){_this.removeTouchEvents(view);}return true;};this.eventDispatcher=bridge.moduleForClass(_RCTEventDispatcher2.default);this.nativeTouches=[];this.nativeTouchesByIdentifier={};this.reactTouches=[];this.touchViews=[];}(0,_createClass3.default)(RCTTouchHandler,[{key:"attachToView",value:function attachToView(view){this.view=view;view.addGestureRecognizer(this,_detectIt2.default.deviceType,TOUCH_LISTENER_OPTIONS);}},{key:"detachFromView",value:function detachFromView(view){this.view=undefined;view.removeGestureRecognizer(this);}},{key:"recordNewTouches",value:function recordNewTouches(touches){var _this2=this;touches.forEach(function(touch){(0,_Invariant2.default)(!_this2.nativeTouchesByIdentifier.hasOwnProperty(touch.identifier),"Touch is already recorded. This is a critical bug");var targetView=touch.view;while(targetView){if(targetView===_this2.view)break;if(targetView.reactTag&&targetView.touchable)break;targetView=targetView.parentElement;}var reactTag=targetView.reactTag;var touchID=touch.identifier;var reactTouch={target:reactTag,identifier:touchID};_this2.touchViews.push(targetView);_this2.nativeTouches.push(touch);_this2.nativeTouchesByIdentifier[touchID]=touch;_this2.reactTouches.push(reactTouch);});}},{key:"recordRemovedTouches",value:function recordRemovedTouches(touches){for(var _iterator=touches,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var touch=_ref;var nativeTouch=this.nativeTouchesByIdentifier[touch.identifier];if(!nativeTouch){continue;}var index=this.nativeTouches.indexOf(nativeTouch);this.touchViews.splice(index,1);this.nativeTouches.splice(index,1);delete this.nativeTouchesByIdentifier[touch.identifier];this.reactTouches.splice(index,1);}}},{key:"updateReactTouch",value:function updateReactTouch(touchIndex,newTouch){var reactTouch=this.reactTouches[touchIndex];var updatedReactTouch=(0,_extends3.default)({},reactTouch,{pageX:newTouch.pageX,pageY:newTouch.pageY,locationX:newTouch.locationX,locationY:newTouch.locationY,timestamp:newTouch.timestamp});this.reactTouches[touchIndex]=updatedReactTouch;}},{key:"updateAndDispatchTouches",value:function updateAndDispatchTouches(touches,eventName){var changedIndexes=[];for(var _iterator2=touches,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var touch=_ref2;var nativeTouch=this.nativeTouchesByIdentifier[touch.identifier];if(!nativeTouch){console.log("updateAndDispatch failed");continue;}var index=this.nativeTouches.indexOf(nativeTouch);if(index===-1)continue;this.updateReactTouch(index,touch);changedIndexes.push(index);}if(changedIndexes.length===0){console.log("no changed Indexes");return;}var reactTouches=this.reactTouches.map(function(reactTouch){return(0,_extends3.default)({},reactTouch);});var canBeCoalesced=eventName==="touchMove";if(!canBeCoalesced){this.coalescingKey++;}(0,_Invariant2.default)(this.view,"attempting to send event to unknown view");var event=new _RCTTouchEvent2.default(eventName,this.view.reactTag,reactTouches,changedIndexes,this.coalescingKey);if(!canBeCoalesced){this.coalescingKey++;}this.eventDispatcher.sendEvent(event);}},{key:"removeTouchEvents",value:function removeTouchEvents(view){window.removeEventListener("touchend",this.nativeTouchEnded,TOUCH_LISTENER_OPTIONS);window.removeEventListener("touchmove",this.nativeTouchMoved,TOUCH_LISTENER_OPTIONS);window.removeEventListener("touchcancel",this.nativeTouchCanceled,TOUCH_LISTENER_OPTIONS);}},{key:"touchesBegan",value:function touchesBegan(touches){this.recordNewTouches(touches);this.updateAndDispatchTouches(touches,"touchStart");}},{key:"touchesMoved",value:function touchesMoved(touches){this.updateAndDispatchTouches(touches,"touchMove");}},{key:"touchesEnded",value:function touchesEnded(touches){this.updateAndDispatchTouches(touches,"touchEnd");this.recordRemovedTouches(touches);}},{key:"touchesCanceled",value:function touchesCanceled(touches){this.updateAndDispatchTouches(touches,"touchCancel");this.recordRemovedTouches(touches);}}],[{key:"RCTNormalizeInteractionEvent",value:function RCTNormalizeInteractionEvent(rawEvent){if(rawEvent instanceof MouseEvent){var _target=getFirstParentUIView(rawEvent.target);if("which"in rawEvent&&rawEvent.which===3){return null;}else if("button"in rawEvent&&rawEvent.button===2){return null;}return[{view:_target,identifier:0,pageX:rawEvent.pageX,pageY:rawEvent.pageY,locationX:rawEvent.clientX,locationY:rawEvent.clientY,timestamp:performance.now()}];}else if(rawEvent.changedTouches){var rawTouches=rawEvent.changedTouches;var resultingTouchList=[];for(var i=0;i<rawTouches.length;i++){var rawTouch=rawTouches[i];var _target2=getFirstParentUIView(rawTouch.target);var rect=_target2.getBoundingClientRect();resultingTouchList.push({view:_target2,identifier:rawTouch.identifier%20,pageX:rawTouch.clientX,pageY:rawTouch.clientY,locationX:rawTouch.pageX-rect.left,locationY:rawTouch.pageY-rect.top,timestamp:performance.now()});}return resultingTouchList;}console.error(rawEvent);throw new Error("Invalid Event");}}]);return RCTTouchHandler;}();exports.default=RCTTouchHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL1JlYWN0RG9tL21vZHVsZXMvUkNUVG91Y2hIYW5kbGVyLmpzIl0sIm5hbWVzIjpbIm1vdXNlVG91Y2hDb3VudGVyIiwiVE9VQ0hfTElTVEVORVJfT1BUSU9OUyIsInBhc3NpdmVFdmVudHMiLCJwYXNzaXZlIiwiY2FwdHVyZSIsImdldEZpcnN0UGFyZW50VUlWaWV3IiwidGFyZ2V0IiwicGFyZW50RWxlbWVudCIsIlJDVFRvdWNoSGFuZGxlciIsImJyaWRnZSIsIm1vdXNlQ2xpY2tCZWdhbiIsImV2ZW50IiwidG91Y2hlcyIsIlJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQiLCJ0b3VjaGVzQmVnYW4iLCJ2aWV3IiwiYWRkRXZlbnRMaXN0ZW5lciIsIm1vdXNlQ2xpY2tFbmRlZCIsIm1vdXNlQ2xpY2tNb3ZlZCIsInRvdWNoZXNNb3ZlZCIsInRvdWNoZXNFbmRlZCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJuYXRpdmVUb3VjaEJlZ2FuIiwid2luZG93IiwibmF0aXZlVG91Y2hFbmRlZCIsIm5hdGl2ZVRvdWNoTW92ZWQiLCJuYXRpdmVUb3VjaENhbmNlbGVkIiwicmVtb3ZlVG91Y2hFdmVudHMiLCJ0b3VjaGVzQ2FuY2VsZWQiLCJldmVudERpc3BhdGNoZXIiLCJtb2R1bGVGb3JDbGFzcyIsIm5hdGl2ZVRvdWNoZXMiLCJuYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyIiwicmVhY3RUb3VjaGVzIiwidG91Y2hWaWV3cyIsImFkZEdlc3R1cmVSZWNvZ25pemVyIiwiZGV2aWNlVHlwZSIsInVuZGVmaW5lZCIsInJlbW92ZUdlc3R1cmVSZWNvZ25pemVyIiwiZm9yRWFjaCIsInRvdWNoIiwiaGFzT3duUHJvcGVydHkiLCJpZGVudGlmaWVyIiwidGFyZ2V0VmlldyIsInJlYWN0VGFnIiwidG91Y2hhYmxlIiwidG91Y2hJRCIsInJlYWN0VG91Y2giLCJwdXNoIiwibmF0aXZlVG91Y2giLCJpbmRleCIsImluZGV4T2YiLCJzcGxpY2UiLCJ0b3VjaEluZGV4IiwibmV3VG91Y2giLCJ1cGRhdGVkUmVhY3RUb3VjaCIsInBhZ2VYIiwicGFnZVkiLCJsb2NhdGlvblgiLCJsb2NhdGlvblkiLCJ0aW1lc3RhbXAiLCJldmVudE5hbWUiLCJjaGFuZ2VkSW5kZXhlcyIsImNvbnNvbGUiLCJsb2ciLCJ1cGRhdGVSZWFjdFRvdWNoIiwibGVuZ3RoIiwibWFwIiwiY2FuQmVDb2FsZXNjZWQiLCJjb2FsZXNjaW5nS2V5Iiwic2VuZEV2ZW50IiwicmVjb3JkTmV3VG91Y2hlcyIsInVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyIsInJlY29yZFJlbW92ZWRUb3VjaGVzIiwicmF3RXZlbnQiLCJNb3VzZUV2ZW50Iiwid2hpY2giLCJidXR0b24iLCJjbGllbnRYIiwiY2xpZW50WSIsInBlcmZvcm1hbmNlIiwibm93IiwiY2hhbmdlZFRvdWNoZXMiLCJyYXdUb3VjaGVzIiwicmVzdWx0aW5nVG91Y2hMaXN0IiwiaSIsInJhd1RvdWNoIiwicmVjdCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsImxlZnQiLCJ0b3AiLCJlcnJvciIsIkVycm9yIl0sIm1hcHBpbmdzIjoiMFpBT0EsbUMsaURBRUEsK0MsbURBQ0Esd0MsNkNBQ0Esa0UscUVBQ0EsOEMsMkRBQ0EscUMsNEhBc0JBLEdBQUlBLG1CQUFvQixDQUF4QixDQUVBLEdBQU1DLHdCQUF5QixtQkFBU0MsYUFBVCxDQUMzQixDQUFFQyxRQUFTLElBQVgsQ0FBaUJDLFFBQVMsS0FBMUIsQ0FEMkIsQ0FFM0IsS0FGSixDQUlBLFFBQVNDLHFCQUFULENBQThCQyxNQUE5QixDQUEyQyxDQUN6QyxNQUFPQSxPQUFPQyxhQUFkLENBQTZCLENBQzNCLEdBQUlELG9DQUE0QkEsOENBQWhDLENBQXdFLENBQ3RFLE1BQU9BLE9BQVAsQ0FDRCxDQUNEQSxPQUFTQSxPQUFPQyxhQUFoQixDQUNELENBQ0QsTUFBT0QsT0FBUCxDQUNELEMsR0FFS0UsZ0IsWUFXSix5QkFBWUMsTUFBWixDQUErQix3RUErTC9CQyxlQS9MK0IsQ0ErTGIsU0FBQ0MsS0FBRCxDQUF1QixDQUN2QyxHQUFNQyxTQUFVSixnQkFBZ0JLLDRCQUFoQixDQUE2Q0YsS0FBN0MsQ0FBaEIsQ0FDQSxHQUFJLENBQUNDLE9BQUwsQ0FBYyxPQUVkLE1BQUtFLFlBQUwsQ0FBa0JGLE9BQWxCLEVBRUEsR0FBTUcsTUFBTyxNQUFLQSxJQUFsQixDQUNBLEdBQUlBLElBQUosQ0FBVSxDQUNSQSxLQUFLQyxnQkFBTCxDQUFzQixTQUF0QixDQUFpQyxNQUFLQyxlQUF0QyxFQUNBRixLQUFLQyxnQkFBTCxDQUFzQixXQUF0QixDQUFtQyxNQUFLRSxlQUF4QyxFQUNELENBQ0YsQ0ExTThCLE1BNE0vQkEsZUE1TStCLENBNE1iLFNBQUNQLEtBQUQsQ0FBdUIsQ0FDdkMsR0FBTUMsU0FBVUosZ0JBQWdCSyw0QkFBaEIsQ0FBNkNGLEtBQTdDLENBQWhCLENBQ0EsR0FBSSxDQUFDQyxPQUFMLENBQWMsT0FFZCxNQUFLTyxZQUFMLENBQWtCUCxPQUFsQixFQUNELENBak44QixNQW1OL0JLLGVBbk4rQixDQW1OYixTQUFDTixLQUFELENBQXVCLENBQ3ZDLEdBQU1DLFNBQVVKLGdCQUFnQkssNEJBQWhCLENBQTZDRixLQUE3QyxDQUFoQixDQUNBLEdBQUksQ0FBQ0MsT0FBTCxDQUFjLE9BRWQsTUFBS1EsWUFBTCxDQUFrQlIsT0FBbEIsRUFFQSxHQUFNRyxNQUFPLE1BQUtBLElBQWxCLENBQ0EsR0FBSUEsSUFBSixDQUFVLENBQ1JBLEtBQUtNLG1CQUFMLENBQXlCLFNBQXpCLENBQW9DLE1BQUtKLGVBQXpDLEVBQ0FGLEtBQUtNLG1CQUFMLENBQXlCLFdBQXpCLENBQXNDLE1BQUtILGVBQTNDLEVBQ0QsQ0FDRixDQTlOOEIsTUFnTy9CSSxnQkFoTytCLENBZ09aLFNBQUNYLEtBQUQsQ0FBdUIsQ0FDeEMsR0FBTUMsU0FBVUosZ0JBQWdCSyw0QkFBaEIsQ0FBNkNGLEtBQTdDLENBQWhCLENBQ0EsR0FBSSxDQUFDQyxPQUFMLENBQWMsT0FFZCxNQUFLRSxZQUFMLENBQWtCRixPQUFsQixFQUVBLEdBQU1HLE1BQU8sTUFBS0EsSUFBbEIsQ0FDQSxHQUFJQSxJQUFKLENBQVUsQ0FDUlEsT0FBT1AsZ0JBQVAsQ0FDRSxVQURGLENBRUUsTUFBS1EsZ0JBRlAsQ0FHRXZCLHNCQUhGLEVBS0FzQixPQUFPUCxnQkFBUCxDQUNFLFdBREYsQ0FFRSxNQUFLUyxnQkFGUCxDQUdFeEIsc0JBSEYsRUFLQXNCLE9BQU9QLGdCQUFQLENBQ0UsYUFERixDQUVFLE1BQUtVLG1CQUZQLENBR0V6QixzQkFIRixFQUtELENBRUQsTUFBTyxLQUFQLENBQ0QsQ0ExUDhCLE1BNFAvQndCLGdCQTVQK0IsQ0E0UFosU0FBQ2QsS0FBRCxDQUF1QixDQUN4QyxHQUFNQyxTQUFVSixnQkFBZ0JLLDRCQUFoQixDQUE2Q0YsS0FBN0MsQ0FBaEIsQ0FDQSxHQUFJLENBQUNDLE9BQUwsQ0FBYyxPQUVkLE1BQUtPLFlBQUwsQ0FBa0JQLE9BQWxCLEVBRUEsTUFBTyxLQUFQLENBQ0QsQ0FuUThCLE1BcVEvQlksZ0JBclErQixDQXFRWixTQUFDYixLQUFELENBQXVCLENBQ3hDLEdBQU1DLFNBQVVKLGdCQUFnQkssNEJBQWhCLENBQTZDRixLQUE3QyxDQUFoQixDQUNBLEdBQUksQ0FBQ0MsT0FBTCxDQUFjLE9BRWQsTUFBS1EsWUFBTCxDQUFrQlIsT0FBbEIsRUFFQSxHQUFNRyxNQUFPLE1BQUtBLElBQWxCLENBQ0EsR0FBSUEsSUFBSixDQUFVLENBQ1IsTUFBS1ksaUJBQUwsQ0FBdUJaLElBQXZCLEVBQ0QsQ0FFRCxNQUFPLEtBQVAsQ0FDRCxDQWpSOEIsTUFxUy9CVyxtQkFyUytCLENBcVNULFNBQUNmLEtBQUQsQ0FBdUIsQ0FDM0MsR0FBTUMsU0FBVUosZ0JBQWdCSyw0QkFBaEIsQ0FBNkNGLEtBQTdDLENBQWhCLENBQ0EsR0FBSSxDQUFDQyxPQUFMLENBQWMsT0FFZCxNQUFLZ0IsZUFBTCxDQUFxQmhCLE9BQXJCLEVBRUEsR0FBTUcsTUFBTyxNQUFLQSxJQUFsQixDQUNBLEdBQUlBLElBQUosQ0FBVSxDQUNSLE1BQUtZLGlCQUFMLENBQXVCWixJQUF2QixFQUNELENBRUQsTUFBTyxLQUFQLENBQ0QsQ0FqVDhCLENBQzdCLEtBQUtjLGVBQUwsQ0FBd0JwQixPQUFPcUIsY0FBUCw4QkFBeEIsQ0FJQSxLQUFLQyxhQUFMLENBQXFCLEVBQXJCLENBQ0EsS0FBS0MseUJBQUwsQ0FBaUMsRUFBakMsQ0FDQSxLQUFLQyxZQUFMLENBQW9CLEVBQXBCLENBQ0EsS0FBS0MsVUFBTCxDQUFrQixFQUFsQixDQUNELEMsMkZBcURZbkIsSSxDQUFjLENBQ3pCLEtBQUtBLElBQUwsQ0FBWUEsSUFBWixDQUNBQSxLQUFLb0Isb0JBQUwsQ0FDRSxJQURGLENBRUUsbUJBQVNDLFVBRlgsQ0FHRW5DLHNCQUhGLEVBS0QsQyxzREFFY2MsSSxDQUFjLENBQzNCLEtBQUtBLElBQUwsQ0FBWXNCLFNBQVosQ0FDQXRCLEtBQUt1Qix1QkFBTCxDQUE2QixJQUE3QixFQUNELEMsMERBRWdCMUIsTyxDQUF5QixpQkFDeENBLFFBQVEyQixPQUFSLENBQWdCLFNBQUNDLEtBQUQsQ0FBVyxDQUN6Qix3QkFDRSxDQUFDLE9BQUtSLHlCQUFMLENBQStCUyxjQUEvQixDQUE4Q0QsTUFBTUUsVUFBcEQsQ0FESCxDQUVFLG1EQUZGLEVBTUEsR0FBSUMsWUFBY0gsTUFBTXpCLElBQXhCLENBQ0EsTUFBTzRCLFVBQVAsQ0FBbUIsQ0FDakIsR0FBSUEsYUFBZSxPQUFLNUIsSUFBeEIsQ0FBOEIsTUFDOUIsR0FBSTRCLFdBQVdDLFFBQVgsRUFBdUJELFdBQVdFLFNBQXRDLENBQWlELE1BQ2pERixXQUFhQSxXQUFXcEMsYUFBeEIsQ0FDRCxDQUVELEdBQU1xQyxVQUFXRCxXQUFXQyxRQUE1QixDQUNBLEdBQU1FLFNBQVVOLE1BQU1FLFVBQXRCLENBR0EsR0FBTUssWUFBYSxDQUNqQnpDLE9BQVFzQyxRQURTLENBRWpCRixXQUFZSSxPQUZLLENBQW5CLENBTUEsT0FBS1osVUFBTCxDQUFnQmMsSUFBaEIsQ0FBcUJMLFVBQXJCLEVBQ0EsT0FBS1osYUFBTCxDQUFtQmlCLElBQW5CLENBQXdCUixLQUF4QixFQUNBLE9BQUtSLHlCQUFMLENBQStCYyxPQUEvQixFQUEwQ04sS0FBMUMsQ0FDQSxPQUFLUCxZQUFMLENBQWtCZSxJQUFsQixDQUF1QkQsVUFBdkIsRUFDRCxDQTVCRCxFQTZCRCxDLGtFQUVvQm5DLE8sQ0FBeUIsQ0FDNUMsa0JBQWtCQSxPQUFsQiw0SUFBMkIsdUlBQWxCNEIsTUFBa0IsTUFDekIsR0FBTVMsYUFBYyxLQUFLakIseUJBQUwsQ0FBK0JRLE1BQU1FLFVBQXJDLENBQXBCLENBRUEsR0FBSSxDQUFDTyxXQUFMLENBQWtCLENBQ2hCLFNBQ0QsQ0FFRCxHQUFNQyxPQUFRLEtBQUtuQixhQUFMLENBQW1Cb0IsT0FBbkIsQ0FBMkJGLFdBQTNCLENBQWQsQ0FFQSxLQUFLZixVQUFMLENBQWdCa0IsTUFBaEIsQ0FBdUJGLEtBQXZCLENBQThCLENBQTlCLEVBQ0EsS0FBS25CLGFBQUwsQ0FBbUJxQixNQUFuQixDQUEwQkYsS0FBMUIsQ0FBaUMsQ0FBakMsRUFDQSxNQUFPLE1BQUtsQix5QkFBTCxDQUErQlEsTUFBTUUsVUFBckMsQ0FBUCxDQUNBLEtBQUtULFlBQUwsQ0FBa0JtQixNQUFsQixDQUF5QkYsS0FBekIsQ0FBZ0MsQ0FBaEMsRUFDRCxDQUNGLEMsMERBRWdCRyxVLENBQW9CQyxRLENBQW1CLENBQ3RELEdBQU1QLFlBQWEsS0FBS2QsWUFBTCxDQUFrQm9CLFVBQWxCLENBQW5CLENBRUEsR0FBTUUsNENBQ0RSLFVBREMsRUFFSlMsTUFBT0YsU0FBU0UsS0FGWixDQUdKQyxNQUFPSCxTQUFTRyxLQUhaLENBSUpDLFVBQVdKLFNBQVNJLFNBSmhCLENBS0pDLFVBQVdMLFNBQVNLLFNBTGhCLENBTUpDLFVBQVdOLFNBQVNNLFNBTmhCLEVBQU4sQ0FXQSxLQUFLM0IsWUFBTCxDQUFrQm9CLFVBQWxCLEVBQWdDRSxpQkFBaEMsQ0FDRCxDLDBFQUV3QjNDLE8sQ0FBeUJpRCxTLENBQW1CLENBQ25FLEdBQU1DLGdCQUFpQixFQUF2QixDQUNBLG1CQUFrQmxELE9BQWxCLG1KQUEyQixtSkFBbEI0QixNQUFrQixPQUN6QixHQUFNUyxhQUFjLEtBQUtqQix5QkFBTCxDQUErQlEsTUFBTUUsVUFBckMsQ0FBcEIsQ0FDQSxHQUFJLENBQUNPLFdBQUwsQ0FBa0IsQ0FDaEJjLFFBQVFDLEdBQVIsQ0FBWSwwQkFBWixFQUNBLFNBQ0QsQ0FFRCxHQUFNZCxPQUFRLEtBQUtuQixhQUFMLENBQW1Cb0IsT0FBbkIsQ0FBMkJGLFdBQTNCLENBQWQsQ0FFQSxHQUFJQyxRQUFVLENBQUMsQ0FBZixDQUFrQixTQUVsQixLQUFLZSxnQkFBTCxDQUFzQmYsS0FBdEIsQ0FBNkJWLEtBQTdCLEVBQ0FzQixlQUFlZCxJQUFmLENBQW9CRSxLQUFwQixFQUNELENBRUQsR0FBSVksZUFBZUksTUFBZixHQUEwQixDQUE5QixDQUFpQyxDQUMvQkgsUUFBUUMsR0FBUixDQUFZLG9CQUFaLEVBQ0EsT0FDRCxDQUVELEdBQU0vQixjQUFlLEtBQUtBLFlBQUwsQ0FBa0JrQyxHQUFsQixDQUFzQixTQUFDcEIsVUFBRCxpQ0FDdENBLFVBRHNDLEdBQXRCLENBQXJCLENBSUEsR0FBTXFCLGdCQUFpQlAsWUFBYyxXQUFyQyxDQUVBLEdBQUksQ0FBQ08sY0FBTCxDQUFxQixDQUNuQixLQUFLQyxhQUFMLEdBQ0QsQ0FFRCx3QkFBVSxLQUFLdEQsSUFBZixDQUFxQiwwQ0FBckIsRUFFQSxHQUFNSixPQUFRLDRCQUNaa0QsU0FEWSxDQUVaLEtBQUs5QyxJQUFMLENBQVU2QixRQUZFLENBR1pYLFlBSFksQ0FJWjZCLGNBSlksQ0FLWixLQUFLTyxhQUxPLENBQWQsQ0FRQSxHQUFJLENBQUNELGNBQUwsQ0FBcUIsQ0FDbkIsS0FBS0MsYUFBTCxHQUNELENBRUQsS0FBS3hDLGVBQUwsQ0FBcUJ5QyxTQUFyQixDQUErQjNELEtBQS9CLEVBQ0QsQyw0REFzRmlCSSxJLENBQWMsQ0FDOUJRLE9BQU9GLG1CQUFQLENBQ0UsVUFERixDQUVFLEtBQUtHLGdCQUZQLENBR0V2QixzQkFIRixFQUtBc0IsT0FBT0YsbUJBQVAsQ0FDRSxXQURGLENBRUUsS0FBS0ksZ0JBRlAsQ0FHRXhCLHNCQUhGLEVBS0FzQixPQUFPRixtQkFBUCxDQUNFLGFBREYsQ0FFRSxLQUFLSyxtQkFGUCxDQUdFekIsc0JBSEYsRUFLRCxDLGtEQWdCWVcsTyxDQUF5QixDQUNwQyxLQUFLMkQsZ0JBQUwsQ0FBc0IzRCxPQUF0QixFQUNBLEtBQUs0RCx3QkFBTCxDQUE4QjVELE9BQTlCLENBQXVDLFlBQXZDLEVBQ0QsQyxrREFFWUEsTyxDQUF5QixDQUNwQyxLQUFLNEQsd0JBQUwsQ0FBOEI1RCxPQUE5QixDQUF1QyxXQUF2QyxFQUNELEMsa0RBRVlBLE8sQ0FBeUIsQ0FDcEMsS0FBSzRELHdCQUFMLENBQThCNUQsT0FBOUIsQ0FBdUMsVUFBdkMsRUFDQSxLQUFLNkQsb0JBQUwsQ0FBMEI3RCxPQUExQixFQUNELEMsd0RBRWVBLE8sQ0FBeUIsQ0FDdkMsS0FBSzRELHdCQUFMLENBQThCNUQsT0FBOUIsQ0FBdUMsYUFBdkMsRUFDQSxLQUFLNkQsb0JBQUwsQ0FBMEI3RCxPQUExQixFQUNELEMsb0ZBeFRDOEQsUSxDQUNpQixDQUNqQixHQUFJQSxtQkFBb0JDLFdBQXhCLENBQW9DLENBQ2xDLEdBQU1yRSxTQUFpQkQscUJBQXFCcUUsU0FBU3BFLE1BQTlCLENBQXZCLENBRUEsR0FBSSxTQUFXb0UsU0FBWCxFQUF1QkEsU0FBU0UsS0FBVCxHQUFtQixDQUE5QyxDQUFpRCxDQUMvQyxNQUFPLEtBQVAsQ0FDRCxDQUZELElBRU8sSUFBSSxVQUFZRixTQUFaLEVBQXdCQSxTQUFTRyxNQUFULEdBQW9CLENBQWhELENBQW1ELENBQ3hELE1BQU8sS0FBUCxDQUNELENBRUQsTUFBTyxDQUNMLENBQ0U5RCxLQUFNVCxPQURSLENBRUVvQyxXQUFZLENBRmQsQ0FHRWMsTUFBT2tCLFNBQVNsQixLQUhsQixDQUlFQyxNQUFPaUIsU0FBU2pCLEtBSmxCLENBS0VDLFVBQVdnQixTQUFTSSxPQUx0QixDQU1FbkIsVUFBV2UsU0FBU0ssT0FOdEIsQ0FPRW5CLFVBQVdvQixZQUFZQyxHQUFaLEVBUGIsQ0FESyxDQUFQLENBV0QsQ0FwQkQsSUFvQk8sSUFBSVAsU0FBU1EsY0FBYixDQUE2QixDQUNsQyxHQUFNQyxZQUFhVCxTQUFTUSxjQUE1QixDQUNBLEdBQU1FLG9CQUFxQixFQUEzQixDQUVBLElBQUssR0FBSUMsR0FBSSxDQUFiLENBQWdCQSxFQUFJRixXQUFXakIsTUFBL0IsQ0FBdUNtQixHQUF2QyxDQUE0QyxDQUMxQyxHQUFNQyxVQUFXSCxXQUFXRSxDQUFYLENBQWpCLENBQ0EsR0FBTS9FLFVBQWlCRCxxQkFBcUJpRixTQUFTaEYsTUFBOUIsQ0FBdkIsQ0FFQSxHQUFNaUYsTUFBT2pGLFNBQU9rRixxQkFBUCxFQUFiLENBRUFKLG1CQUFtQnBDLElBQW5CLENBQXdCLENBQ3RCakMsS0FBTVQsUUFEZ0IsQ0FFdEJvQyxXQUFZNEMsU0FBUzVDLFVBQVQsQ0FBc0IsRUFGWixDQUd0QmMsTUFBTzhCLFNBQVNSLE9BSE0sQ0FJdEJyQixNQUFPNkIsU0FBU1AsT0FKTSxDQUt0QnJCLFVBQVc0QixTQUFTOUIsS0FBVCxDQUFpQitCLEtBQUtFLElBTFgsQ0FNdEI5QixVQUFXMkIsU0FBUzdCLEtBQVQsQ0FBaUI4QixLQUFLRyxHQU5YLENBT3RCOUIsVUFBV29CLFlBQVlDLEdBQVosRUFQVyxDQUF4QixFQVNELENBRUQsTUFBT0csbUJBQVAsQ0FDRCxDQUVEckIsUUFBUTRCLEtBQVIsQ0FBY2pCLFFBQWQsRUFDQSxLQUFNLElBQUlrQixNQUFKLENBQVUsZUFBVixDQUFOLENBQ0QsQywrQ0EyUVlwRixlIiwiZmlsZSI6IlJDVFRvdWNoSGFuZGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQHByb3ZpZGVzTW9kdWxlIFJDVFRvdWNoSGFuZGxlclxuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgdHlwZSBSQ1RCcmlkZ2UgZnJvbSBcIlJDVEJyaWRnZVwiO1xuXG5pbXBvcnQgZGV0ZWN0SXQgZnJvbSBcImRldGVjdC1pdFwiO1xuXG5pbXBvcnQgaW52YXJpYW50IGZyb20gXCJJbnZhcmlhbnRcIjtcbmltcG9ydCBVSVZpZXcsIHsgVUlDaGlsZENvbnRhaW5lclZpZXcgfSBmcm9tIFwiVUlWaWV3XCI7XG5pbXBvcnQgUkNURXZlbnREaXNwYXRjaGVyIGZyb20gXCJSQ1RFdmVudERpc3BhdGNoZXJcIjtcbmltcG9ydCBSQ1RUb3VjaEV2ZW50IGZyb20gXCJSQ1RUb3VjaEV2ZW50XCI7XG5pbXBvcnQgZ3VpZCBmcm9tIFwiR3VpZFwiO1xuXG50eXBlIFVJVG91Y2ggPSB7XG4gIHZpZXc6IFVJVmlldyB8IFVJQ2hpbGRDb250YWluZXJWaWV3LFxuICBpZGVudGlmaWVyOiBudW1iZXIsXG4gIHBhZ2VYOiBudW1iZXIsXG4gIHBhZ2VZOiBudW1iZXIsXG4gIGxvY2F0aW9uWDogbnVtYmVyLFxuICBsb2NhdGlvblk6IG51bWJlcixcbiAgdGltZXN0YW1wOiBudW1iZXJcbn07XG5cbnR5cGUgUmVhY3RUb3VjaCA9IHtcbiAgdGFyZ2V0OiBudW1iZXIsXG4gIGlkZW50aWZpZXI6IG51bWJlcixcbiAgcGFnZVg/OiBudW1iZXIsXG4gIHBhZ2VZPzogbnVtYmVyLFxuICBsb2NhdGlvblg/OiBudW1iZXIsXG4gIGxvY2F0aW9uWT86IG51bWJlcixcbiAgdGltZXN0YW1wPzogbnVtYmVyXG59O1xuXG5sZXQgbW91c2VUb3VjaENvdW50ZXIgPSAxO1xuXG5jb25zdCBUT1VDSF9MSVNURU5FUl9PUFRJT05TID0gZGV0ZWN0SXQucGFzc2l2ZUV2ZW50c1xuICA/IHsgcGFzc2l2ZTogdHJ1ZSwgY2FwdHVyZTogZmFsc2UgfVxuICA6IGZhbHNlO1xuXG5mdW5jdGlvbiBnZXRGaXJzdFBhcmVudFVJVmlldyh0YXJnZXQ6IGFueSkge1xuICB3aGlsZSAodGFyZ2V0LnBhcmVudEVsZW1lbnQpIHtcbiAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgVUlWaWV3IHx8IHRhcmdldCBpbnN0YW5jZW9mIFVJQ2hpbGRDb250YWluZXJWaWV3KSB7XG4gICAgICByZXR1cm4gdGFyZ2V0O1xuICAgIH1cbiAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50RWxlbWVudDtcbiAgfVxuICByZXR1cm4gdGFyZ2V0O1xufVxuXG5jbGFzcyBSQ1RUb3VjaEhhbmRsZXIge1xuICBldmVudERpc3BhdGNoZXI6IFJDVEV2ZW50RGlzcGF0Y2hlcjtcblxuICBuYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyOiB7IFtudW1iZXJdOiBVSVRvdWNoIH07XG4gIG5hdGl2ZVRvdWNoZXM6IEFycmF5PFVJVG91Y2g+O1xuICByZWFjdFRvdWNoZXM6IEFycmF5PFJlYWN0VG91Y2g+O1xuICB0b3VjaFZpZXdzOiBBcnJheTxVSVZpZXc+O1xuICBjb2FsZXNjaW5nS2V5OiBudW1iZXI7XG5cbiAgdmlldzogP1VJVmlldztcblxuICBjb25zdHJ1Y3RvcihicmlkZ2U6IFJDVEJyaWRnZSkge1xuICAgIHRoaXMuZXZlbnREaXNwYXRjaGVyID0gKGJyaWRnZS5tb2R1bGVGb3JDbGFzcyhcbiAgICAgIChSQ1RFdmVudERpc3BhdGNoZXI6IGFueSlcbiAgICApOiBhbnkpO1xuXG4gICAgdGhpcy5uYXRpdmVUb3VjaGVzID0gW107XG4gICAgdGhpcy5uYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyID0ge307XG4gICAgdGhpcy5yZWFjdFRvdWNoZXMgPSBbXTtcbiAgICB0aGlzLnRvdWNoVmlld3MgPSBbXTtcbiAgfVxuXG4gIHN0YXRpYyBSQ1ROb3JtYWxpemVJbnRlcmFjdGlvbkV2ZW50KFxuICAgIHJhd0V2ZW50OiBUb3VjaEV2ZW50IHwgTW91c2VFdmVudFxuICApOiA/QXJyYXk8VUlUb3VjaD4ge1xuICAgIGlmIChyYXdFdmVudCBpbnN0YW5jZW9mIE1vdXNlRXZlbnQpIHtcbiAgICAgIGNvbnN0IHRhcmdldDogVUlWaWV3ID0gZ2V0Rmlyc3RQYXJlbnRVSVZpZXcocmF3RXZlbnQudGFyZ2V0KTtcblxuICAgICAgaWYgKFwid2hpY2hcIiBpbiByYXdFdmVudCAmJiByYXdFdmVudC53aGljaCA9PT0gMykge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH0gZWxzZSBpZiAoXCJidXR0b25cIiBpbiByYXdFdmVudCAmJiByYXdFdmVudC5idXR0b24gPT09IDIpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBbXG4gICAgICAgIHtcbiAgICAgICAgICB2aWV3OiB0YXJnZXQsXG4gICAgICAgICAgaWRlbnRpZmllcjogMCxcbiAgICAgICAgICBwYWdlWDogcmF3RXZlbnQucGFnZVgsXG4gICAgICAgICAgcGFnZVk6IHJhd0V2ZW50LnBhZ2VZLFxuICAgICAgICAgIGxvY2F0aW9uWDogcmF3RXZlbnQuY2xpZW50WCxcbiAgICAgICAgICBsb2NhdGlvblk6IHJhd0V2ZW50LmNsaWVudFksXG4gICAgICAgICAgdGltZXN0YW1wOiBwZXJmb3JtYW5jZS5ub3coKVxuICAgICAgICB9XG4gICAgICBdO1xuICAgIH0gZWxzZSBpZiAocmF3RXZlbnQuY2hhbmdlZFRvdWNoZXMpIHtcbiAgICAgIGNvbnN0IHJhd1RvdWNoZXMgPSByYXdFdmVudC5jaGFuZ2VkVG91Y2hlcztcbiAgICAgIGNvbnN0IHJlc3VsdGluZ1RvdWNoTGlzdCA9IFtdO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJhd1RvdWNoZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgcmF3VG91Y2ggPSByYXdUb3VjaGVzW2ldO1xuICAgICAgICBjb25zdCB0YXJnZXQ6IFVJVmlldyA9IGdldEZpcnN0UGFyZW50VUlWaWV3KHJhd1RvdWNoLnRhcmdldCk7XG5cbiAgICAgICAgY29uc3QgcmVjdCA9IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICByZXN1bHRpbmdUb3VjaExpc3QucHVzaCh7XG4gICAgICAgICAgdmlldzogdGFyZ2V0LFxuICAgICAgICAgIGlkZW50aWZpZXI6IHJhd1RvdWNoLmlkZW50aWZpZXIgJSAyMCxcbiAgICAgICAgICBwYWdlWDogcmF3VG91Y2guY2xpZW50WCxcbiAgICAgICAgICBwYWdlWTogcmF3VG91Y2guY2xpZW50WSxcbiAgICAgICAgICBsb2NhdGlvblg6IHJhd1RvdWNoLnBhZ2VYIC0gcmVjdC5sZWZ0LFxuICAgICAgICAgIGxvY2F0aW9uWTogcmF3VG91Y2gucGFnZVkgLSByZWN0LnRvcCxcbiAgICAgICAgICB0aW1lc3RhbXA6IHBlcmZvcm1hbmNlLm5vdygpXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0aW5nVG91Y2hMaXN0O1xuICAgIH1cblxuICAgIGNvbnNvbGUuZXJyb3IocmF3RXZlbnQpO1xuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgRXZlbnRcIik7XG4gIH1cblxuICBhdHRhY2hUb1ZpZXcodmlldzogVUlWaWV3KSB7XG4gICAgdGhpcy52aWV3ID0gdmlldztcbiAgICB2aWV3LmFkZEdlc3R1cmVSZWNvZ25pemVyKFxuICAgICAgdGhpcyxcbiAgICAgIGRldGVjdEl0LmRldmljZVR5cGUsXG4gICAgICBUT1VDSF9MSVNURU5FUl9PUFRJT05TXG4gICAgKTtcbiAgfVxuXG4gIGRldGFjaEZyb21WaWV3KHZpZXc6IFVJVmlldykge1xuICAgIHRoaXMudmlldyA9IHVuZGVmaW5lZDtcbiAgICB2aWV3LnJlbW92ZUdlc3R1cmVSZWNvZ25pemVyKHRoaXMpO1xuICB9XG5cbiAgcmVjb3JkTmV3VG91Y2hlcyh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRvdWNoZXMuZm9yRWFjaCgodG91Y2gpID0+IHtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgIXRoaXMubmF0aXZlVG91Y2hlc0J5SWRlbnRpZmllci5oYXNPd25Qcm9wZXJ0eSh0b3VjaC5pZGVudGlmaWVyKSxcbiAgICAgICAgXCJUb3VjaCBpcyBhbHJlYWR5IHJlY29yZGVkLiBUaGlzIGlzIGEgY3JpdGljYWwgYnVnXCJcbiAgICAgICk7XG5cbiAgICAgIC8vIEZpbmQgY2xvc2VzdCBSZWFjdC1tYW5hZ2VkIHRvdWNoYWJsZSBlbGVtZW50XG4gICAgICBsZXQgdGFyZ2V0VmlldyA9ICh0b3VjaC52aWV3OiBhbnkpO1xuICAgICAgd2hpbGUgKHRhcmdldFZpZXcpIHtcbiAgICAgICAgaWYgKHRhcmdldFZpZXcgPT09IHRoaXMudmlldykgYnJlYWs7XG4gICAgICAgIGlmICh0YXJnZXRWaWV3LnJlYWN0VGFnICYmIHRhcmdldFZpZXcudG91Y2hhYmxlKSBicmVhaztcbiAgICAgICAgdGFyZ2V0VmlldyA9IHRhcmdldFZpZXcucGFyZW50RWxlbWVudDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVhY3RUYWcgPSB0YXJnZXRWaWV3LnJlYWN0VGFnO1xuICAgICAgY29uc3QgdG91Y2hJRCA9IHRvdWNoLmlkZW50aWZpZXI7XG5cbiAgICAgIC8vIENyZWF0ZSB0b3VjaFxuICAgICAgY29uc3QgcmVhY3RUb3VjaCA9IHtcbiAgICAgICAgdGFyZ2V0OiByZWFjdFRhZyxcbiAgICAgICAgaWRlbnRpZmllcjogdG91Y2hJRFxuICAgICAgfTtcblxuICAgICAgLy8gQWRkIHRvIGFycmF5c1xuICAgICAgdGhpcy50b3VjaFZpZXdzLnB1c2godGFyZ2V0Vmlldyk7XG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoZXMucHVzaCh0b3VjaCk7XG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoZXNCeUlkZW50aWZpZXJbdG91Y2hJRF0gPSB0b3VjaDtcbiAgICAgIHRoaXMucmVhY3RUb3VjaGVzLnB1c2gocmVhY3RUb3VjaCk7XG4gICAgfSk7XG4gIH1cblxuICByZWNvcmRSZW1vdmVkVG91Y2hlcyh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIGZvciAobGV0IHRvdWNoIG9mIHRvdWNoZXMpIHtcbiAgICAgIGNvbnN0IG5hdGl2ZVRvdWNoID0gdGhpcy5uYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyW3RvdWNoLmlkZW50aWZpZXJdO1xuXG4gICAgICBpZiAoIW5hdGl2ZVRvdWNoKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMubmF0aXZlVG91Y2hlcy5pbmRleE9mKG5hdGl2ZVRvdWNoKTtcblxuICAgICAgdGhpcy50b3VjaFZpZXdzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIGRlbGV0ZSB0aGlzLm5hdGl2ZVRvdWNoZXNCeUlkZW50aWZpZXJbdG91Y2guaWRlbnRpZmllcl07XG4gICAgICB0aGlzLnJlYWN0VG91Y2hlcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVJlYWN0VG91Y2godG91Y2hJbmRleDogbnVtYmVyLCBuZXdUb3VjaDogVUlUb3VjaCkge1xuICAgIGNvbnN0IHJlYWN0VG91Y2ggPSB0aGlzLnJlYWN0VG91Y2hlc1t0b3VjaEluZGV4XTtcblxuICAgIGNvbnN0IHVwZGF0ZWRSZWFjdFRvdWNoID0ge1xuICAgICAgLi4ucmVhY3RUb3VjaCxcbiAgICAgIHBhZ2VYOiBuZXdUb3VjaC5wYWdlWCxcbiAgICAgIHBhZ2VZOiBuZXdUb3VjaC5wYWdlWSxcbiAgICAgIGxvY2F0aW9uWDogbmV3VG91Y2gubG9jYXRpb25YLFxuICAgICAgbG9jYXRpb25ZOiBuZXdUb3VjaC5sb2NhdGlvblksXG4gICAgICB0aW1lc3RhbXA6IG5ld1RvdWNoLnRpbWVzdGFtcFxuICAgIH07XG5cbiAgICAvLyBUT0RPOiBmb3JjZSB0b3VjaFxuXG4gICAgdGhpcy5yZWFjdFRvdWNoZXNbdG91Y2hJbmRleF0gPSB1cGRhdGVkUmVhY3RUb3VjaDtcbiAgfVxuXG4gIHVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPiwgZXZlbnROYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjaGFuZ2VkSW5kZXhlcyA9IFtdO1xuICAgIGZvciAobGV0IHRvdWNoIG9mIHRvdWNoZXMpIHtcbiAgICAgIGNvbnN0IG5hdGl2ZVRvdWNoID0gdGhpcy5uYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyW3RvdWNoLmlkZW50aWZpZXJdO1xuICAgICAgaWYgKCFuYXRpdmVUb3VjaCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcInVwZGF0ZUFuZERpc3BhdGNoIGZhaWxlZFwiKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5uYXRpdmVUb3VjaGVzLmluZGV4T2YobmF0aXZlVG91Y2gpO1xuXG4gICAgICBpZiAoaW5kZXggPT09IC0xKSBjb250aW51ZTtcblxuICAgICAgdGhpcy51cGRhdGVSZWFjdFRvdWNoKGluZGV4LCB0b3VjaCk7XG4gICAgICBjaGFuZ2VkSW5kZXhlcy5wdXNoKGluZGV4KTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlZEluZGV4ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIm5vIGNoYW5nZWQgSW5kZXhlc1wiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZWFjdFRvdWNoZXMgPSB0aGlzLnJlYWN0VG91Y2hlcy5tYXAoKHJlYWN0VG91Y2gpID0+ICh7XG4gICAgICAuLi5yZWFjdFRvdWNoXG4gICAgfSkpO1xuXG4gICAgY29uc3QgY2FuQmVDb2FsZXNjZWQgPSBldmVudE5hbWUgPT09IFwidG91Y2hNb3ZlXCI7XG5cbiAgICBpZiAoIWNhbkJlQ29hbGVzY2VkKSB7XG4gICAgICB0aGlzLmNvYWxlc2NpbmdLZXkrKztcbiAgICB9XG5cbiAgICBpbnZhcmlhbnQodGhpcy52aWV3LCBcImF0dGVtcHRpbmcgdG8gc2VuZCBldmVudCB0byB1bmtub3duIHZpZXdcIik7XG5cbiAgICBjb25zdCBldmVudCA9IG5ldyBSQ1RUb3VjaEV2ZW50KFxuICAgICAgZXZlbnROYW1lLFxuICAgICAgdGhpcy52aWV3LnJlYWN0VGFnLFxuICAgICAgcmVhY3RUb3VjaGVzLFxuICAgICAgY2hhbmdlZEluZGV4ZXMsXG4gICAgICB0aGlzLmNvYWxlc2NpbmdLZXlcbiAgICApO1xuXG4gICAgaWYgKCFjYW5CZUNvYWxlc2NlZCkge1xuICAgICAgdGhpcy5jb2FsZXNjaW5nS2V5Kys7XG4gICAgfVxuXG4gICAgdGhpcy5ldmVudERpc3BhdGNoZXIuc2VuZEV2ZW50KGV2ZW50KTtcbiAgfVxuXG4gIG1vdXNlQ2xpY2tCZWdhbiA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNCZWdhbih0b3VjaGVzKTtcblxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7XG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIHZpZXcuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5tb3VzZUNsaWNrRW5kZWQpO1xuICAgICAgdmlldy5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMubW91c2VDbGlja01vdmVkKTtcbiAgICB9XG4gIH07XG5cbiAgbW91c2VDbGlja01vdmVkID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgY29uc3QgdG91Y2hlcyA9IFJDVFRvdWNoSGFuZGxlci5SQ1ROb3JtYWxpemVJbnRlcmFjdGlvbkV2ZW50KGV2ZW50KTtcbiAgICBpZiAoIXRvdWNoZXMpIHJldHVybjtcblxuICAgIHRoaXMudG91Y2hlc01vdmVkKHRvdWNoZXMpO1xuICB9O1xuXG4gIG1vdXNlQ2xpY2tFbmRlZCA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNFbmRlZCh0b3VjaGVzKTtcblxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7XG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIHZpZXcucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5tb3VzZUNsaWNrRW5kZWQpO1xuICAgICAgdmlldy5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMubW91c2VDbGlja01vdmVkKTtcbiAgICB9XG4gIH07XG5cbiAgbmF0aXZlVG91Y2hCZWdhbiA9IChldmVudDogVG91Y2hFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNCZWdhbih0b3VjaGVzKTtcblxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7XG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICBcInRvdWNoZW5kXCIsXG4gICAgICAgIHRoaXMubmF0aXZlVG91Y2hFbmRlZCxcbiAgICAgICAgVE9VQ0hfTElTVEVORVJfT1BUSU9OU1xuICAgICAgKTtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICBcInRvdWNobW92ZVwiLFxuICAgICAgICB0aGlzLm5hdGl2ZVRvdWNoTW92ZWQsXG4gICAgICAgIFRPVUNIX0xJU1RFTkVSX09QVElPTlNcbiAgICAgICk7XG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgXCJ0b3VjaGNhbmNlbFwiLFxuICAgICAgICB0aGlzLm5hdGl2ZVRvdWNoQ2FuY2VsZWQsXG4gICAgICAgIFRPVUNIX0xJU1RFTkVSX09QVElPTlNcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgbmF0aXZlVG91Y2hNb3ZlZCA9IChldmVudDogVG91Y2hFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNNb3ZlZCh0b3VjaGVzKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIG5hdGl2ZVRvdWNoRW5kZWQgPSAoZXZlbnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBjb25zdCB0b3VjaGVzID0gUkNUVG91Y2hIYW5kbGVyLlJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQoZXZlbnQpO1xuICAgIGlmICghdG91Y2hlcykgcmV0dXJuO1xuXG4gICAgdGhpcy50b3VjaGVzRW5kZWQodG91Y2hlcyk7XG5cbiAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3O1xuICAgIGlmICh2aWV3KSB7XG4gICAgICB0aGlzLnJlbW92ZVRvdWNoRXZlbnRzKHZpZXcpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIHJlbW92ZVRvdWNoRXZlbnRzKHZpZXc6IFVJVmlldykge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgXCJ0b3VjaGVuZFwiLFxuICAgICAgdGhpcy5uYXRpdmVUb3VjaEVuZGVkLFxuICAgICAgVE9VQ0hfTElTVEVORVJfT1BUSU9OU1xuICAgICk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICBcInRvdWNobW92ZVwiLFxuICAgICAgdGhpcy5uYXRpdmVUb3VjaE1vdmVkLFxuICAgICAgVE9VQ0hfTElTVEVORVJfT1BUSU9OU1xuICAgICk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICBcInRvdWNoY2FuY2VsXCIsXG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoQ2FuY2VsZWQsXG4gICAgICBUT1VDSF9MSVNURU5FUl9PUFRJT05TXG4gICAgKTtcbiAgfVxuXG4gIG5hdGl2ZVRvdWNoQ2FuY2VsZWQgPSAoZXZlbnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBjb25zdCB0b3VjaGVzID0gUkNUVG91Y2hIYW5kbGVyLlJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQoZXZlbnQpO1xuICAgIGlmICghdG91Y2hlcykgcmV0dXJuO1xuXG4gICAgdGhpcy50b3VjaGVzQ2FuY2VsZWQodG91Y2hlcyk7XG5cbiAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3O1xuICAgIGlmICh2aWV3KSB7XG4gICAgICB0aGlzLnJlbW92ZVRvdWNoRXZlbnRzKHZpZXcpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIHRvdWNoZXNCZWdhbih0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRoaXMucmVjb3JkTmV3VG91Y2hlcyh0b3VjaGVzKTtcbiAgICB0aGlzLnVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzLCBcInRvdWNoU3RhcnRcIik7XG4gIH1cblxuICB0b3VjaGVzTW92ZWQodG91Y2hlczogQXJyYXk8VUlUb3VjaD4pIHtcbiAgICB0aGlzLnVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzLCBcInRvdWNoTW92ZVwiKTtcbiAgfVxuXG4gIHRvdWNoZXNFbmRlZCh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRoaXMudXBkYXRlQW5kRGlzcGF0Y2hUb3VjaGVzKHRvdWNoZXMsIFwidG91Y2hFbmRcIik7XG4gICAgdGhpcy5yZWNvcmRSZW1vdmVkVG91Y2hlcyh0b3VjaGVzKTtcbiAgfVxuXG4gIHRvdWNoZXNDYW5jZWxlZCh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRoaXMudXBkYXRlQW5kRGlzcGF0Y2hUb3VjaGVzKHRvdWNoZXMsIFwidG91Y2hDYW5jZWxcIik7XG4gICAgdGhpcy5yZWNvcmRSZW1vdmVkVG91Y2hlcyh0b3VjaGVzKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBSQ1RUb3VjaEhhbmRsZXI7XG4iXX0=