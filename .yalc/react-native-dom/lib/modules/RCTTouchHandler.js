Object.defineProperty(exports,"__esModule",{value:true});var _extends2=require("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _detectIt=require("detect-it");var _detectIt2=_interopRequireDefault(_detectIt);var _Invariant=require("./../utils/Invariant");var _Invariant2=_interopRequireDefault(_Invariant);var _UIView=require("./../base/UIView");var _UIView2=_interopRequireDefault(_UIView);var _RCTEventDispatcher=require("./../bridge/RCTEventDispatcher");var _RCTEventDispatcher2=_interopRequireDefault(_RCTEventDispatcher);var _RCTTouchEvent=require("./RCTTouchEvent");var _RCTTouchEvent2=_interopRequireDefault(_RCTTouchEvent);var _Guid=require("./../utils/Guid");var _Guid2=_interopRequireDefault(_Guid);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var mouseTouchCounter=1;var TOUCH_LISTENER_OPTIONS=_detectIt2.default.passiveEvents?{passive:true,capture:false}:false;var RCTTouchHandler=function(){function RCTTouchHandler(bridge){var _this=this;(0,_classCallCheck3.default)(this,RCTTouchHandler);this.mouseClickBegan=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesBegan(touches);var view=_this.view;if(view){view.addEventListener("mouseup",_this.mouseClickEnded);view.addEventListener("mousemove",_this.mouseClickMoved);}};this.mouseClickMoved=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesMoved(touches);};this.mouseClickEnded=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesEnded(touches);var view=_this.view;if(view){view.removeEventListener("mouseup",_this.mouseClickEnded);view.removeEventListener("mousemove",_this.mouseClickMoved);}};this.nativeTouchBegan=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesBegan(touches);var view=_this.view;if(view){window.addEventListener("touchend",_this.nativeTouchEnded,TOUCH_LISTENER_OPTIONS);window.addEventListener("touchmove",_this.nativeTouchMoved,TOUCH_LISTENER_OPTIONS);window.addEventListener("touchcancel",_this.nativeTouchCanceled,TOUCH_LISTENER_OPTIONS);}return true;};this.nativeTouchMoved=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesMoved(touches);return true;};this.nativeTouchEnded=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesEnded(touches);var view=_this.view;if(view){_this.removeTouchEvents(view);}return true;};this.nativeTouchCanceled=function(event){var touches=RCTTouchHandler.RCTNormalizeInteractionEvent(event);if(!touches)return;_this.touchesCanceled(touches);var view=_this.view;if(view){_this.removeTouchEvents(view);}return true;};this.eventDispatcher=bridge.moduleForClass(_RCTEventDispatcher2.default);this.nativeTouches=[];this.nativeTouchesByIdentifier={};this.reactTouches=[];this.touchViews=[];}(0,_createClass3.default)(RCTTouchHandler,[{key:"attachToView",value:function attachToView(view){this.view=view;view.addGestureRecognizer(this,_detectIt2.default.deviceType,TOUCH_LISTENER_OPTIONS);}},{key:"detachFromView",value:function detachFromView(view){this.view=undefined;view.removeGestureRecognizer(this);}},{key:"recordNewTouches",value:function recordNewTouches(touches){var _this2=this;touches.forEach(function(touch){(0,_Invariant2.default)(!_this2.nativeTouchesByIdentifier.hasOwnProperty(touch.identifier),"Touch is already recorded. This is a critical bug");var targetView=touch.view;while(targetView){if(targetView===_this2.view)break;if(targetView.reactTag&&targetView.touchable)break;targetView=targetView.parentElement;}var reactTag=targetView.reactTag;var touchID=touch.identifier;var reactTouch={target:reactTag,identifier:touchID};_this2.touchViews.push(targetView);_this2.nativeTouches.push(touch);_this2.nativeTouchesByIdentifier[touchID]=touch;_this2.reactTouches.push(reactTouch);});}},{key:"recordRemovedTouches",value:function recordRemovedTouches(touches){for(var _iterator=touches,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var touch=_ref;var nativeTouch=this.nativeTouchesByIdentifier[touch.identifier];if(!nativeTouch){continue;}var index=this.nativeTouches.indexOf(nativeTouch);this.touchViews.splice(index,1);this.nativeTouches.splice(index,1);delete this.nativeTouchesByIdentifier[touch.identifier];this.reactTouches.splice(index,1);}}},{key:"updateReactTouch",value:function updateReactTouch(touchIndex,newTouch){var reactTouch=this.reactTouches[touchIndex];var updatedReactTouch=(0,_extends3.default)({},reactTouch,{pageX:newTouch.pageX,pageY:newTouch.pageY,locationX:newTouch.locationX,locationY:newTouch.locationY,timestamp:newTouch.timestamp});this.reactTouches[touchIndex]=updatedReactTouch;}},{key:"updateAndDispatchTouches",value:function updateAndDispatchTouches(touches,eventName){var changedIndexes=[];for(var _iterator2=touches,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var touch=_ref2;var nativeTouch=this.nativeTouchesByIdentifier[touch.identifier];if(!nativeTouch){console.log("updateAndDispatch failed");continue;}var index=this.nativeTouches.indexOf(nativeTouch);if(index===-1)continue;this.updateReactTouch(index,touch);changedIndexes.push(index);}if(changedIndexes.length===0){console.log("no changed Indexes");return;}var reactTouches=this.reactTouches.map(function(reactTouch){return(0,_extends3.default)({},reactTouch);});var canBeCoalesced=eventName==="touchMove";if(!canBeCoalesced){this.coalescingKey++;}(0,_Invariant2.default)(this.view,"attempting to send event to unknown view");var event=new _RCTTouchEvent2.default(eventName,this.view.reactTag,reactTouches,changedIndexes,this.coalescingKey);if(!canBeCoalesced){this.coalescingKey++;}this.eventDispatcher.sendEvent(event);}},{key:"removeTouchEvents",value:function removeTouchEvents(view){window.removeEventListener("touchend",this.nativeTouchEnded,TOUCH_LISTENER_OPTIONS);window.removeEventListener("touchmove",this.nativeTouchMoved,TOUCH_LISTENER_OPTIONS);window.removeEventListener("touchcancel",this.nativeTouchCanceled,TOUCH_LISTENER_OPTIONS);}},{key:"touchesBegan",value:function touchesBegan(touches){this.recordNewTouches(touches);this.updateAndDispatchTouches(touches,"touchStart");}},{key:"touchesMoved",value:function touchesMoved(touches){this.updateAndDispatchTouches(touches,"touchMove");}},{key:"touchesEnded",value:function touchesEnded(touches){this.updateAndDispatchTouches(touches,"touchEnd");this.recordRemovedTouches(touches);}},{key:"touchesCanceled",value:function touchesCanceled(touches){console.log("touches canceled");this.updateAndDispatchTouches(touches,"touchCancel");this.recordRemovedTouches(touches);}}],[{key:"RCTNormalizeInteractionEvent",value:function RCTNormalizeInteractionEvent(rawEvent){if(rawEvent instanceof MouseEvent){var _target=rawEvent.target;(0,_Invariant2.default)(_target instanceof _UIView2.default||_target instanceof _UIView.UIChildContainerView,"Cannot normalize interaction event on object which does not inherit from UIView");if("which"in rawEvent&&rawEvent.which===3){return null;}else if("button"in rawEvent&&rawEvent.button===2){return null;}return[{view:_target,identifier:0,pageX:rawEvent.pageX,pageY:rawEvent.pageY,locationX:rawEvent.clientX,locationY:rawEvent.clientY,timestamp:performance.now()}];}else if(rawEvent.changedTouches){var rawTouches=rawEvent.changedTouches;var resultingTouchList=[];for(var i=0;i<rawTouches.length;i++){var rawTouch=rawTouches[i];var _target2=rawTouch.target;(0,_Invariant2.default)(_target2 instanceof _UIView2.default||_target2 instanceof _UIView.UIChildContainerView,"Cannot normalize interaction event on object which does not inherit from UIView");var rect=_target2.getBoundingClientRect();resultingTouchList.push({view:_target2,identifier:rawTouch.identifier%20,pageX:rawTouch.clientX,pageY:rawTouch.clientY,locationX:rawTouch.pageX-rect.left,locationY:rawTouch.pageY-rect.top,timestamp:performance.now()});}return resultingTouchList;}console.error(rawEvent);throw new Error("Invalid Event");}}]);return RCTTouchHandler;}();exports.default=RCTTouchHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL1JlYWN0RG9tL21vZHVsZXMvUkNUVG91Y2hIYW5kbGVyLmpzIl0sIm5hbWVzIjpbIm1vdXNlVG91Y2hDb3VudGVyIiwiVE9VQ0hfTElTVEVORVJfT1BUSU9OUyIsInBhc3NpdmVFdmVudHMiLCJwYXNzaXZlIiwiY2FwdHVyZSIsIlJDVFRvdWNoSGFuZGxlciIsImJyaWRnZSIsIm1vdXNlQ2xpY2tCZWdhbiIsImV2ZW50IiwidG91Y2hlcyIsIlJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQiLCJ0b3VjaGVzQmVnYW4iLCJ2aWV3IiwiYWRkRXZlbnRMaXN0ZW5lciIsIm1vdXNlQ2xpY2tFbmRlZCIsIm1vdXNlQ2xpY2tNb3ZlZCIsInRvdWNoZXNNb3ZlZCIsInRvdWNoZXNFbmRlZCIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJuYXRpdmVUb3VjaEJlZ2FuIiwid2luZG93IiwibmF0aXZlVG91Y2hFbmRlZCIsIm5hdGl2ZVRvdWNoTW92ZWQiLCJuYXRpdmVUb3VjaENhbmNlbGVkIiwicmVtb3ZlVG91Y2hFdmVudHMiLCJ0b3VjaGVzQ2FuY2VsZWQiLCJldmVudERpc3BhdGNoZXIiLCJtb2R1bGVGb3JDbGFzcyIsIm5hdGl2ZVRvdWNoZXMiLCJuYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyIiwicmVhY3RUb3VjaGVzIiwidG91Y2hWaWV3cyIsImFkZEdlc3R1cmVSZWNvZ25pemVyIiwiZGV2aWNlVHlwZSIsInVuZGVmaW5lZCIsInJlbW92ZUdlc3R1cmVSZWNvZ25pemVyIiwiZm9yRWFjaCIsInRvdWNoIiwiaGFzT3duUHJvcGVydHkiLCJpZGVudGlmaWVyIiwidGFyZ2V0VmlldyIsInJlYWN0VGFnIiwidG91Y2hhYmxlIiwicGFyZW50RWxlbWVudCIsInRvdWNoSUQiLCJyZWFjdFRvdWNoIiwidGFyZ2V0IiwicHVzaCIsIm5hdGl2ZVRvdWNoIiwiaW5kZXgiLCJpbmRleE9mIiwic3BsaWNlIiwidG91Y2hJbmRleCIsIm5ld1RvdWNoIiwidXBkYXRlZFJlYWN0VG91Y2giLCJwYWdlWCIsInBhZ2VZIiwibG9jYXRpb25YIiwibG9jYXRpb25ZIiwidGltZXN0YW1wIiwiZXZlbnROYW1lIiwiY2hhbmdlZEluZGV4ZXMiLCJjb25zb2xlIiwibG9nIiwidXBkYXRlUmVhY3RUb3VjaCIsImxlbmd0aCIsIm1hcCIsImNhbkJlQ29hbGVzY2VkIiwiY29hbGVzY2luZ0tleSIsInNlbmRFdmVudCIsInJlY29yZE5ld1RvdWNoZXMiLCJ1cGRhdGVBbmREaXNwYXRjaFRvdWNoZXMiLCJyZWNvcmRSZW1vdmVkVG91Y2hlcyIsInJhd0V2ZW50IiwiTW91c2VFdmVudCIsIndoaWNoIiwiYnV0dG9uIiwiY2xpZW50WCIsImNsaWVudFkiLCJwZXJmb3JtYW5jZSIsIm5vdyIsImNoYW5nZWRUb3VjaGVzIiwicmF3VG91Y2hlcyIsInJlc3VsdGluZ1RvdWNoTGlzdCIsImkiLCJyYXdUb3VjaCIsInJlY3QiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJsZWZ0IiwidG9wIiwiZXJyb3IiLCJFcnJvciJdLCJtYXBwaW5ncyI6IjBaQU9BLG1DLGlEQUVBLCtDLG1EQUNBLHdDLDZDQUNBLGtFLHFFQUNBLDhDLDJEQUNBLHFDLDRIQXNCQSxHQUFJQSxtQkFBb0IsQ0FBeEIsQ0FFQSxHQUFNQyx3QkFBeUIsbUJBQVNDLGFBQVQsQ0FDM0IsQ0FBRUMsUUFBUyxJQUFYLENBQWlCQyxRQUFTLEtBQTFCLENBRDJCLENBRTNCLEtBRkosQyxHQUlNQyxnQixZQVdKLHlCQUFZQyxNQUFaLENBQStCLHdFQTBNL0JDLGVBMU0rQixDQTBNYixTQUFDQyxLQUFELENBQXVCLENBQ3ZDLEdBQU1DLFNBQVVKLGdCQUFnQkssNEJBQWhCLENBQTZDRixLQUE3QyxDQUFoQixDQUNBLEdBQUksQ0FBQ0MsT0FBTCxDQUFjLE9BRWQsTUFBS0UsWUFBTCxDQUFrQkYsT0FBbEIsRUFFQSxHQUFNRyxNQUFPLE1BQUtBLElBQWxCLENBQ0EsR0FBSUEsSUFBSixDQUFVLENBQ1JBLEtBQUtDLGdCQUFMLENBQXNCLFNB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QUEvQixDQUF1Q21CLEdBQXZDLENBQTRDLENBQzFDLEdBQU1DLFVBQVdILFdBQVdFLENBQVgsQ0FBakIsQ0FDQSxHQUFNdEMsVUFBU3VDLFNBQVN2QyxNQUF4QixDQUVBLHdCQUNFQSxzQ0FBNEJBLGdEQUQ5QixDQUVFLGlGQUZGLEVBS0EsR0FBTXdDLE1BQU94QyxTQUFPeUMscUJBQVAsRUFBYixDQUVBSixtQkFBbUJwQyxJQUFuQixDQUF3QixDQUN0Qm5DLEtBQU1rQyxRQURnQixDQUV0QlAsV0FBWThDLFNBQVM5QyxVQUFULENBQXNCLEVBRlosQ0FHdEJnQixNQUFPOEIsU0FBU1IsT0FITSxDQUl0QnJCLE1BQU82QixTQUFTUCxPQUpNLENBS3RCckIsVUFBVzRCLFNBQVM5QixLQUFULENBQWlCK0IsS0FBS0UsSUFMWCxDQU10QjlCLFVBQVcyQixTQUFTN0IsS0FBVCxDQUFpQjhCLEtBQUtHLEdBTlgsQ0FPdEI5QixVQUFXb0IsWUFBWUMsR0FBWixFQVBXLENBQXhCLEVBU0QsQ0FFRCxNQUFPRyxtQkFBUCxDQUNELENBRURyQixRQUFRNEIsS0FBUixDQUFjakIsUUFBZCxFQUNBLEtBQU0sSUFBSWtCLE1BQUosQ0FBVSxlQUFWLENBQU4sQ0FDRCxDLCtDQTRRWXRGLGUiLCJmaWxlIjoiUkNUVG91Y2hIYW5kbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcHJvdmlkZXNNb2R1bGUgUkNUVG91Y2hIYW5kbGVyXG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCB0eXBlIFJDVEJyaWRnZSBmcm9tIFwiUkNUQnJpZGdlXCI7XG5cbmltcG9ydCBkZXRlY3RJdCBmcm9tIFwiZGV0ZWN0LWl0XCI7XG5cbmltcG9ydCBpbnZhcmlhbnQgZnJvbSBcIkludmFyaWFudFwiO1xuaW1wb3J0IFVJVmlldywgeyBVSUNoaWxkQ29udGFpbmVyVmlldyB9IGZyb20gXCJVSVZpZXdcIjtcbmltcG9ydCBSQ1RFdmVudERpc3BhdGNoZXIgZnJvbSBcIlJDVEV2ZW50RGlzcGF0Y2hlclwiO1xuaW1wb3J0IFJDVFRvdWNoRXZlbnQgZnJvbSBcIlJDVFRvdWNoRXZlbnRcIjtcbmltcG9ydCBndWlkIGZyb20gXCJHdWlkXCI7XG5cbnR5cGUgVUlUb3VjaCA9IHtcbiAgdmlldzogVUlWaWV3IHwgVUlDaGlsZENvbnRhaW5lclZpZXcsXG4gIGlkZW50aWZpZXI6IG51bWJlcixcbiAgcGFnZVg6IG51bWJlcixcbiAgcGFnZVk6IG51bWJlcixcbiAgbG9jYXRpb25YOiBudW1iZXIsXG4gIGxvY2F0aW9uWTogbnVtYmVyLFxuICB0aW1lc3RhbXA6IG51bWJlclxufTtcblxudHlwZSBSZWFjdFRvdWNoID0ge1xuICB0YXJnZXQ6IG51bWJlcixcbiAgaWRlbnRpZmllcjogbnVtYmVyLFxuICBwYWdlWD86IG51bWJlcixcbiAgcGFnZVk/OiBudW1iZXIsXG4gIGxvY2F0aW9uWD86IG51bWJlcixcbiAgbG9jYXRpb25ZPzogbnVtYmVyLFxuICB0aW1lc3RhbXA/OiBudW1iZXJcbn07XG5cbmxldCBtb3VzZVRvdWNoQ291bnRlciA9IDE7XG5cbmNvbnN0IFRPVUNIX0xJU1RFTkVSX09QVElPTlMgPSBkZXRlY3RJdC5wYXNzaXZlRXZlbnRzXG4gID8geyBwYXNzaXZlOiB0cnVlLCBjYXB0dXJlOiBmYWxzZSB9XG4gIDogZmFsc2U7XG5cbmNsYXNzIFJDVFRvdWNoSGFuZGxlciB7XG4gIGV2ZW50RGlzcGF0Y2hlcjogUkNURXZlbnREaXNwYXRjaGVyO1xuXG4gIG5hdGl2ZVRvdWNoZXNCeUlkZW50aWZpZXI6IHsgW251bWJlcl06IFVJVG91Y2ggfTtcbiAgbmF0aXZlVG91Y2hlczogQXJyYXk8VUlUb3VjaD47XG4gIHJlYWN0VG91Y2hlczogQXJyYXk8UmVhY3RUb3VjaD47XG4gIHRvdWNoVmlld3M6IEFycmF5PFVJVmlldz47XG4gIGNvYWxlc2NpbmdLZXk6IG51bWJlcjtcblxuICB2aWV3OiA/VUlWaWV3O1xuXG4gIGNvbnN0cnVjdG9yKGJyaWRnZTogUkNUQnJpZGdlKSB7XG4gICAgdGhpcy5ldmVudERpc3BhdGNoZXIgPSAoYnJpZGdlLm1vZHVsZUZvckNsYXNzKFxuICAgICAgKFJDVEV2ZW50RGlzcGF0Y2hlcjogYW55KVxuICAgICk6IGFueSk7XG5cbiAgICB0aGlzLm5hdGl2ZVRvdWNoZXMgPSBbXTtcbiAgICB0aGlzLm5hdGl2ZVRvdWNoZXNCeUlkZW50aWZpZXIgPSB7fTtcbiAgICB0aGlzLnJlYWN0VG91Y2hlcyA9IFtdO1xuICAgIHRoaXMudG91Y2hWaWV3cyA9IFtdO1xuICB9XG5cbiAgc3RhdGljIFJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQoXG4gICAgcmF3RXZlbnQ6IFRvdWNoRXZlbnQgfCBNb3VzZUV2ZW50XG4gICk6ID9BcnJheTxVSVRvdWNoPiB7XG4gICAgaWYgKHJhd0V2ZW50IGluc3RhbmNlb2YgTW91c2VFdmVudCkge1xuICAgICAgLy8gcmF3RXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGNvbnN0IHRhcmdldCA9IHJhd0V2ZW50LnRhcmdldDtcblxuICAgICAgaW52YXJpYW50KFxuICAgICAgICB0YXJnZXQgaW5zdGFuY2VvZiBVSVZpZXcgfHwgdGFyZ2V0IGluc3RhbmNlb2YgVUlDaGlsZENvbnRhaW5lclZpZXcsXG4gICAgICAgIFwiQ2Fubm90IG5vcm1hbGl6ZSBpbnRlcmFjdGlvbiBldmVudCBvbiBvYmplY3Qgd2hpY2ggZG9lcyBub3QgaW5oZXJpdCBmcm9tIFVJVmlld1wiXG4gICAgICApO1xuXG4gICAgICBpZiAoXCJ3aGljaFwiIGluIHJhd0V2ZW50ICYmIHJhd0V2ZW50LndoaWNoID09PSAzKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfSBlbHNlIGlmIChcImJ1dHRvblwiIGluIHJhd0V2ZW50ICYmIHJhd0V2ZW50LmJ1dHRvbiA9PT0gMikge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFtcbiAgICAgICAge1xuICAgICAgICAgIHZpZXc6IHRhcmdldCxcbiAgICAgICAgICBpZGVudGlmaWVyOiAwLFxuICAgICAgICAgIHBhZ2VYOiByYXdFdmVudC5wYWdlWCxcbiAgICAgICAgICBwYWdlWTogcmF3RXZlbnQucGFnZVksXG4gICAgICAgICAgbG9jYXRpb25YOiByYXdFdmVudC5jbGllbnRYLFxuICAgICAgICAgIGxvY2F0aW9uWTogcmF3RXZlbnQuY2xpZW50WSxcbiAgICAgICAgICB0aW1lc3RhbXA6IHBlcmZvcm1hbmNlLm5vdygpXG4gICAgICAgIH1cbiAgICAgIF07XG4gICAgfSBlbHNlIGlmIChyYXdFdmVudC5jaGFuZ2VkVG91Y2hlcykge1xuICAgICAgY29uc3QgcmF3VG91Y2hlcyA9IHJhd0V2ZW50LmNoYW5nZWRUb3VjaGVzO1xuICAgICAgY29uc3QgcmVzdWx0aW5nVG91Y2hMaXN0ID0gW107XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3VG91Y2hlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCByYXdUb3VjaCA9IHJhd1RvdWNoZXNbaV07XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHJhd1RvdWNoLnRhcmdldDtcblxuICAgICAgICBpbnZhcmlhbnQoXG4gICAgICAgICAgdGFyZ2V0IGluc3RhbmNlb2YgVUlWaWV3IHx8IHRhcmdldCBpbnN0YW5jZW9mIFVJQ2hpbGRDb250YWluZXJWaWV3LFxuICAgICAgICAgIFwiQ2Fubm90IG5vcm1hbGl6ZSBpbnRlcmFjdGlvbiBldmVudCBvbiBvYmplY3Qgd2hpY2ggZG9lcyBub3QgaW5oZXJpdCBmcm9tIFVJVmlld1wiXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgcmVjdCA9IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICByZXN1bHRpbmdUb3VjaExpc3QucHVzaCh7XG4gICAgICAgICAgdmlldzogdGFyZ2V0LFxuICAgICAgICAgIGlkZW50aWZpZXI6IHJhd1RvdWNoLmlkZW50aWZpZXIgJSAyMCxcbiAgICAgICAgICBwYWdlWDogcmF3VG91Y2guY2xpZW50WCxcbiAgICAgICAgICBwYWdlWTogcmF3VG91Y2guY2xpZW50WSxcbiAgICAgICAgICBsb2NhdGlvblg6IHJhd1RvdWNoLnBhZ2VYIC0gcmVjdC5sZWZ0LFxuICAgICAgICAgIGxvY2F0aW9uWTogcmF3VG91Y2gucGFnZVkgLSByZWN0LnRvcCxcbiAgICAgICAgICB0aW1lc3RhbXA6IHBlcmZvcm1hbmNlLm5vdygpXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0aW5nVG91Y2hMaXN0O1xuICAgIH1cblxuICAgIGNvbnNvbGUuZXJyb3IocmF3RXZlbnQpO1xuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgRXZlbnRcIik7XG4gIH1cblxuICBhdHRhY2hUb1ZpZXcodmlldzogVUlWaWV3KSB7XG4gICAgdGhpcy52aWV3ID0gdmlldztcbiAgICB2aWV3LmFkZEdlc3R1cmVSZWNvZ25pemVyKFxuICAgICAgdGhpcyxcbiAgICAgIGRldGVjdEl0LmRldmljZVR5cGUsXG4gICAgICBUT1VDSF9MSVNURU5FUl9PUFRJT05TXG4gICAgKTtcbiAgfVxuXG4gIGRldGFjaEZyb21WaWV3KHZpZXc6IFVJVmlldykge1xuICAgIHRoaXMudmlldyA9IHVuZGVmaW5lZDtcbiAgICB2aWV3LnJlbW92ZUdlc3R1cmVSZWNvZ25pemVyKHRoaXMpO1xuICB9XG5cbiAgcmVjb3JkTmV3VG91Y2hlcyh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRvdWNoZXMuZm9yRWFjaCgodG91Y2gpID0+IHtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgIXRoaXMubmF0aXZlVG91Y2hlc0J5SWRlbnRpZmllci5oYXNPd25Qcm9wZXJ0eSh0b3VjaC5pZGVudGlmaWVyKSxcbiAgICAgICAgXCJUb3VjaCBpcyBhbHJlYWR5IHJlY29yZGVkLiBUaGlzIGlzIGEgY3JpdGljYWwgYnVnXCJcbiAgICAgICk7XG5cbiAgICAgIC8vIEZpbmQgY2xvc2VzdCBSZWFjdC1tYW5hZ2VkIHRvdWNoYWJsZSBlbGVtZW50XG4gICAgICBsZXQgdGFyZ2V0VmlldyA9ICh0b3VjaC52aWV3OiBhbnkpO1xuICAgICAgd2hpbGUgKHRhcmdldFZpZXcpIHtcbiAgICAgICAgaWYgKHRhcmdldFZpZXcgPT09IHRoaXMudmlldykgYnJlYWs7XG4gICAgICAgIGlmICh0YXJnZXRWaWV3LnJlYWN0VGFnICYmIHRhcmdldFZpZXcudG91Y2hhYmxlKSBicmVhaztcbiAgICAgICAgdGFyZ2V0VmlldyA9IHRhcmdldFZpZXcucGFyZW50RWxlbWVudDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVhY3RUYWcgPSB0YXJnZXRWaWV3LnJlYWN0VGFnO1xuICAgICAgY29uc3QgdG91Y2hJRCA9IHRvdWNoLmlkZW50aWZpZXI7XG5cbiAgICAgIC8vIENyZWF0ZSB0b3VjaFxuICAgICAgY29uc3QgcmVhY3RUb3VjaCA9IHtcbiAgICAgICAgdGFyZ2V0OiByZWFjdFRhZyxcbiAgICAgICAgaWRlbnRpZmllcjogdG91Y2hJRFxuICAgICAgfTtcblxuICAgICAgLy8gQWRkIHRvIGFycmF5c1xuICAgICAgdGhpcy50b3VjaFZpZXdzLnB1c2godGFyZ2V0Vmlldyk7XG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoZXMucHVzaCh0b3VjaCk7XG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoZXNCeUlkZW50aWZpZXJbdG91Y2hJRF0gPSB0b3VjaDtcbiAgICAgIHRoaXMucmVhY3RUb3VjaGVzLnB1c2gocmVhY3RUb3VjaCk7XG4gICAgfSk7XG4gIH1cblxuICByZWNvcmRSZW1vdmVkVG91Y2hlcyh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIGZvciAobGV0IHRvdWNoIG9mIHRvdWNoZXMpIHtcbiAgICAgIGNvbnN0IG5hdGl2ZVRvdWNoID0gdGhpcy5uYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyW3RvdWNoLmlkZW50aWZpZXJdO1xuXG4gICAgICBpZiAoIW5hdGl2ZVRvdWNoKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMubmF0aXZlVG91Y2hlcy5pbmRleE9mKG5hdGl2ZVRvdWNoKTtcblxuICAgICAgdGhpcy50b3VjaFZpZXdzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIGRlbGV0ZSB0aGlzLm5hdGl2ZVRvdWNoZXNCeUlkZW50aWZpZXJbdG91Y2guaWRlbnRpZmllcl07XG4gICAgICB0aGlzLnJlYWN0VG91Y2hlcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVJlYWN0VG91Y2godG91Y2hJbmRleDogbnVtYmVyLCBuZXdUb3VjaDogVUlUb3VjaCkge1xuICAgIGNvbnN0IHJlYWN0VG91Y2ggPSB0aGlzLnJlYWN0VG91Y2hlc1t0b3VjaEluZGV4XTtcblxuICAgIGNvbnN0IHVwZGF0ZWRSZWFjdFRvdWNoID0ge1xuICAgICAgLi4ucmVhY3RUb3VjaCxcbiAgICAgIHBhZ2VYOiBuZXdUb3VjaC5wYWdlWCxcbiAgICAgIHBhZ2VZOiBuZXdUb3VjaC5wYWdlWSxcbiAgICAgIGxvY2F0aW9uWDogbmV3VG91Y2gubG9jYXRpb25YLFxuICAgICAgbG9jYXRpb25ZOiBuZXdUb3VjaC5sb2NhdGlvblksXG4gICAgICB0aW1lc3RhbXA6IG5ld1RvdWNoLnRpbWVzdGFtcFxuICAgIH07XG5cbiAgICAvLyBUT0RPOiBmb3JjZSB0b3VjaFxuXG4gICAgdGhpcy5yZWFjdFRvdWNoZXNbdG91Y2hJbmRleF0gPSB1cGRhdGVkUmVhY3RUb3VjaDtcbiAgfVxuXG4gIHVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPiwgZXZlbnROYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjaGFuZ2VkSW5kZXhlcyA9IFtdO1xuICAgIGZvciAobGV0IHRvdWNoIG9mIHRvdWNoZXMpIHtcbiAgICAgIGNvbnN0IG5hdGl2ZVRvdWNoID0gdGhpcy5uYXRpdmVUb3VjaGVzQnlJZGVudGlmaWVyW3RvdWNoLmlkZW50aWZpZXJdO1xuICAgICAgaWYgKCFuYXRpdmVUb3VjaCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcInVwZGF0ZUFuZERpc3BhdGNoIGZhaWxlZFwiKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5uYXRpdmVUb3VjaGVzLmluZGV4T2YobmF0aXZlVG91Y2gpO1xuXG4gICAgICBpZiAoaW5kZXggPT09IC0xKSBjb250aW51ZTtcblxuICAgICAgdGhpcy51cGRhdGVSZWFjdFRvdWNoKGluZGV4LCB0b3VjaCk7XG4gICAgICBjaGFuZ2VkSW5kZXhlcy5wdXNoKGluZGV4KTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlZEluZGV4ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIm5vIGNoYW5nZWQgSW5kZXhlc1wiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZWFjdFRvdWNoZXMgPSB0aGlzLnJlYWN0VG91Y2hlcy5tYXAoKHJlYWN0VG91Y2gpID0+ICh7XG4gICAgICAuLi5yZWFjdFRvdWNoXG4gICAgfSkpO1xuXG4gICAgY29uc3QgY2FuQmVDb2FsZXNjZWQgPSBldmVudE5hbWUgPT09IFwidG91Y2hNb3ZlXCI7XG5cbiAgICBpZiAoIWNhbkJlQ29hbGVzY2VkKSB7XG4gICAgICB0aGlzLmNvYWxlc2NpbmdLZXkrKztcbiAgICB9XG5cbiAgICBpbnZhcmlhbnQodGhpcy52aWV3LCBcImF0dGVtcHRpbmcgdG8gc2VuZCBldmVudCB0byB1bmtub3duIHZpZXdcIik7XG5cbiAgICBjb25zdCBldmVudCA9IG5ldyBSQ1RUb3VjaEV2ZW50KFxuICAgICAgZXZlbnROYW1lLFxuICAgICAgdGhpcy52aWV3LnJlYWN0VGFnLFxuICAgICAgcmVhY3RUb3VjaGVzLFxuICAgICAgY2hhbmdlZEluZGV4ZXMsXG4gICAgICB0aGlzLmNvYWxlc2NpbmdLZXlcbiAgICApO1xuXG4gICAgaWYgKCFjYW5CZUNvYWxlc2NlZCkge1xuICAgICAgdGhpcy5jb2FsZXNjaW5nS2V5Kys7XG4gICAgfVxuXG4gICAgdGhpcy5ldmVudERpc3BhdGNoZXIuc2VuZEV2ZW50KGV2ZW50KTtcbiAgfVxuXG4gIG1vdXNlQ2xpY2tCZWdhbiA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNCZWdhbih0b3VjaGVzKTtcblxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7XG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIHZpZXcuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5tb3VzZUNsaWNrRW5kZWQpO1xuICAgICAgdmlldy5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMubW91c2VDbGlja01vdmVkKTtcbiAgICB9XG4gIH07XG5cbiAgbW91c2VDbGlja01vdmVkID0gKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgY29uc3QgdG91Y2hlcyA9IFJDVFRvdWNoSGFuZGxlci5SQ1ROb3JtYWxpemVJbnRlcmFjdGlvbkV2ZW50KGV2ZW50KTtcbiAgICBpZiAoIXRvdWNoZXMpIHJldHVybjtcblxuICAgIHRoaXMudG91Y2hlc01vdmVkKHRvdWNoZXMpO1xuICB9O1xuXG4gIG1vdXNlQ2xpY2tFbmRlZCA9IChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNFbmRlZCh0b3VjaGVzKTtcblxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7XG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIHZpZXcucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1vdXNldXBcIiwgdGhpcy5tb3VzZUNsaWNrRW5kZWQpO1xuICAgICAgdmlldy5yZW1vdmVFdmVudExpc3RlbmVyKFwibW91c2Vtb3ZlXCIsIHRoaXMubW91c2VDbGlja01vdmVkKTtcbiAgICB9XG4gIH07XG5cbiAgbmF0aXZlVG91Y2hCZWdhbiA9IChldmVudDogVG91Y2hFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNCZWdhbih0b3VjaGVzKTtcblxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7XG4gICAgaWYgKHZpZXcpIHtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICBcInRvdWNoZW5kXCIsXG4gICAgICAgIHRoaXMubmF0aXZlVG91Y2hFbmRlZCxcbiAgICAgICAgVE9VQ0hfTElTVEVORVJfT1BUSU9OU1xuICAgICAgKTtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICBcInRvdWNobW92ZVwiLFxuICAgICAgICB0aGlzLm5hdGl2ZVRvdWNoTW92ZWQsXG4gICAgICAgIFRPVUNIX0xJU1RFTkVSX09QVElPTlNcbiAgICAgICk7XG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgXCJ0b3VjaGNhbmNlbFwiLFxuICAgICAgICB0aGlzLm5hdGl2ZVRvdWNoQ2FuY2VsZWQsXG4gICAgICAgIFRPVUNIX0xJU1RFTkVSX09QVElPTlNcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgbmF0aXZlVG91Y2hNb3ZlZCA9IChldmVudDogVG91Y2hFdmVudCkgPT4ge1xuICAgIGNvbnN0IHRvdWNoZXMgPSBSQ1RUb3VjaEhhbmRsZXIuUkNUTm9ybWFsaXplSW50ZXJhY3Rpb25FdmVudChldmVudCk7XG4gICAgaWYgKCF0b3VjaGVzKSByZXR1cm47XG5cbiAgICB0aGlzLnRvdWNoZXNNb3ZlZCh0b3VjaGVzKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIG5hdGl2ZVRvdWNoRW5kZWQgPSAoZXZlbnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBjb25zdCB0b3VjaGVzID0gUkNUVG91Y2hIYW5kbGVyLlJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQoZXZlbnQpO1xuICAgIGlmICghdG91Y2hlcykgcmV0dXJuO1xuXG4gICAgdGhpcy50b3VjaGVzRW5kZWQodG91Y2hlcyk7XG5cbiAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3O1xuICAgIGlmICh2aWV3KSB7XG4gICAgICB0aGlzLnJlbW92ZVRvdWNoRXZlbnRzKHZpZXcpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIHJlbW92ZVRvdWNoRXZlbnRzKHZpZXc6IFVJVmlldykge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFxuICAgICAgXCJ0b3VjaGVuZFwiLFxuICAgICAgdGhpcy5uYXRpdmVUb3VjaEVuZGVkLFxuICAgICAgVE9VQ0hfTElTVEVORVJfT1BUSU9OU1xuICAgICk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICBcInRvdWNobW92ZVwiLFxuICAgICAgdGhpcy5uYXRpdmVUb3VjaE1vdmVkLFxuICAgICAgVE9VQ0hfTElTVEVORVJfT1BUSU9OU1xuICAgICk7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXG4gICAgICBcInRvdWNoY2FuY2VsXCIsXG4gICAgICB0aGlzLm5hdGl2ZVRvdWNoQ2FuY2VsZWQsXG4gICAgICBUT1VDSF9MSVNURU5FUl9PUFRJT05TXG4gICAgKTtcbiAgfVxuXG4gIG5hdGl2ZVRvdWNoQ2FuY2VsZWQgPSAoZXZlbnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICBjb25zdCB0b3VjaGVzID0gUkNUVG91Y2hIYW5kbGVyLlJDVE5vcm1hbGl6ZUludGVyYWN0aW9uRXZlbnQoZXZlbnQpO1xuICAgIGlmICghdG91Y2hlcykgcmV0dXJuO1xuXG4gICAgdGhpcy50b3VjaGVzQ2FuY2VsZWQodG91Y2hlcyk7XG5cbiAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3O1xuICAgIGlmICh2aWV3KSB7XG4gICAgICB0aGlzLnJlbW92ZVRvdWNoRXZlbnRzKHZpZXcpO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIHRvdWNoZXNCZWdhbih0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRoaXMucmVjb3JkTmV3VG91Y2hlcyh0b3VjaGVzKTtcbiAgICB0aGlzLnVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzLCBcInRvdWNoU3RhcnRcIik7XG4gIH1cblxuICB0b3VjaGVzTW92ZWQodG91Y2hlczogQXJyYXk8VUlUb3VjaD4pIHtcbiAgICB0aGlzLnVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzLCBcInRvdWNoTW92ZVwiKTtcbiAgfVxuXG4gIHRvdWNoZXNFbmRlZCh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIHRoaXMudXBkYXRlQW5kRGlzcGF0Y2hUb3VjaGVzKHRvdWNoZXMsIFwidG91Y2hFbmRcIik7XG4gICAgdGhpcy5yZWNvcmRSZW1vdmVkVG91Y2hlcyh0b3VjaGVzKTtcbiAgfVxuXG4gIHRvdWNoZXNDYW5jZWxlZCh0b3VjaGVzOiBBcnJheTxVSVRvdWNoPikge1xuICAgIGNvbnNvbGUubG9nKFwidG91Y2hlcyBjYW5jZWxlZFwiKTtcbiAgICB0aGlzLnVwZGF0ZUFuZERpc3BhdGNoVG91Y2hlcyh0b3VjaGVzLCBcInRvdWNoQ2FuY2VsXCIpO1xuICAgIHRoaXMucmVjb3JkUmVtb3ZlZFRvdWNoZXModG91Y2hlcyk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUkNUVG91Y2hIYW5kbGVyO1xuIl19