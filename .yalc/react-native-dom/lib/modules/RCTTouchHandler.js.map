{"version":3,"sources":["../../ReactDom/modules/RCTTouchHandler.js"],"names":["mouseTouchCounter","TOUCH_LISTENER_OPTIONS","passiveEvents","passive","capture","getFirstParentUIView","target","parentElement","RCTTouchHandler","bridge","pointerBegan","event","touches","RCTNormalizeInteractionEvent","touchesBegan","view","addEventListener","pointerEnded","pointerMoved","pointerCancelled","touchesMoved","touchesEnded","removePointerEvents","touchesCanceled","eventDispatcher","moduleForClass","nativeTouches","nativeTouchesByIdentifier","reactTouches","touchViews","addGestureRecognizer","deviceType","undefined","removeGestureRecognizer","forEach","touch","hasOwnProperty","identifier","targetView","reactTag","touchable","touchID","reactTouch","push","nativeTouch","index","indexOf","splice","touchIndex","newTouch","updatedReactTouch","pageX","pageY","locationX","locationY","timestamp","eventName","changedIndexes","console","log","updateReactTouch","length","map","canBeCoalesced","coalescingKey","sendEvent","removeEventListener","recordNewTouches","updateAndDispatchTouches","recordRemovedTouches","rawEvent","which","button","clientX","clientY","performance","now"],"mappings":"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","file":"RCTTouchHandler.js","sourcesContent":["/**\n * @providesModule RCTTouchHandler\n * @flow\n */\n\nimport type RCTBridge from \"RCTBridge\";\n\nimport detectIt from \"detect-it\";\n\nimport invariant from \"Invariant\";\nimport UIView, { UIChildContainerView } from \"UIView\";\nimport RCTEventDispatcher from \"RCTEventDispatcher\";\nimport RCTTouchEvent from \"RCTTouchEvent\";\nimport guid from \"Guid\";\n\ntype UITouch = {\n  view: UIView | UIChildContainerView,\n  identifier: number,\n  pageX: number,\n  pageY: number,\n  locationX: number,\n  locationY: number,\n  timestamp: number\n};\n\ntype ReactTouch = {\n  target: number,\n  identifier: number,\n  pageX?: number,\n  pageY?: number,\n  locationX?: number,\n  locationY?: number,\n  timestamp?: number\n};\n\nlet mouseTouchCounter = 1;\n\nconst TOUCH_LISTENER_OPTIONS = detectIt.passiveEvents\n  ? { passive: true, capture: false }\n  : false;\n\nfunction getFirstParentUIView(target: any) {\n  while (target.parentElement) {\n    if (target instanceof UIView || target instanceof UIChildContainerView) {\n      return target;\n    }\n    target = target.parentElement;\n  }\n  return target;\n}\n\nclass RCTTouchHandler {\n  eventDispatcher: RCTEventDispatcher;\n\n  nativeTouchesByIdentifier: { [number]: UITouch };\n  nativeTouches: Array<UITouch>;\n  reactTouches: Array<ReactTouch>;\n  touchViews: Array<UIView>;\n  coalescingKey: number;\n\n  view: ?UIView;\n\n  constructor(bridge: RCTBridge) {\n    this.eventDispatcher = (bridge.moduleForClass(\n      (RCTEventDispatcher: any)\n    ): any);\n\n    this.nativeTouches = [];\n    this.nativeTouchesByIdentifier = {};\n    this.reactTouches = [];\n    this.touchViews = [];\n  }\n\n  static RCTNormalizeInteractionEvent(rawEvent: PointerEvent): ?Array<UITouch> {\n    const target: UIView = getFirstParentUIView(rawEvent.target);\n\n    if (\"which\" in rawEvent && rawEvent.which === 3) {\n      return null;\n    } else if (\"button\" in rawEvent && rawEvent.button === 2) {\n      return null;\n    }\n\n    return [\n      {\n        view: target,\n        identifier: 0,\n        pageX: rawEvent.pageX,\n        pageY: rawEvent.pageY,\n        locationX: rawEvent.clientX,\n        locationY: rawEvent.clientY,\n        timestamp: performance.now()\n      }\n    ];\n  }\n\n  attachToView(view: UIView) {\n    this.view = view;\n    view.addGestureRecognizer(\n      this,\n      detectIt.deviceType,\n      TOUCH_LISTENER_OPTIONS\n    );\n  }\n\n  detachFromView(view: UIView) {\n    this.view = undefined;\n    view.removeGestureRecognizer(this);\n  }\n\n  recordNewTouches(touches: Array<UITouch>) {\n    touches.forEach((touch) => {\n      invariant(\n        !this.nativeTouchesByIdentifier.hasOwnProperty(touch.identifier),\n        \"Touch is already recorded. This is a critical bug\"\n      );\n\n      // Find closest React-managed touchable element\n      let targetView = (touch.view: any);\n      while (targetView) {\n        if (targetView === this.view) break;\n        if (targetView.reactTag && targetView.touchable) break;\n        targetView = targetView.parentElement;\n      }\n\n      const reactTag = targetView.reactTag;\n      const touchID = touch.identifier;\n\n      // Create touch\n      const reactTouch = {\n        target: reactTag,\n        identifier: touchID\n      };\n\n      // Add to arrays\n      this.touchViews.push(targetView);\n      this.nativeTouches.push(touch);\n      this.nativeTouchesByIdentifier[touchID] = touch;\n      this.reactTouches.push(reactTouch);\n    });\n  }\n\n  recordRemovedTouches(touches: Array<UITouch>) {\n    for (let touch of touches) {\n      const nativeTouch = this.nativeTouchesByIdentifier[touch.identifier];\n\n      if (!nativeTouch) {\n        continue;\n      }\n\n      const index = this.nativeTouches.indexOf(nativeTouch);\n\n      this.touchViews.splice(index, 1);\n      this.nativeTouches.splice(index, 1);\n      delete this.nativeTouchesByIdentifier[touch.identifier];\n      this.reactTouches.splice(index, 1);\n    }\n  }\n\n  updateReactTouch(touchIndex: number, newTouch: UITouch) {\n    const reactTouch = this.reactTouches[touchIndex];\n\n    const updatedReactTouch = {\n      ...reactTouch,\n      pageX: newTouch.pageX,\n      pageY: newTouch.pageY,\n      locationX: newTouch.locationX,\n      locationY: newTouch.locationY,\n      timestamp: newTouch.timestamp\n    };\n\n    // TODO: force touch\n\n    this.reactTouches[touchIndex] = updatedReactTouch;\n  }\n\n  updateAndDispatchTouches(touches: Array<UITouch>, eventName: string) {\n    const changedIndexes = [];\n    for (let touch of touches) {\n      const nativeTouch = this.nativeTouchesByIdentifier[touch.identifier];\n      if (!nativeTouch) {\n        console.log(\"updateAndDispatch failed\");\n        continue;\n      }\n\n      const index = this.nativeTouches.indexOf(nativeTouch);\n\n      if (index === -1) continue;\n\n      this.updateReactTouch(index, touch);\n      changedIndexes.push(index);\n    }\n\n    if (changedIndexes.length === 0) {\n      console.log(\"no changed Indexes\");\n      return;\n    }\n\n    const reactTouches = this.reactTouches.map((reactTouch) => ({\n      ...reactTouch\n    }));\n\n    const canBeCoalesced = eventName === \"touchMove\";\n\n    if (!canBeCoalesced) {\n      this.coalescingKey++;\n    }\n\n    invariant(this.view, \"attempting to send event to unknown view\");\n\n    const event = new RCTTouchEvent(\n      eventName,\n      this.view.reactTag,\n      reactTouches,\n      changedIndexes,\n      this.coalescingKey\n    );\n\n    if (!canBeCoalesced) {\n      this.coalescingKey++;\n    }\n\n    this.eventDispatcher.sendEvent(event);\n  }\n\n  pointerBegan = (event: PointerEvent) => {\n    const touches = RCTTouchHandler.RCTNormalizeInteractionEvent(event);\n    if (!touches) return;\n\n    this.touchesBegan(touches);\n\n    const view = this.view;\n    if (view) {\n      // $FlowFixMe\n      view.addEventListener(\n        \"pointerup\",\n        this.pointerEnded,\n        TOUCH_LISTENER_OPTIONS\n      );\n      // $FlowFixMe\n      view.addEventListener(\n        \"pointermove\",\n        this.pointerMoved,\n        TOUCH_LISTENER_OPTIONS\n      );\n      // $FlowFixMe\n      view.addEventListener(\n        \"pointercancel\",\n        this.pointerCancelled,\n        TOUCH_LISTENER_OPTIONS\n      );\n    }\n  };\n\n  pointerMoved = (event: PointerEvent) => {\n    const touches = RCTTouchHandler.RCTNormalizeInteractionEvent(event);\n    if (!touches) return;\n\n    this.touchesMoved(touches);\n  };\n\n  pointerEnded = (event: PointerEvent) => {\n    const touches = RCTTouchHandler.RCTNormalizeInteractionEvent(event);\n    if (!touches) return;\n\n    this.touchesEnded(touches);\n\n    const view = this.view;\n    if (view) {\n      this.removePointerEvents(view);\n    }\n  };\n\n  pointerCancelled = (event: PointerEvent) => {\n    const touches = RCTTouchHandler.RCTNormalizeInteractionEvent(event);\n    if (!touches) return;\n\n    this.touchesCanceled(touches);\n\n    const view = this.view;\n    if (view) {\n      this.removePointerEvents(view);\n    }\n  };\n\n  removePointerEvents(view: UIView) {\n    // $FlowFixMe\n    view.removeEventListener(\n      \"pointerup\",\n      this.pointerEnded,\n      TOUCH_LISTENER_OPTIONS\n    );\n    // $FlowFixMe\n    view.removeEventListener(\n      \"pointermove\",\n      this.pointerMoved,\n      TOUCH_LISTENER_OPTIONS\n    );\n    // $FlowFixMe\n    view.removeEventListener(\n      \"pointercancel\",\n      this.pointerCancelled,\n      TOUCH_LISTENER_OPTIONS\n    );\n  }\n\n  touchesBegan(touches: Array<UITouch>) {\n    this.recordNewTouches(touches);\n    this.updateAndDispatchTouches(touches, \"touchStart\");\n  }\n\n  touchesMoved(touches: Array<UITouch>) {\n    this.updateAndDispatchTouches(touches, \"touchMove\");\n  }\n\n  touchesEnded(touches: Array<UITouch>) {\n    this.updateAndDispatchTouches(touches, \"touchEnd\");\n    this.recordRemovedTouches(touches);\n  }\n\n  touchesCanceled(touches: Array<UITouch>) {\n    this.updateAndDispatchTouches(touches, \"touchCancel\");\n    this.recordRemovedTouches(touches);\n  }\n}\n\nexport default RCTTouchHandler;\n"]}