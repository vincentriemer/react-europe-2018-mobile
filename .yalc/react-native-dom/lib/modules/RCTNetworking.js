Object.defineProperty(exports,"__esModule",{value:true});exports.default=undefined;var _slicedToArray2=require("babel-runtime/helpers/slicedToArray");var _slicedToArray3=_interopRequireDefault(_slicedToArray2);var _extends2=require("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _get2=require("babel-runtime/helpers/get");var _get3=_interopRequireDefault(_get2);var _inherits2=require("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _dec,_dec2,_dec3,_dec4,_dec5,_dec6,_class,_desc,_value,_class2;var _RCTBridge=require("./../bridge/RCTBridge");var _RCTBridge2=_interopRequireDefault(_RCTBridge);var _RCTURLRequestHandler=require("./../base/RCTURLRequestHandler");var _RCTURLRequestHandler2=_interopRequireDefault(_RCTURLRequestHandler);var _RCTEventEmitter2=require("./RCTEventEmitter");var _RCTEventEmitter3=_interopRequireDefault(_RCTEventEmitter2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _applyDecoratedDescriptor(target,property,decorators,descriptor,context){var desc={};Object['ke'+'ys'](descriptor).forEach(function(key){desc[key]=descriptor[key];});desc.enumerable=!!desc.enumerable;desc.configurable=!!desc.configurable;if('value'in desc||desc.initializer){desc.writable=true;}desc=decorators.slice().reverse().reduce(function(desc,decorator){return decorator(target,property,desc)||desc;},desc);if(context&&desc.initializer!==void 0){desc.value=desc.initializer?desc.initializer.call(context):void 0;desc.initializer=undefined;}if(desc.initializer===void 0){Object['define'+'Property'](target,property,desc);desc=null;}return desc;}function parseHttpHeaders(httpHeaders){if(httpHeaders==null)return{};return httpHeaders.split("\n").map(function(x){return x.split(/: */,2);}).filter(function(x){return x[0];}).reduce(function(ac,x){ac[x[0]]=x[1];return ac;},{});}var requestIdCounter=0;var RCTNetworking=(_dec=(0,_RCTBridge.RCT_EXPORT_MODULE)("RCTNetworking"),_dec2=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec3=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec4=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec5=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec6=(0,_RCTBridge.RCT_EXPORT_METHOD)(_RCTBridge.RCTFunctionTypeNormal),_dec(_class=(_class2=function(_RCTEventEmitter){(0,_inherits3.default)(RCTNetworking,_RCTEventEmitter);function RCTNetworking(bridge){(0,_classCallCheck3.default)(this,RCTNetworking);var _this=(0,_possibleConstructorReturn3.default)(this,(RCTNetworking.__proto__||Object.getPrototypeOf(RCTNetworking)).call(this,bridge,["didCompleteNetworkResponse","didReceiveNetworkResponse","didSendNetworkData","didReceiveNetworkIncrementalData","didReceiveNetworkDataProgress","didReceiveNetworkData"]));_this.requestStore={};_this.handleLoadEnd=function(request){return function(){var responseURL=request.responseURL;var headers=parseHttpHeaders(request.getAllResponseHeaders());var status=request.status;var responseJSON=[request.requestId,status,headers,responseURL];_this.sendEventWithName("didReceiveNetworkResponse",responseJSON);};};_this.handleLoad=function(request,responseType){return function(){_this.sendData(request,responseType);var completeJSON=[request.requestId,null,false];_this.sendEventWithName("didCompleteNetworkResponse",completeJSON);delete _this.requestStore[request.requestId];};};_this.handleError=function(request){return function(){};};_this.handleAbort=function(request){return function(){};};_this.handlers=undefined;_this.requestHandlers=[];_this.responseHandlers=[];return _this;}(0,_createClass3.default)(RCTNetworking,[{key:"sendData",value:function sendData(request,responseType){for(var _iterator=this.responseHandlers,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var handler=_ref;if(handler.canHandleNetworkingResponse(responseType)){var _responseData=handler.handleNetworkingResponse(request,request.response);return this.sendEventWithName("didReceiveNetworkData",[request.requestId,_responseData]);}}var responseData=undefined;if(responseType==="text"&&typeof request.response==="string"){responseData=request.response;}else if(responseType==="text"&&typeof request.response==="object"){responseData=JSON.stringify(request.response);}else{console.warn("Invalid responseType "+responseType);return;}this.sendEventWithName("didReceiveNetworkData",[request.requestId,responseData]);}},{key:"handlerForRequest",value:function handlerForRequest(request){var handlers=this.handlers;if(handlers==null){var conformingHandlers=this.bridge.modulesConformingToProtocol(_RCTURLRequestHandler2.default);conformingHandlers.sort(function(a,b){if(a.handlerPriority<b.handlerPriority)return-1;if(a.handlerPriority>b.handlerPriority)return 1;return 0;});handlers=conformingHandlers;}for(var _iterator2=handlers,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref2;if(_isArray2){if(_i2>=_iterator2.length)break;_ref2=_iterator2[_i2++];}else{_i2=_iterator2.next();if(_i2.done)break;_ref2=_i2.value;}var handler=_ref2;if(handler.canHandleRequest(request)){return handler;}}return null;}},{key:"sendRequest",value:function sendRequest(query,callbackId){var data=query.data,method=query.method,url=query.url,withCredentials=query.withCredentials,timeout=query.timeout,headers=query.headers,responseType=query.responseType;var requestId=requestIdCounter++;var req=(0,_extends3.default)(new XMLHttpRequest(),{requestId:requestId});this.requestStore[requestId]=req;req.open(method,url);console.log(withCredentials);req.withCredentials=withCredentials;req.timeout=timeout;req.responseType=responseType;req.addEventListener("load",this.handleLoad(req,responseType));req.addEventListener("loadend",this.handleLoadEnd(req));Object.entries(headers).forEach(function(_ref3){var _ref4=(0,_slicedToArray3.default)(_ref3,2),header=_ref4[0],value=_ref4[1];req.setRequestHeader(header,value);});var body=void 0;for(var _iterator3=this.requestHandlers,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref5;if(_isArray3){if(_i3>=_iterator3.length)break;_ref5=_iterator3[_i3++];}else{_i3=_iterator3.next();if(_i3.done)break;_ref5=_i3.value;}var handler=_ref5;if(handler.canHandleNetworkingRequest(query)){var _handler$handleNetwor=handler.handleNetworkingRequest(query),tempBody=_handler$handleNetwor.body,contentType=_handler$handleNetwor.contentType;if(tempBody){body=tempBody;req.setRequestHeader("Content-Type",contentType);break;}}}if(data.string){body=data.string;}if(data.base64){body=data.base64;}req.send(body);this.bridge.callbackFromId(callbackId)(requestId);}},{key:"abortRequest",value:function abortRequest(requestId){console.log("abortRequest",requestId);}},{key:"clearCookies",value:function clearCookies(callbackId){console.log("clearCookies",callbackId);}},{key:"addListener",value:function addListener(eventName,callback){(0,_get3.default)(RCTNetworking.prototype.__proto__||Object.getPrototypeOf(RCTNetworking.prototype),"addListener",this).call(this,eventName,callback);}},{key:"removeListeners",value:function removeListeners(count){(0,_get3.default)(RCTNetworking.prototype.__proto__||Object.getPrototypeOf(RCTNetworking.prototype),"removeListeners",this).call(this,count);}},{key:"addRequestHandler",value:function addRequestHandler(handler){this.requestHandlers.push(handler);}},{key:"addResponseHandler",value:function addResponseHandler(handler){this.responseHandlers.push(handler);}},{key:"removeRequestHandler",value:function removeRequestHandler(handler){var index=this.requestHandlers.indexOf(handler);if(index!==-1){this.requestHandlers.splice(index,1);}}},{key:"removeResponseHandler",value:function removeResponseHandler(handler){var index=this.responseHandlers.indexOf(handler);if(index!==-1){this.responseHandlers.splice(index,1);}}}]);return RCTNetworking;}(_RCTEventEmitter3.default),(_applyDecoratedDescriptor(_class2.prototype,"sendRequest",[_dec2],Object.getOwnPropertyDescriptor(_class2.prototype,"sendRequest"),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,"abortRequest",[_dec3],Object.getOwnPropertyDescriptor(_class2.prototype,"abortRequest"),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,"clearCookies",[_dec4],Object.getOwnPropertyDescriptor(_class2.prototype,"clearCookies"),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,"addListener",[_dec5],Object.getOwnPropertyDescriptor(_class2.prototype,"addListener"),_class2.prototype),_applyDecoratedDescriptor(_class2.prototype,"removeListeners",[_dec6],Object.getOwnPropertyDescriptor(_class2.prototype,"removeListeners"),_class2.prototype)),_class2))||_class);exports.default=RCTNetworking;
//# sourceMappingURL=RCTNetworking.js.map