Object.defineProperty(exports,"__esModule",{value:true});var _slicedToArray2=require("babel-runtime/helpers/slicedToArray");var _slicedToArray3=_interopRequireDefault(_slicedToArray2);var _extends2=require("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _set2=require("babel-runtime/helpers/set");var _set3=_interopRequireDefault(_set2);var _get2=require("babel-runtime/helpers/get");var _get3=_interopRequireDefault(_get2);var _inherits2=require("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _dec,_class;var _RCTView2=require("./../RCTView");var _RCTView3=_interopRequireDefault(_RCTView2);var _RCTImageSource=require("./RCTImageSource");var _RCTImageSource2=_interopRequireDefault(_RCTImageSource);var _CustomElement=require("./../../utils/CustomElement");var _CustomElement2=_interopRequireDefault(_CustomElement);var _ColorArrayFromHexARGB=require("./../../utils/ColorArrayFromHexARGB");var _ColorArrayFromHexARGB2=_interopRequireDefault(_ColorArrayFromHexARGB);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var tintColorSVG=function tintColorSVG(color,id){return"\n    <svg>\n      <defs>\n        <filter id=\"tint-"+id+"\">\n          <feFlood flood-color=\""+color+"\"></feFlood>\n          <feComposite in2=\"SourceAlpha\" operator=\"atop\"></feComposite>\n        </filter>\n      </defs>\n    </svg>";};var onLoadParamsForSource=function onLoadParamsForSource(source){return{source:{width:source.size.width,height:source.size.height,url:source.request}};};var idCounter=0;var RCTImageView=(_dec=(0,_CustomElement2.default)("rct-image-view"),_dec(_class=function(_RCTView){(0,_inherits3.default)(RCTImageView,_RCTView);function RCTImageView(bridge){(0,_classCallCheck3.default)(this,RCTImageView);var _this=(0,_possibleConstructorReturn3.default)(this,(RCTImageView.__proto__||Object.getPrototypeOf(RCTImageView)).call(this,bridge));_this.onLoadStart=false;_this.onLoad=false;_this.onLoadEnd=false;(0,_extends3.default)(_this.style,{overflow:"hidden"});_this._imageSources=[];_this.svgFilter=document.createElement("div");_this.svgFilter.style.height="0";_this.childContainer.appendChild(_this.svgFilter);_this.filterId=idCounter;idCounter++;_this.imageElement=document.createElement("img");_this.childContainer.appendChild(_this.imageElement);_this.resizeMode="stretch";_this.imageElement.addEventListener("load",function(){_this.forceRasterization();});return _this;}(0,_createClass3.default)(RCTImageView,[{key:"updateFilter",value:function updateFilter(){var filterStrings=[];if(this._tintColor){filterStrings.push("url(#tint-"+this.filterId+")");}if(this._blurRadius){filterStrings.push("blur("+this._blurRadius+"px)");}this.imageElement.style.webkitFilter=filterStrings.join(" ");this.imageElement.style.filter=filterStrings.join(" ");}},{key:"forceRasterization",value:function forceRasterization(){var _this2=this;if(this._tintColor!=null){requestAnimationFrame(function(){_this2.imageElement.style.willChange="transform";requestAnimationFrame(function(){_this2.imageElement.style.willChange="";});});}}},{key:"hasMultipleSources",value:function hasMultipleSources(){return this._imageSources.length>1;}},{key:"imageSourceForSize",value:function imageSourceForSize(size){if(!this.hasMultipleSources()){return this._imageSources[0];}if(size.width===0&&size.height===0){return null;}var scale=this.imageScale;var targetImagePixels=size.width*size.height*scale*scale;var bestSource=null;var bestFit=Infinity;for(var _iterator=this._imageSources,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref=_i.value;}var source=_ref;var imgSize=source.size;var imagePixels=imgSize.width*imgSize.height*source.scale*source.scale;var fit=Math.abs(1-imagePixels/targetImagePixels);if(fit<bestFit){bestFit=fit;bestSource=source;}}return bestSource;}},{key:"reloadImage",value:function reloadImage(){var _this3=this;var source=this.imageSourceForSize(this.frameSize);if(source&&this.frameSize.width>0&&this.frameSize.height>0){if(this.onLoadStart){this.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[this.reactTag,"topLoadStart",null]);}this.bridge.imageLoader.loadImageWithURLRequest(source.request).then(function(image){_this3.imageElement.src=image.src;if(_this3.onLoad){var sourceLoaded=source.imageSourceWithSizeAndScale({width:image.width,height:image.height},source.scale);_this3.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[_this3.reactTag,"topLoad",onLoadParamsForSource(sourceLoaded)]);}}).catch(function(err){_this3.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[_this3.reactTag,"topError",{error:err}]);}).then(function(){if(_this3.onLoadEnd){_this3.bridge.enqueueJSCall("RCTEventEmitter","receiveEvent",[_this3.reactTag,"topLoadEnd",null]);}});}}},{key:"imageSources",set:function set(value){this._imageSources=value;this.reloadImage();}},{key:"resizeMode",set:function set(value){var outputValue="";switch(value){case"contain":case"cover":outputValue=value;break;case"center":outputValue="scale-down";break;case"stretch":outputValue="fill";break;case"none":outputValue="none";break;}(0,_extends3.default)(this.imageElement.style,{objectFit:outputValue});}},{key:"blurRadius",set:function set(value){this._blurRadius=value;this.updateFilter();}},{key:"tintColor",set:function set(value){if(typeof value==="number"){var _ColorArrayFromHexARG=(0,_ColorArrayFromHexARGB2.default)(value),_ColorArrayFromHexARG2=(0,_slicedToArray3.default)(_ColorArrayFromHexARG,4),a=_ColorArrayFromHexARG2[0],r=_ColorArrayFromHexARG2[1],g=_ColorArrayFromHexARG2[2],b=_ColorArrayFromHexARG2[3];var stringValue="rgba("+r+","+g+","+b+","+a+")";this._tintColor=stringValue;}else{this._tintColor=value;}this.svgFilter.innerHTML=this._tintColor?tintColorSVG(this._tintColor,this.filterId):"";this.updateFilter();}},{key:"imageScale",get:function get(){return this.bridge.deviceInfo.getDevicePixelRatio();}},{key:"frame",get:function get(){return(0,_get3.default)(RCTImageView.prototype.__proto__||Object.getPrototypeOf(RCTImageView.prototype),"frame",this);},set:function set(value){(0,_set3.default)(RCTImageView.prototype.__proto__||Object.getPrototypeOf(RCTImageView.prototype),"frame",value,this);var width=value.width,height=value.height;(0,_extends3.default)(this.imageElement.style,{width:"100%",height:"100%"});this.reloadImage();}},{key:"frameSize",get:function get(){var _frame=this.frame,width=_frame.width,height=_frame.height;return{width:width,height:height};}}]);return RCTImageView;}(_RCTView3.default))||_class);exports.default=RCTImageView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL1JlYWN0RG9tL3ZpZXdzL0ltYWdlL1JDVEltYWdlVmlldy5qcyJdLCJuYW1lcyI6WyJ0aW50Q29sb3JTVkciLCJjb2xvciIsImlkIiwib25Mb2FkUGFyYW1zRm9yU291cmNlIiwic291cmNlIiwid2lkdGgiLCJzaXplIiwiaGVpZ2h0IiwidXJsIiwicmVxdWVzdCIsImlkQ291bnRlciIsIlJDVEltYWdlVmlldyIsImJyaWRnZSIsIm9uTG9hZFN0YXJ0Iiwib25Mb2FkIiwib25Mb2FkRW5kIiwic3R5bGUiLCJvdmVyZmxvdyIsIl9pbWFnZVNvdXJjZXMiLCJzdmdGaWx0ZXIiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjaGlsZENvbnRhaW5lciIsImFwcGVuZENoaWxkIiwiZmlsdGVySWQiLCJpbWFnZUVsZW1lbnQiLCJyZXNpemVNb2RlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImZvcmNlUmFzdGVyaXphdGlvbiIsImZpbHRlclN0cmluZ3MiLCJfdGludENvbG9yIiwicHVzaCIsIl9ibHVyUmFkaXVzIiwid2Via2l0RmlsdGVyIiwiam9pbiIsImZpbHRlciIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsIndpbGxDaGFuZ2UiLCJsZW5ndGgiLCJoYXNNdWx0aXBsZVNvdXJjZXMiLCJzY2FsZSIsImltYWdlU2NhbGUiLCJ0YXJnZXRJbWFnZVBpeGVscyIsImJlc3RTb3VyY2UiLCJiZXN0Rml0IiwiSW5maW5pdHkiLCJpbWdTaXplIiwiaW1hZ2VQaXhlbHMiLCJmaXQiLCJNYXRoIiwiYWJzIiwiaW1hZ2VTb3VyY2VGb3JTaXplIiwiZnJhbWVTaXplIiwiZW5xdWV1ZUpTQ2FsbCIsInJlYWN0VGFnIiwiaW1hZ2VMb2FkZXIiLCJsb2FkSW1hZ2VXaXRoVVJMUmVxdWVzdCIsInRoZW4iLCJpbWFnZSIsInNyYyIsInNvdXJjZUxvYWRlZCIsImltYWdlU291cmNlV2l0aFNpemVBbmRTY2FsZSIsImNhdGNoIiwiZXJyIiwiZXJyb3IiLCJ2YWx1ZSIsInJlbG9hZEltYWdlIiwib3V0cHV0VmFsdWUiLCJvYmplY3RGaXQiLCJ1cGRhdGVGaWx0ZXIiLCJhIiwiciIsImciLCJiIiwic3RyaW5nVmFsdWUiLCJpbm5lckhUTUwiLCJkZXZpY2VJbmZvIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsImZyYW1lIl0sIm1hcHBpbmdzIjoiaS9CQU9BLHNDLGdEQUNBLGdELDZEQUNBLDBELDJEQUNBLDBFLDhKQUVBLEdBQU1BLGNBQWUsUUFBZkEsYUFBZSxDQUFDQyxLQUFELENBQWdCQyxFQUFoQixDQUErQixDQUNsRCw4REFHeUJBLEVBSHpCLDBDQUlnQ0QsS0FKaEMsNElBU0QsQ0FWRCxDQVlBLEdBQU1FLHVCQUF3QixRQUF4QkEsc0JBQXdCLENBQUNDLE1BQUQsUUFBNkIsQ0FDekRBLE9BQVEsQ0FDTkMsTUFBT0QsT0FBT0UsSUFBUCxDQUFZRCxLQURiLENBRU5FLE9BQVFILE9BQU9FLElBQVAsQ0FBWUMsTUFGZCxDQUdOQyxJQUFLSixPQUFPSyxPQUhOLENBRGlELENBQTdCLEVBQTlCLENBUUEsR0FBSUMsV0FBWSxDQUFoQixDLEdBR01DLGEsT0FETCw0QkFBYyxnQkFBZCxDLDhFQWlCQyxzQkFBWUMsTUFBWixDQUErQixnTEFDdkJBLE1BRHVCLFNBVC9CQyxXQVMrQixDQVRSLEtBU1EsT0FSL0JDLE1BUStCLENBUmIsS0FRYSxPQVAvQkMsU0FPK0IsQ0FQVixLQU9VLENBRzdCLHNCQUFjLE1BQUtDLEtBQW5CLENBQTBCLENBQ3hCQyxTQUFVLFFBRGMsQ0FBMUIsRUFJQSxNQUFLQyxhQUFMLENBQXFCLEVBQXJCLENBTUEsTUFBS0MsU0FBTCxDQUFpQkMsU0FBU0MsYUFBVCxDQUF1QixLQUF2QixDQUFqQixDQUNBLE1BQUtGLFNBQUwsQ0FBZUgsS0FBZixDQUFxQlQsTUFBckIsQ0FBOEIsR0FBOUIsQ0FDQSxNQUFLZSxjQUFMLENBQW9CQyxXQUFwQixDQUFnQyxNQUFLSixTQUFyQyxFQUNBLE1BQUtLLFFBQUwsQ0FBZ0JkLFNBQWhCLENBQ0FBLFlBRUEsTUFBS2Us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QUdkNUQsS0FIYyxDQUdQRSxNQUhPLENBR0kwRCxLQUhKLENBR1AxRCxNQUhPLENBSXRCLHNCQUFjLEtBQUtrQixZQUFMLENBQWtCVCxLQUFoQyxDQUF1QyxDQUNyQ1gsTUFBTyxNQUQ4QixDQUVyQ0UsT0FBUSxNQUY2QixDQUF2QyxFQUtBLEtBQUsyRCxXQUFMLEdBQ0QsQyxxQ0FxQ3FCLFlBQ00sS0FBS1ksS0FEWCxDQUNaekUsS0FEWSxRQUNaQSxLQURZLENBQ0xFLE1BREssUUFDTEEsTUFESyxDQUVwQixNQUFPLENBQUVGLFdBQUYsQ0FBU0UsYUFBVCxDQUFQLENBQ0QsQyx1RUF1RFlJLFkiLCJmaWxlIjoiUkNUSW1hZ2VWaWV3LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcHJvdmlkZXNNb2R1bGUgUkNUSW1hZ2VWaWV3XG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCB0eXBlIFJDVEJyaWRnZSBmcm9tIFwiUkNUQnJpZGdlXCI7XG5cbmltcG9ydCBSQ1RWaWV3IGZyb20gXCJSQ1RWaWV3XCI7XG5pbXBvcnQgUkNUSW1hZ2VTb3VyY2UgZnJvbSBcIlJDVEltYWdlU291cmNlXCI7XG5pbXBvcnQgQ3VzdG9tRWxlbWVudCBmcm9tIFwiQ3VzdG9tRWxlbWVudFwiO1xuaW1wb3J0IENvbG9yQXJyYXlGcm9tSGV4QVJHQiBmcm9tIFwiQ29sb3JBcnJheUZyb21IZXhBUkdCXCI7XG5cbmNvbnN0IHRpbnRDb2xvclNWRyA9IChjb2xvcjogc3RyaW5nLCBpZDogbnVtYmVyKSA9PiB7XG4gIHJldHVybiBgXG4gICAgPHN2Zz5cbiAgICAgIDxkZWZzPlxuICAgICAgICA8ZmlsdGVyIGlkPVwidGludC0ke2lkfVwiPlxuICAgICAgICAgIDxmZUZsb29kIGZsb29kLWNvbG9yPVwiJHtjb2xvcn1cIj48L2ZlRmxvb2Q+XG4gICAgICAgICAgPGZlQ29tcG9zaXRlIGluMj1cIlNvdXJjZUFscGhhXCIgb3BlcmF0b3I9XCJhdG9wXCI+PC9mZUNvbXBvc2l0ZT5cbiAgICAgICAgPC9maWx0ZXI+XG4gICAgICA8L2RlZnM+XG4gICAgPC9zdmc+YDtcbn07XG5cbmNvbnN0IG9uTG9hZFBhcmFtc0ZvclNvdXJjZSA9IChzb3VyY2U6IFJDVEltYWdlU291cmNlKSA9PiAoe1xuICBzb3VyY2U6IHtcbiAgICB3aWR0aDogc291cmNlLnNpemUud2lkdGgsXG4gICAgaGVpZ2h0OiBzb3VyY2Uuc2l6ZS5oZWlnaHQsXG4gICAgdXJsOiBzb3VyY2UucmVxdWVzdFxuICB9XG59KTtcblxubGV0IGlkQ291bnRlciA9IDA7XG5cbkBDdXN0b21FbGVtZW50KFwicmN0LWltYWdlLXZpZXdcIilcbmNsYXNzIFJDVEltYWdlVmlldyBleHRlbmRzIFJDVFZpZXcge1xuICBfaW1hZ2VTb3VyY2VzOiBSQ1RJbWFnZVNvdXJjZVtdO1xuICBpbWFnZUVsZW1lbnQ6IEhUTUxJbWFnZUVsZW1lbnQ7XG4gIGltYWdlQ29udGFpbmVyOiBIVE1MRGl2RWxlbWVudDtcbiAgY2hpbGRTaGFkb3dSb290OiBTaGFkb3dSb290O1xuICBpbWdTdHlsZTogSFRNTFN0eWxlRWxlbWVudDtcblxuICBvbkxvYWRTdGFydDogYm9vbGVhbiA9IGZhbHNlO1xuICBvbkxvYWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgb25Mb2FkRW5kOiBib29sZWFuID0gZmFsc2U7XG5cbiAgZmlsdGVySWQ6IG51bWJlcjtcbiAgc3ZnRmlsdGVyOiBIVE1MRWxlbWVudDtcbiAgX2JsdXJSYWRpdXM6ID9udW1iZXI7XG4gIF90aW50Q29sb3I6ID9zdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoYnJpZGdlOiBSQ1RCcmlkZ2UpIHtcbiAgICBzdXBlcihicmlkZ2UpO1xuXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnN0eWxlLCB7XG4gICAgICBvdmVyZmxvdzogXCJoaWRkZW5cIlxuICAgIH0pO1xuXG4gICAgdGhpcy5faW1hZ2VTb3VyY2VzID0gW107XG5cbiAgICAvLyBUT0RPOiBVc2luZyBhIHNoYWRvdyByb290IGJyZWFrcyB0aGUgdGludENvbG9yIGZ1bmN0aW9uYWxpdHkgb24gc2FmYXJpLFxuICAgIC8vICAgICAgIGZpZ3VyZSBvdXQgd2h5IGFuZCByZS1lbmFibGVcbiAgICAvLyB0aGlzLmNoaWxkU2hhZG93Um9vdCA9IHRoaXMuY2hpbGRDb250YWluZXIuYXR0YWNoU2hhZG93KHsgbW9kZTogXCJvcGVuXCIgfSk7XG5cbiAgICB0aGlzLnN2Z0ZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgdGhpcy5zdmdGaWx0ZXIuc3R5bGUuaGVpZ2h0ID0gXCIwXCI7XG4gICAgdGhpcy5jaGlsZENvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLnN2Z0ZpbHRlcik7XG4gICAgdGhpcy5maWx0ZXJJZCA9IGlkQ291bnRlcjtcbiAgICBpZENvdW50ZXIrKztcblxuICAgIHRoaXMuaW1hZ2VFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImltZ1wiKTtcbiAgICB0aGlzLmNoaWxkQ29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuaW1hZ2VFbGVtZW50KTtcblxuICAgIHRoaXMucmVzaXplTW9kZSA9IFwic3RyZXRjaFwiO1xuXG4gICAgdGhpcy5pbWFnZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgKCkgPT4ge1xuICAgICAgdGhpcy5mb3JjZVJhc3Rlcml6YXRpb24oKTtcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZUZpbHRlcigpIHtcbiAgICBjb25zdCBmaWx0ZXJTdHJpbmdzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGlmICh0aGlzLl90aW50Q29sb3IpIHtcbiAgICAgIGZpbHRlclN0cmluZ3MucHVzaChgdXJsKCN0aW50LSR7dGhpcy5maWx0ZXJJZH0pYCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9ibHVyUmFkaXVzKSB7XG4gICAgICBmaWx0ZXJTdHJpbmdzLnB1c2goYGJsdXIoJHt0aGlzLl9ibHVyUmFkaXVzfXB4KWApO1xuICAgIH1cblxuICAgIC8vICRGbG93Rml4TWVcbiAgICB0aGlzLmltYWdlRWxlbWVudC5zdHlsZS53ZWJraXRGaWx0ZXIgPSBmaWx0ZXJTdHJpbmdzLmpvaW4oXCIgXCIpO1xuICAgIHRoaXMuaW1hZ2VFbGVtZW50LnN0eWxlLmZpbHRlciA9IGZpbHRlclN0cmluZ3Muam9pbihcIiBcIik7XG4gIH1cblxuICBmb3JjZVJhc3Rlcml6YXRpb24oKSB7XG4gICAgaWYgKHRoaXMuX3RpbnRDb2xvciAhPSBudWxsKSB7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICB0aGlzLmltYWdlRWxlbWVudC5zdHlsZS53aWxsQ2hhbmdlID0gXCJ0cmFuc2Zvcm1cIjtcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmltYWdlRWxlbWVudC5zdHlsZS53aWxsQ2hhbmdlID0gXCJcIjtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBzZXQgaW1hZ2VTb3VyY2VzKHZhbHVlOiBSQ1RJbWFnZVNvdXJjZVtdKSB7XG4gICAgdGhpcy5faW1hZ2VTb3VyY2VzID0gdmFsdWU7XG4gICAgdGhpcy5yZWxvYWRJbWFnZSgpO1xuICB9XG5cbiAgc2V0IHJlc2l6ZU1vZGUodmFsdWU6IHN0cmluZykge1xuICAgIGxldCBvdXRwdXRWYWx1ZTogc3RyaW5nID0gXCJcIjtcbiAgICBzd2l0Y2ggKHZhbHVlKSB7XG4gICAgICBjYXNlIFwiY29udGFpblwiOlxuICAgICAgY2FzZSBcImNvdmVyXCI6XG4gICAgICAgIG91dHB1dFZhbHVlID0gdmFsdWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImNlbnRlclwiOlxuICAgICAgICBvdXRwdXRWYWx1ZSA9IFwic2NhbGUtZG93blwiO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJzdHJldGNoXCI6XG4gICAgICAgIG91dHB1dFZhbHVlID0gXCJmaWxsXCI7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIm5vbmVcIjpcbiAgICAgICAgb3V0cHV0VmFsdWUgPSBgbm9uZWA7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBPYmplY3QuYXNzaWduKHRoaXMuaW1hZ2VFbGVtZW50LnN0eWxlLCB7XG4gICAgICBvYmplY3RGaXQ6IG91dHB1dFZhbHVlXG4gICAgfSk7XG4gIH1cblxuICBzZXQgYmx1clJhZGl1cyh2YWx1ZTogP251bWJlcikge1xuICAgIHRoaXMuX2JsdXJSYWRpdXMgPSB2YWx1ZTtcbiAgICB0aGlzLnVwZGF0ZUZpbHRlcigpO1xuICB9XG5cbiAgc2V0IHRpbnRDb2xvcih2YWx1ZTogP251bWJlcikge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIGNvbnN0IFthLCByLCBnLCBiXSA9IENvbG9yQXJyYXlGcm9tSGV4QVJHQih2YWx1ZSk7XG4gICAgICBjb25zdCBzdHJpbmdWYWx1ZSA9IGByZ2JhKCR7cn0sJHtnfSwke2J9LCR7YX0pYDtcbiAgICAgIHRoaXMuX3RpbnRDb2xvciA9IHN0cmluZ1ZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl90aW50Q29sb3IgPSB2YWx1ZTtcbiAgICB9XG4gICAgdGhpcy5zdmdGaWx0ZXIuaW5uZXJIVE1MID0gdGhpcy5fdGludENvbG9yXG4gICAgICA/IHRpbnRDb2xvclNWRyh0aGlzLl90aW50Q29sb3IsIHRoaXMuZmlsdGVySWQpXG4gICAgICA6IFwiXCI7XG4gICAgdGhpcy51cGRhdGVGaWx0ZXIoKTtcbiAgfVxuXG4gIGdldCBpbWFnZVNjYWxlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuYnJpZGdlLmRldmljZUluZm8uZ2V0RGV2aWNlUGl4ZWxSYXRpbygpO1xuICB9XG5cbiAgZ2V0IGZyYW1lKCk6IEZyYW1lIHtcbiAgICByZXR1cm4gc3VwZXIuZnJhbWU7XG4gIH1cblxuICBzZXQgZnJhbWUodmFsdWU6IEZyYW1lKSB7XG4gICAgc3VwZXIuZnJhbWUgPSB2YWx1ZTtcblxuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdmFsdWU7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLmltYWdlRWxlbWVudC5zdHlsZSwge1xuICAgICAgd2lkdGg6IFwiMTAwJVwiLFxuICAgICAgaGVpZ2h0OiBcIjEwMCVcIlxuICAgIH0pO1xuXG4gICAgdGhpcy5yZWxvYWRJbWFnZSgpO1xuICB9XG5cbiAgaGFzTXVsdGlwbGVTb3VyY2VzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9pbWFnZVNvdXJjZXMubGVuZ3RoID4gMTtcbiAgfVxuXG4gIGltYWdlU291cmNlRm9yU2l6ZShzaXplOiBTaXplKTogP1JDVEltYWdlU291cmNlIHtcbiAgICBpZiAoIXRoaXMuaGFzTXVsdGlwbGVTb3VyY2VzKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9pbWFnZVNvdXJjZXNbMF07XG4gICAgfVxuXG4gICAgLy8gbmVlZCB0byB3YWl0IGZvciBsYXlvdXQgcGFzcyBiZWZvcmUgZGVjaWRpbmdcbiAgICBpZiAoc2l6ZS53aWR0aCA9PT0gMCAmJiBzaXplLmhlaWdodCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgc2NhbGUgPSB0aGlzLmltYWdlU2NhbGU7XG4gICAgY29uc3QgdGFyZ2V0SW1hZ2VQaXhlbHMgPSBzaXplLndpZHRoICogc2l6ZS5oZWlnaHQgKiBzY2FsZSAqIHNjYWxlO1xuXG4gICAgbGV0IGJlc3RTb3VyY2U6ID9SQ1RJbWFnZVNvdXJjZSA9IG51bGw7XG4gICAgbGV0IGJlc3RGaXQ6IG51bWJlciA9IEluZmluaXR5O1xuXG4gICAgZm9yIChsZXQgc291cmNlIG9mIHRoaXMuX2ltYWdlU291cmNlcykge1xuICAgICAgY29uc3QgaW1nU2l6ZSA9IHNvdXJjZS5zaXplO1xuICAgICAgY29uc3QgaW1hZ2VQaXhlbHMgPVxuICAgICAgICBpbWdTaXplLndpZHRoICogaW1nU2l6ZS5oZWlnaHQgKiBzb3VyY2Uuc2NhbGUgKiBzb3VyY2Uuc2NhbGU7XG4gICAgICBjb25zdCBmaXQgPSBNYXRoLmFicygxIC0gaW1hZ2VQaXhlbHMgLyB0YXJnZXRJbWFnZVBpeGVscyk7XG5cbiAgICAgIGlmIChmaXQgPCBiZXN0Rml0KSB7XG4gICAgICAgIGJlc3RGaXQgPSBmaXQ7XG4gICAgICAgIGJlc3RTb3VyY2UgPSBzb3VyY2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGJlc3RTb3VyY2U7XG4gIH1cblxuICBnZXQgZnJhbWVTaXplKCk6IFNpemUge1xuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5mcmFtZTtcbiAgICByZXR1cm4geyB3aWR0aCwgaGVpZ2h0IH07XG4gIH1cblxuICByZWxvYWRJbWFnZSgpIHtcbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzLmltYWdlU291cmNlRm9yU2l6ZSh0aGlzLmZyYW1lU2l6ZSk7XG4gICAgaWYgKHNvdXJjZSAmJiB0aGlzLmZyYW1lU2l6ZS53aWR0aCA+IDAgJiYgdGhpcy5mcmFtZVNpemUuaGVpZ2h0ID4gMCkge1xuICAgICAgaWYgKHRoaXMub25Mb2FkU3RhcnQpIHtcbiAgICAgICAgdGhpcy5icmlkZ2UuZW5xdWV1ZUpTQ2FsbChcIlJDVEV2ZW50RW1pdHRlclwiLCBcInJlY2VpdmVFdmVudFwiLCBbXG4gICAgICAgICAgdGhpcy5yZWFjdFRhZyxcbiAgICAgICAgICBcInRvcExvYWRTdGFydFwiLFxuICAgICAgICAgIG51bGxcbiAgICAgICAgXSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYnJpZGdlLmltYWdlTG9hZGVyXG4gICAgICAgIC5sb2FkSW1hZ2VXaXRoVVJMUmVxdWVzdChzb3VyY2UucmVxdWVzdClcbiAgICAgICAgLnRoZW4oKGltYWdlOiBJbWFnZSkgPT4ge1xuICAgICAgICAgIHRoaXMuaW1hZ2VFbGVtZW50LnNyYyA9IGltYWdlLnNyYztcblxuICAgICAgICAgIGlmICh0aGlzLm9uTG9hZCkge1xuICAgICAgICAgICAgY29uc3Qgc291cmNlTG9hZGVkID0gc291cmNlLmltYWdlU291cmNlV2l0aFNpemVBbmRTY2FsZShcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHdpZHRoOiBpbWFnZS53aWR0aCxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IGltYWdlLmhlaWdodFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBzb3VyY2Uuc2NhbGVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmJyaWRnZS5lbnF1ZXVlSlNDYWxsKFwiUkNURXZlbnRFbWl0dGVyXCIsIFwicmVjZWl2ZUV2ZW50XCIsIFtcbiAgICAgICAgICAgICAgdGhpcy5yZWFjdFRhZyxcbiAgICAgICAgICAgICAgXCJ0b3BMb2FkXCIsXG4gICAgICAgICAgICAgIG9uTG9hZFBhcmFtc0ZvclNvdXJjZShzb3VyY2VMb2FkZWQpXG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgdGhpcy5icmlkZ2UuZW5xdWV1ZUpTQ2FsbChcIlJDVEV2ZW50RW1pdHRlclwiLCBcInJlY2VpdmVFdmVudFwiLCBbXG4gICAgICAgICAgICB0aGlzLnJlYWN0VGFnLFxuICAgICAgICAgICAgXCJ0b3BFcnJvclwiLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBlcnJvcjogZXJyXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXSk7XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5vbkxvYWRFbmQpIHtcbiAgICAgICAgICAgIHRoaXMuYnJpZGdlLmVucXVldWVKU0NhbGwoXCJSQ1RFdmVudEVtaXR0ZXJcIiwgXCJyZWNlaXZlRXZlbnRcIiwgW1xuICAgICAgICAgICAgICB0aGlzLnJlYWN0VGFnLFxuICAgICAgICAgICAgICBcInRvcExvYWRFbmRcIixcbiAgICAgICAgICAgICAgbnVsbFxuICAgICAgICAgICAgXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUkNUSW1hZ2VWaWV3O1xuIl19