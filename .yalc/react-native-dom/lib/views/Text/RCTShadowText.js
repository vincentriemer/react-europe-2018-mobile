var _regenerator=require("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _extends2=require("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _classCallCheck2=require("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _get2=require("babel-runtime/helpers/get");var _get3=_interopRequireDefault(_get2);var _inherits2=require("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _this2=this;var _yogaDom=require("yoga-dom");var YG=_interopRequireWildcard(_yogaDom);var _Guid=require("./../../utils/Guid");var _Guid2=_interopRequireDefault(_Guid);var _Invariant=require("./../../utils/Invariant");var _Invariant2=_interopRequireDefault(_Invariant);var _RCTSharedTextValues=require("./RCTSharedTextValues");var _RCTShadowView3=require("./../RCTShadowView");var _RCTShadowView4=_interopRequireDefault(_RCTShadowView3);var _RCTShadowRawText2=require("./RCTShadowRawText");var _RCTShadowRawText3=_interopRequireDefault(_RCTShadowRawText2);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var TEXT_SHADOW_STYLE_PROPS=["fontFamily","fontSize","fontStyle","fontWeight","lineHeight","letterSpacing"];var TEXT_PX_PROPS=["lineHeight"];var textMeasurementContainer=document.createElement("div");textMeasurementContainer.id="text-measurement";document.body&&document.body.appendChild(textMeasurementContainer);module.exports=function _callee(){var _ref,Constants,RCTShadowView,RCTShadowRawText,RCTShadowText;return _regenerator2.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator2.default.awrap(YG.default);case 2:_ref=_context.sent;Constants=_ref.Constants;_context.next=6;return _regenerator2.default.awrap(_RCTShadowView4.default);case 6:RCTShadowView=_context.sent;_context.next=9;return _regenerator2.default.awrap(_RCTShadowRawText3.default);case 9:RCTShadowRawText=_context.sent;RCTShadowText=function(_RCTShadowView2){(0,_inherits3.default)(RCTShadowText,_RCTShadowView2);function RCTShadowText(){(0,_classCallCheck3.default)(this,RCTShadowText);var _this=(0,_possibleConstructorReturn3.default)(this,(RCTShadowText.__proto__||Object.getPrototypeOf(RCTShadowText)).call(this));_this.yogaNode.setMeasureFunc(function(width,widthMeasureMode,height,heightMeasureMode){return _this.measure(width,widthMeasureMode,height,heightMeasureMode);});_this.props={};_this.textChildren=[];_this.textDirty=true;_this.numberOfLines=0;TEXT_SHADOW_STYLE_PROPS.forEach(function(shadowPropName){Object.defineProperty(_this,shadowPropName,{configurable:true,get:function get(){return _this.props[shadowPropName];},set:function set(value){if(value!=null){_this.props[shadowPropName]=TEXT_PX_PROPS.includes(shadowPropName)?value+"px":value;}else{_this.props[shadowPropName]=_RCTSharedTextValues.defaults[shadowPropName];}_this.markTextDirty();return true;}});_this[shadowPropName]=null;});return _this;}(0,_createClass3.default)(RCTShadowText,[{key:"markTextDirty",value:function markTextDirty(){this.yogaNode.markDirty();this.textDirty=true;if(this.reactSuperview instanceof RCTShadowText){this.reactSuperview.markTextDirty();}else if(this.reactSuperview instanceof RCTShadowView){this.reactSuperview.makeDirty();}}},{key:"clearTestDomElement",value:function clearTestDomElement(){var testDomElement=this.testDOMElement;while(testDomElement.firstChild){testDomElement.removeChild(testDomElement.firstChild);}}},{key:"measure",value:function measure(width,widthMeasureMode,height,heightMeasureMode){this.clearTestDomElement();var whiteSpace=this.numberOfLines===1?"nowrap":"pre-wrap";if(widthMeasureMode!==Constants.measureMode.exactly||heightMeasureMode!==Constants.measureMode.exactly){if(widthMeasureMode!==Constants.measureMode.undefined){(0,_extends3.default)(this.testDOMElement.style,{maxWidth:width+"px",maxHeight:"auto",whiteSpace:whiteSpace});}else{(0,_extends3.default)(this.testDOMElement.style,{maxWidth:"auto",maxHeight:height+"px",whiteSpace:whiteSpace});}}else{return{width:width||0,height:height||0};}this.testDOMElement.appendChild(this.getTestTree());var _testDOMElement$getBo=this.testDOMElement.getBoundingClientRect(),measuredWidth=_testDOMElement$getBo.width,measuredHeight=_testDOMElement$getBo.height;return{width:Math.ceil(measuredWidth),height:Math.ceil(measuredHeight)};}},{key:"getTestTree",value:function getTestTree(){if(!this.textDirty){(0,_Invariant2.default)(this._testTree,"ShadowText is not marked as dirty but there is no cached testTree");return this._testTree;}var spanWrapper=document.createElement("span");(0,_extends3.default)(spanWrapper.style,this.props);this.textChildren.forEach(function(child){if(child instanceof RCTShadowRawText&&child.text.length){var textLines=child.text.split(/\r?\n/);for(var i=0;i<textLines.length;i++){var currentLine=textLines[i];spanWrapper.insertAdjacentText("beforeend",currentLine);if(i<textLines.length-1){spanWrapper.insertAdjacentElement("beforeend",document.createElement("br"));}}}else if(child instanceof RCTShadowText){spanWrapper.insertAdjacentElement("beforeend",child.getTestTree());}});this._testTree=spanWrapper;this.textDirty=false;return this._testTree;}},{key:"insertReactSubviewAtIndex",value:function insertReactSubviewAtIndex(subview,index){subview.reactSuperview=this;this.textChildren.splice(index,0,subview);this.markTextDirty();}},{key:"removeReactSubview",value:function removeReactSubview(subview){subview.reactSuperview=undefined;this.textChildren=this.textChildren.filter(function(s){return s!==subview;});this.markTextDirty();}},{key:"purge",value:function purge(){(0,_get3.default)(RCTShadowText.prototype.__proto__||Object.getPrototypeOf(RCTShadowText.prototype),"purge",this).call(this);if(this._testDOMElement){this._testDOMElement.parentNode&&this._testDOMElement.parentNode.removeChild(this._testDOMElement);}}},{key:"numberOfLines",get:function get(){return this._numberOfLines;},set:function set(value){this._numberOfLines=value;this.markTextDirty();}},{key:"testDOMElement",get:function get(){if(this._testDOMElement==null){var domElement=document.createElement("div");domElement.id=(0,_Guid2.default)();(0,_extends3.default)(domElement.style,{position:"absolute",visibility:"hidden",maxHeight:"auto",maxWidth:"auto",whiteSpace:"nowrap",display:"inline-block"});textMeasurementContainer.appendChild(domElement);this._testDOMElement=domElement;}return this._testDOMElement;}}]);return RCTShadowText;}(RCTShadowView);return _context.abrupt("return",RCTShadowText);case 12:case"end":return _context.stop();}}},null,_this2);}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL1JlYWN0RG9tL3ZpZXdzL1RleHQvUkNUU2hhZG93VGV4dC5qcyJdLCJuYW1lcyI6WyJZRyIsIlRFWFRfU0hBRE9XX1NUWUxFX1BST1BTIiwiVEVYVF9QWF9QUk9QUyIsInRleHRNZWFzdXJlbWVudENvbnRhaW5lciIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImlkIiwiYm9keSIsImFwcGVuZENoaWxkIiwibW9kdWxlIiwiZXhwb3J0cyIsIkNvbnN0YW50cyIsIlJDVFNoYWRvd1ZpZXciLCJSQ1RTaGFkb3dSYXdUZXh0IiwiUkNUU2hhZG93VGV4dCIsInlvZ2FOb2RlIiwic2V0TWVhc3VyZUZ1bmMiLCJ3aWR0aCIsIndpZHRoTWVhc3VyZU1vZGUiLCJoZWlnaHQiLCJoZWlnaHRNZWFzdXJlTW9kZSIsIm1lYXN1cmUiLCJwcm9wcyIsInRleHRDaGlsZHJlbiIsInRleHREaXJ0eSIsIm51bWJlck9mTGluZXMiLCJmb3JFYWNoIiwic2hhZG93UHJvcE5hbWUiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImNvbmZpZ3VyYWJsZSIsImdldCIsInNldCIsInZhbHVlIiwiaW5jbHVkZXMiLCJtYXJrVGV4dERpcnR5IiwibWFya0RpcnR5IiwicmVhY3RTdXBlcnZpZXciLCJtYWtlRGlydHkiLCJ0ZXN0RG9tRWxlbWVudCIsInRlc3RET01FbGVtZW50IiwiZmlyc3RDaGlsZCIsInJlbW92ZUNoaWxkIiwiY2xlYXJUZXN0RG9tRWxlbWVudCIsIndoaXRlU3BhY2UiLCJtZWFzdXJlTW9kZSIsImV4YWN0bHkiLCJ1bmRlZmluZWQiLCJzdHlsZSIsIm1heFdpZHRoIiwibWF4SGVpZ2h0IiwiZ2V0VGVzdFRyZWUiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJtZWFzdXJlZFdpZHRoIiwibWVhc3VyZWRIZWlnaHQiLCJNYXRoIiwiY2VpbCIsIl90ZXN0VHJlZSIsInNwYW5XcmFwcGVyIiwiY2hpbGQiLCJ0ZXh0IiwibGVuZ3RoIiwidGV4dExpbmVzIiwic3BsaXQiLCJpIiwiY3VycmVudExpbmUiLCJpbnNlcnRBZGphY2VudFRleHQiLCJpbnNlcnRBZGphY2VudEVsZW1lbnQiLCJzdWJ2aWV3IiwiaW5kZXgiLCJzcGxpY2UiLCJmaWx0ZXIiLCJzIiwiX3Rlc3RET01FbGVtZW50IiwicGFyZW50Tm9kZSIsIl9udW1iZXJPZkxpbmVzIiwiZG9tRWxlbWVudCIsInBvc2l0aW9uIiwidmlzaWJpbGl0eSIsImRpc3BsYXkiXSwibWFwcGluZ3MiOiIrMEJBS0EsaUMsR0FBWUEsRyxtQ0FDWix3Qyx5Q0FDQSxrRCxtREFDQSwwREFPQSxrRCw0REFDQSxxRCwrWEFFQSxHQUFNQyx5QkFBMEIsQ0FDOUIsWUFEOEIsQ0FFOUIsVUFGOEIsQ0FHOUIsV0FIOEIsQ0FJOUIsWUFKOEIsQ0FLOUIsWUFMOEIsQ0FNOUIsZUFOOEIsQ0FBaEMsQ0FTQSxHQUFNQyxlQUFnQixDQUFDLFlBQUQsQ0FBdEIsQ0FFQSxHQUFNQywwQkFBMkJDLFNBQVNDLGFBQVQsQ0FBdUIsS0FBdkIsQ0FBakMsQ0FDQUYseUJBQXlCRyxFQUF6QixDQUE4QixrQkFBOUIsQ0FFQUYsU0FBU0csSUFBVCxFQUFpQkgsU0FBU0csSUFBVCxDQUFjQyxXQUFkLENBQTBCTCx3QkFBMUIsQ0FBakIsQ0FFQU0sT0FBT0MsT0FBUCxDQUFrQix5UEE3Qk5WLEVBNkJNLG9DQUNSVyxTQURRLE1BQ1JBLFNBRFEsb0ZBRVZDLGFBRlUscUdBR1ZDLGdCQUhVLGVBS1ZDLGFBTFUsaUZBc0JkLHdCQUFjLHFMQUlaLE1BQUtDLFFBQUwsQ0FBY0MsY0FBZCxDQUNFLFNBQUNDLEtBQUQsQ0FBUUMsZ0JBQVIsQ0FBMEJDLE1BQTFCLENBQWtDQyxpQkFBbEMsUUFDRSxPQUFLQyxPQUFMLENBQWFKLEtBQWIsQ0FBb0JDLGdCQUFwQixDQUFzQ0MsTUFBdEMsQ0FBOENDLGlCQUE5QyxDQURGLEVBREYsRUFLQSxNQUFLRSxLQUFMLENBQWEsRUFBYixDQUNBLE1BQUtDLFlBQUwsQ0FBb0IsRUFBcEIsQ0FDQSxNQUFLQyxTQUFMLENB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QUFqQiIsImZpbGUiOiJSQ1RTaGFkb3dUZXh0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcHJvdmlkZXNNb2R1bGUgUkNUU2hhZG93VGV4dFxuICogQGZsb3dcbiAqL1xuXG5pbXBvcnQgKiBhcyBZRyBmcm9tIFwieW9nYS1kb21cIjtcbmltcG9ydCBndWlkIGZyb20gXCJHdWlkXCI7XG5pbXBvcnQgaW52YXJpYW50IGZyb20gXCJJbnZhcmlhbnRcIjtcbmltcG9ydCB7XG4gIGRlZmF1bHRGb250U3RhY2ssXG4gIGRlZmF1bHRGb250U2l6ZSxcbiAgZGVmYXVsdHMgYXMgVGV4dERlZmF1bHRzXG59IGZyb20gXCJSQ1RTaGFyZWRUZXh0VmFsdWVzXCI7XG5cbmltcG9ydCBfWW9nYSBmcm9tIFwieW9nYS1kb21cIjtcbmltcG9ydCBfUkNUU2hhZG93VmlldyBmcm9tIFwiUkNUU2hhZG93Vmlld1wiO1xuaW1wb3J0IF9SQ1RTaGFkb3dSYXdUZXh0IGZyb20gXCJSQ1RTaGFkb3dSYXdUZXh0XCI7XG5cbmNvbnN0IFRFWFRfU0hBRE9XX1NUWUxFX1BST1BTID0gW1xuICBcImZvbnRGYW1pbHlcIixcbiAgXCJmb250U2l6ZVwiLFxuICBcImZvbnRTdHlsZVwiLFxuICBcImZvbnRXZWlnaHRcIixcbiAgXCJsaW5lSGVpZ2h0XCIsXG4gIFwibGV0dGVyU3BhY2luZ1wiXG5dO1xuXG5jb25zdCBURVhUX1BYX1BST1BTID0gW1wibGluZUhlaWdodFwiXTtcblxuY29uc3QgdGV4dE1lYXN1cmVtZW50Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbnRleHRNZWFzdXJlbWVudENvbnRhaW5lci5pZCA9IFwidGV4dC1tZWFzdXJlbWVudFwiO1xuLy8gT2JqZWN0LmFzc2lnbih0ZXh0TWVhc3VyZW1lbnRDb250YWluZXIsIHsgY29udGFpbjogXCJzdHJpY3RcIiB9KTtcbmRvY3VtZW50LmJvZHkgJiYgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXh0TWVhc3VyZW1lbnRDb250YWluZXIpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IChhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHsgQ29uc3RhbnRzIH0gPSBhd2FpdCBfWW9nYTtcbiAgY29uc3QgUkNUU2hhZG93VmlldyA9IGF3YWl0IF9SQ1RTaGFkb3dWaWV3O1xuICBjb25zdCBSQ1RTaGFkb3dSYXdUZXh0ID0gYXdhaXQgX1JDVFNoYWRvd1Jhd1RleHQ7XG5cbiAgY2xhc3MgUkNUU2hhZG93VGV4dCBleHRlbmRzIFJDVFNoYWRvd1ZpZXcge1xuICAgIHByZXZpb3VzV2lkdGg6IG51bWJlcjtcbiAgICBwcmV2aW91c0hlaWdodDogbnVtYmVyO1xuICAgIHRleHRDaGlsZHJlbjogQXJyYXk8UkNUU2hhZG93VGV4dCB8IFJDVFNoYWRvd1Jhd1RleHQ+O1xuICAgIHRleHREaXJ0eTogYm9vbGVhbjtcbiAgICBwcm9wczogeyBbc3RyaW5nXTogYW55IH07XG5cbiAgICBmb250RmFtaWx5OiA/c3RyaW5nO1xuICAgIGZvbnRTaXplOiA/c3RyaW5nO1xuICAgIGZvbnRTdHlsZTogP3N0cmluZztcbiAgICBmb250V2VpZ2h0OiA/c3RyaW5nO1xuICAgIGxpbmVIZWlnaHQ6ID9zdHJpbmc7XG5cbiAgICBfdGVzdFRyZWU6ID9IVE1MRWxlbWVudDtcbiAgICBfdGVzdERPTUVsZW1lbnQ6ID9IVE1MRWxlbWVudDtcbiAgICBfbnVtYmVyT2ZMaW5lczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICBzdXBlcigpO1xuXG4gICAgICAvLyBjdXN0b20gbWVhc3VyZSBmdW5jdGlvbiBmb3IgdGhlIGZsZXhib3ggbGF5b3V0XG4gICAgICB0aGlzLnlvZ2FOb2RlLnNldE1lYXN1cmVGdW5jKFxuICAgICAgICAod2lkdGgsIHdpZHRoTWVhc3VyZU1vZGUsIGhlaWdodCwgaGVpZ2h0TWVhc3VyZU1vZGUpID0+XG4gICAgICAgICAgdGhpcy5tZWFzdXJlKHdpZHRoLCB3aWR0aE1lYXN1cmVNb2RlLCBoZWlnaHQsIGhlaWdodE1lYXN1cmVNb2RlKVxuICAgICAgKTtcblxuICAgICAgdGhpcy5wcm9wcyA9IHt9O1xuICAgICAgdGhpcy50ZXh0Q2hpbGRyZW4gPSBbXTtcbiAgICAgIHRoaXMudGV4dERpcnR5ID0gdHJ1ZTtcbiAgICAgIHRoaXMubnVtYmVyT2ZMaW5lcyA9IDA7XG5cbiAgICAgIFRFWFRfU0hBRE9XX1NUWUxFX1BST1BTLmZvckVhY2goKHNoYWRvd1Byb3BOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHNoYWRvd1Byb3BOYW1lLCB7XG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgIGdldDogKCkgPT4gdGhpcy5wcm9wc1tzaGFkb3dQcm9wTmFtZV0sXG4gICAgICAgICAgc2V0OiAodmFsdWUpID0+IHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgIHRoaXMucHJvcHNbc2hhZG93UHJvcE5hbWVdID0gVEVYVF9QWF9QUk9QUy5pbmNsdWRlcyhcbiAgICAgICAgICAgICAgICBzaGFkb3dQcm9wTmFtZVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgPyBgJHt2YWx1ZX1weGBcbiAgICAgICAgICAgICAgICA6IHZhbHVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5wcm9wc1tzaGFkb3dQcm9wTmFtZV0gPSBUZXh0RGVmYXVsdHNbc2hhZG93UHJvcE5hbWVdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5tYXJrVGV4dERpcnR5KCk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyAkRmxvd0ZpeE1lXG4gICAgICAgIHRoaXNbc2hhZG93UHJvcE5hbWVdID0gbnVsbDtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldCBudW1iZXJPZkxpbmVzKCk6IG51bWJlciB7XG4gICAgICByZXR1cm4gdGhpcy5fbnVtYmVyT2ZMaW5lcztcbiAgICB9XG5cbiAgICBzZXQgbnVtYmVyT2ZMaW5lcyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICB0aGlzLl9udW1iZXJPZkxpbmVzID0gdmFsdWU7XG4gICAgICB0aGlzLm1hcmtUZXh0RGlydHkoKTtcbiAgICB9XG5cbiAgICBnZXQgdGVzdERPTUVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgICAgaWYgKHRoaXMuX3Rlc3RET01FbGVtZW50ID09IG51bGwpIHtcbiAgICAgICAgLy8gY3JlYXRlIGRvbSBub2RlIGZvciBtZWFzdXJpbmcgdGV4dFxuICAgICAgICBjb25zdCBkb21FbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgZG9tRWxlbWVudC5pZCA9IGd1aWQoKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihkb21FbGVtZW50LnN0eWxlLCB7XG4gICAgICAgICAgcG9zaXRpb246IFwiYWJzb2x1dGVcIixcbiAgICAgICAgICB2aXNpYmlsaXR5OiBcImhpZGRlblwiLFxuICAgICAgICAgIG1heEhlaWdodDogXCJhdXRvXCIsXG4gICAgICAgICAgbWF4V2lkdGg6IFwiYXV0b1wiLFxuICAgICAgICAgIHdoaXRlU3BhY2U6IFwibm93cmFwXCIsXG4gICAgICAgICAgZGlzcGxheTogXCJpbmxpbmUtYmxvY2tcIlxuICAgICAgICB9KTtcbiAgICAgICAgdGV4dE1lYXN1cmVtZW50Q29udGFpbmVyLmFwcGVuZENoaWxkKGRvbUVsZW1lbnQpO1xuICAgICAgICB0aGlzLl90ZXN0RE9NRWxlbWVudCA9IGRvbUVsZW1lbnQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5fdGVzdERPTUVsZW1lbnQ7XG4gICAgfVxuXG4gICAgbWFya1RleHREaXJ0eSgpIHtcbiAgICAgIHRoaXMueW9nYU5vZGUubWFya0RpcnR5KCk7XG4gICAgICB0aGlzLnRleHREaXJ0eSA9IHRydWU7XG4gICAgICBpZiAodGhpcy5yZWFjdFN1cGVydmlldyBpbnN0YW5jZW9mIFJDVFNoYWRvd1RleHQpIHtcbiAgICAgICAgdGhpcy5yZWFjdFN1cGVydmlldy5tYXJrVGV4dERpcnR5KCk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMucmVhY3RTdXBlcnZpZXcgaW5zdGFuY2VvZiBSQ1RTaGFkb3dWaWV3KSB7XG4gICAgICAgIHRoaXMucmVhY3RTdXBlcnZpZXcubWFrZURpcnR5KCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY2xlYXJUZXN0RG9tRWxlbWVudCgpIHtcbiAgICAgIGNvbnN0IHRlc3REb21FbGVtZW50ID0gdGhpcy50ZXN0RE9NRWxlbWVudDtcbiAgICAgIHdoaWxlICh0ZXN0RG9tRWxlbWVudC5maXJzdENoaWxkKSB7XG4gICAgICAgIHRlc3REb21FbGVtZW50LnJlbW92ZUNoaWxkKHRlc3REb21FbGVtZW50LmZpcnN0Q2hpbGQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1lYXN1cmUgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHRleHQgYXNzb2NpYXRlZFxuICAgICAqIGNhbGxiYWNrIGZvciBjc3MtbGF5b3V0XG4gICAgICogQHBhcmFtOiB3aWR0aCAtIGlucHV0IHdpZHRoIGV4dGVudHNcbiAgICAgKiBAcGFyYW06IHdpZHRoTWVhc3VyZU1vZGUgLSBtb2RlIHRvIGNvbnN0cmFpbiB3aWR0aCBDU1NfTUVBU1VSRV9NT0RFX0VYQUNUTFksIENTU19NRUFTVVJFX01PREVfVU5ERUZJTkVEXG4gICAgICogQHBhcmFtOiBoZWlnaHQgLSBpbnB1dCBoZWlnaHQgZXh0ZW50c1xuICAgICAqIEBwYXJhbTogaGVpZ2h0TWVhc3VyZU1vZGUgLSBtb2RlIHRvIGNvbnN0cmFpbiBoZWlnaHQgQ1NTX01FQVNVUkVfTU9ERV9FWEFDVExZLCBDU1NfTUVBU1VSRV9NT0RFX1VOREVGSU5FRFxuICAgICAqIEByZXR1cm46IG9iamVjdCBjb250YWluaW5nIG1lYXN1cmVkIHdpZHRoIGFuZCBoZWlnaHRcbiAgICAgKi9cbiAgICBtZWFzdXJlKFxuICAgICAgd2lkdGg6IG51bWJlcixcbiAgICAgIHdpZHRoTWVhc3VyZU1vZGU6ICosXG4gICAgICBoZWlnaHQ6IG51bWJlcixcbiAgICAgIGhlaWdodE1lYXN1cmVNb2RlOiAqXG4gICAgKTogeyB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciB9IHtcbiAgICAgIHRoaXMuY2xlYXJUZXN0RG9tRWxlbWVudCgpO1xuXG4gICAgICBjb25zdCB3aGl0ZVNwYWNlID0gdGhpcy5udW1iZXJPZkxpbmVzID09PSAxID8gXCJub3dyYXBcIiA6IFwicHJlLXdyYXBcIjtcblxuICAgICAgaWYgKFxuICAgICAgICB3aWR0aE1lYXN1cmVNb2RlICE9PSBDb25zdGFudHMubWVhc3VyZU1vZGUuZXhhY3RseSB8fFxuICAgICAgICBoZWlnaHRNZWFzdXJlTW9kZSAhPT0gQ29uc3RhbnRzLm1lYXN1cmVNb2RlLmV4YWN0bHlcbiAgICAgICkge1xuICAgICAgICBpZiAod2lkdGhNZWFzdXJlTW9kZSAhPT0gQ29uc3RhbnRzLm1lYXN1cmVNb2RlLnVuZGVmaW5lZCkge1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy50ZXN0RE9NRWxlbWVudC5zdHlsZSwge1xuICAgICAgICAgICAgbWF4V2lkdGg6IGAke3dpZHRofXB4YCxcbiAgICAgICAgICAgIG1heEhlaWdodDogXCJhdXRvXCIsXG4gICAgICAgICAgICB3aGl0ZVNwYWNlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnRlc3RET01FbGVtZW50LnN0eWxlLCB7XG4gICAgICAgICAgICBtYXhXaWR0aDogXCJhdXRvXCIsXG4gICAgICAgICAgICBtYXhIZWlnaHQ6IGAke2hlaWdodH1weGAsXG4gICAgICAgICAgICB3aGl0ZVNwYWNlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgd2lkdGg6IHdpZHRoIHx8IDAsXG4gICAgICAgICAgaGVpZ2h0OiBoZWlnaHQgfHwgMFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICB0aGlzLnRlc3RET01FbGVtZW50LmFwcGVuZENoaWxkKHRoaXMuZ2V0VGVzdFRyZWUoKSk7XG5cbiAgICAgIGNvbnN0IHtcbiAgICAgICAgd2lkdGg6IG1lYXN1cmVkV2lkdGgsXG4gICAgICAgIGhlaWdodDogbWVhc3VyZWRIZWlnaHRcbiAgICAgIH0gPSB0aGlzLnRlc3RET01FbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICB3aWR0aDogTWF0aC5jZWlsKG1lYXN1cmVkV2lkdGgpLFxuICAgICAgICBoZWlnaHQ6IE1hdGguY2VpbChtZWFzdXJlZEhlaWdodClcbiAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0VGVzdFRyZWUoKTogSFRNTEVsZW1lbnQge1xuICAgICAgaWYgKCF0aGlzLnRleHREaXJ0eSkge1xuICAgICAgICBpbnZhcmlhbnQoXG4gICAgICAgICAgdGhpcy5fdGVzdFRyZWUsXG4gICAgICAgICAgXCJTaGFkb3dUZXh0IGlzIG5vdCBtYXJrZWQgYXMgZGlydHkgYnV0IHRoZXJlIGlzIG5vIGNhY2hlZCB0ZXN0VHJlZVwiXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiB0aGlzLl90ZXN0VHJlZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3BhbldyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcbiAgICAgIE9iamVjdC5hc3NpZ24oc3BhbldyYXBwZXIuc3R5bGUsIHRoaXMucHJvcHMpO1xuXG4gICAgICB0aGlzLnRleHRDaGlsZHJlbi5mb3JFYWNoKChjaGlsZCkgPT4ge1xuICAgICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBSQ1RTaGFkb3dSYXdUZXh0ICYmIGNoaWxkLnRleHQubGVuZ3RoKSB7XG4gICAgICAgICAgLy8gU3BsaXQgdGV4dCBieSBuZXdsaW5lIGFuZCBpbnNlcnQgYnJlYWtzIG1hbnVhbGx5IGFzIGluc2VydEFkamFjZW50VGV4dCBkb2VzIG5vdCByZXNwZWN0IG5ld2xpbmVzXG4gICAgICAgICAgY29uc3QgdGV4dExpbmVzID0gY2hpbGQudGV4dC5zcGxpdCgvXFxyP1xcbi8pO1xuICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dExpbmVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50TGluZSA9IHRleHRMaW5lc1tpXTtcbiAgICAgICAgICAgIHNwYW5XcmFwcGVyLmluc2VydEFkamFjZW50VGV4dChcImJlZm9yZWVuZFwiLCBjdXJyZW50TGluZSk7XG5cbiAgICAgICAgICAgIGlmIChpIDwgdGV4dExpbmVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgc3BhbldyYXBwZXIuaW5zZXJ0QWRqYWNlbnRFbGVtZW50KFxuICAgICAgICAgICAgICAgIFwiYmVmb3JlZW5kXCIsXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJyXCIpXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGNoaWxkIGluc3RhbmNlb2YgUkNUU2hhZG93VGV4dCkge1xuICAgICAgICAgIHNwYW5XcmFwcGVyLmluc2VydEFkamFjZW50RWxlbWVudChcImJlZm9yZWVuZFwiLCBjaGlsZC5nZXRUZXN0VHJlZSgpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuX3Rlc3RUcmVlID0gc3BhbldyYXBwZXI7XG4gICAgICB0aGlzLnRleHREaXJ0eSA9IGZhbHNlO1xuXG4gICAgICByZXR1cm4gdGhpcy5fdGVzdFRyZWU7XG4gICAgfVxuXG4gICAgaW5zZXJ0UmVhY3RTdWJ2aWV3QXRJbmRleChcbiAgICAgIHN1YnZpZXc6IFJDVFNoYWRvd1RleHQgfCBSQ1RTaGFkb3dSYXdUZXh0LFxuICAgICAgaW5kZXg6IG51bWJlclxuICAgICkge1xuICAgICAgc3Vidmlldy5yZWFjdFN1cGVydmlldyA9IHRoaXM7XG4gICAgICB0aGlzLnRleHRDaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDAsIHN1YnZpZXcpO1xuICAgICAgdGhpcy5tYXJrVGV4dERpcnR5KCk7XG4gICAgfVxuXG4gICAgcmVtb3ZlUmVhY3RTdWJ2aWV3KHN1YnZpZXc6IFJDVFNoYWRvd1RleHQgfCBSQ1RTaGFkb3dSYXdUZXh0KSB7XG4gICAgICBzdWJ2aWV3LnJlYWN0U3VwZXJ2aWV3ID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy50ZXh0Q2hpbGRyZW4gPSB0aGlzLnRleHRDaGlsZHJlbi5maWx0ZXIoKHMpID0+IHMgIT09IHN1YnZpZXcpO1xuICAgICAgdGhpcy5tYXJrVGV4dERpcnR5KCk7XG4gICAgfVxuXG4gICAgcHVyZ2UoKSB7XG4gICAgICBzdXBlci5wdXJnZSgpO1xuICAgICAgaWYgKHRoaXMuX3Rlc3RET01FbGVtZW50KSB7XG4gICAgICAgIHRoaXMuX3Rlc3RET01FbGVtZW50LnBhcmVudE5vZGUgJiZcbiAgICAgICAgICB0aGlzLl90ZXN0RE9NRWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuX3Rlc3RET01FbGVtZW50KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gUkNUU2hhZG93VGV4dDtcbn0pKCk7XG4iXX0=